<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devices - NetStacks</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/style.css?v=4" rel="stylesheet">
    <link href="/static/css/assistant.css?v=2" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-1">
        <div class="container-fluid py-0">
            <a class="navbar-brand brand-logo" href="/">
                <span class="brand-icon">
                    <i class="fas fa-layer-group"></i>
                </span>
                <span class="brand-text">NetStacks</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <!-- Operations Menu -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-play-circle"></i> Operations
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/deploy"><i class="fas fa-rocket"></i> Deploy Config</a></li>
                            <li><a class="dropdown-item" href="/monitor"><i class="fas fa-chart-line"></i> Monitor Jobs</a></li>
                            <li><a class="dropdown-item" href="/mop"><i class="fas fa-list-check"></i> Procedures (MOP)</a></li>
                        </ul>
                    </li>
                    <!-- Configuration Menu -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cogs"></i> Configuration
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/devices"><i class="fas fa-server"></i> Devices & Snapshots</a></li>
                            <li><a class="dropdown-item" href="/templates"><i class="fas fa-file-code"></i> Templates</a></li>
                            <li><a class="dropdown-item" href="/service-stacks"><i class="fas fa-layer-group"></i> Service Stacks</a></li>
                        </ul>
                    </li>
                    <!-- AI Menu -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-brain"></i> AI
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/agents"><i class="fas fa-robot"></i> Agents</a></li>
                            <li><a class="dropdown-item" href="/agents/chat"><i class="fas fa-comments"></i> Agent Chat</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/alerts"><i class="fas fa-bell"></i> Alerts</a></li>
                            <li><a class="dropdown-item" href="/incidents"><i class="fas fa-exclamation-triangle"></i> Incidents</a></li>
                            <li><a class="dropdown-item" href="/approvals"><i class="fas fa-shield-alt"></i> Approvals</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/knowledge"><i class="fas fa-book-open"></i> Knowledge</a></li>
                            <li><a class="dropdown-item" href="/tools"><i class="fas fa-wrench"></i> Tools</a></li>
                        </ul>
                    </li>
                    <!-- Settings Menu -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin"><i class="fas fa-users-cog"></i> Users & Auth</a></li>
                            <li><a class="dropdown-item" href="/settings"><i class="fas fa-sliders-h"></i> System Settings</a></li>
                            <li><a class="dropdown-item" href="/settings/ai"><i class="fas fa-brain"></i> AI Settings</a></li>
                            <li><a class="dropdown-item" href="/platform"><i class="fas fa-heartbeat"></i> Platform Health</a></li>
                            <li><a class="dropdown-item" href="/step-types"><i class="fas fa-puzzle-piece"></i> MOP Step Types</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/docs" target="_blank"><i class="fas fa-book"></i> NetStacks API</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="nav-link text-light">
                            <i class="fas fa-user"></i> <span id="current-username">Loading...</span>
                        </span>
                    </li>
                    <li class="nav-item">
                        <span class="nav-link text-light" id="system-time-container" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Loading...">
                            <i class="fas fa-clock"></i>
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="handleLogout(event)">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Page Content -->
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-server"></i> Devices
        </h1>
        <p class="text-muted">Manage network devices and configuration snapshots</p>
    </div>
</div>

<div class="row">
    <!-- Left Panel: Controls -->
    <div class="col-md-4">
        <!-- Backup Actions Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-play-circle"></i> Backup Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary btn-lg" id="create-snapshot-btn">
                        <i class="fas fa-camera"></i> Create Network Snapshot
                    </button>
                    <button class="btn btn-outline-primary" id="run-single-backup-btn">
                        <i class="fas fa-server"></i> Backup Single Device
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Summary</h5>
            </div>
            <div class="card-body">
                <div id="backup-summary">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Maintenance Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-wrench"></i> Maintenance</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success btn-sm" id="add-manual-device-btn">
                        <i class="fas fa-plus-circle"></i> Add Manual Device
                    </button>
                    <button class="btn btn-outline-primary btn-sm" id="clear-cache-btn">
                        <i class="fas fa-sync-alt"></i> Reload Devices
                    </button>
                    <button class="btn btn-outline-warning btn-sm" id="fix-stale-btn">
                        <i class="fas fa-first-aid"></i> Fix Stuck Snapshots
                    </button>
                    <button class="btn btn-outline-danger btn-sm" id="cleanup-btn">
                        <i class="fas fa-broom"></i> Cleanup Old Backups
                    </button>
                </div>
                <small class="text-muted mt-2 d-block">
                    Add devices manually or reload from NetBox.
                </small>
            </div>
        </div>
    </div>

    <!-- Right Panel: Snapshots & Backups -->
    <div class="col-md-8">
        <!-- Active Snapshot Progress (shown when snapshot is running) -->
        <div class="card mb-3 border-primary" id="active-snapshot-card" style="display: none;">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span id="active-snapshot-title">Snapshot In Progress</span>
                    </h5>
                    <span class="badge bg-secondary fs-6" id="active-snapshot-pct">0%</span>
                </div>
            </div>
            <div class="card-body">
                <!-- Progress Bar -->
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar bg-success" id="progress-success-bar" role="progressbar" style="width: 0%">
                        <span id="progress-success-text">0</span>
                    </div>
                    <div class="progress-bar bg-danger" id="progress-failed-bar" role="progressbar" style="width: 0%">
                        <span id="progress-failed-text"></span>
                    </div>
                    <div class="progress-bar bg-secondary progress-bar-striped progress-bar-animated" id="progress-pending-bar" role="progressbar" style="width: 100%">
                        <span id="progress-pending-text">Pending...</span>
                    </div>
                </div>

                <!-- Stats -->
                <div class="row text-center">
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <h4 class="mb-0 text-primary" id="stat-total">0</h4>
                            <small class="text-muted">Total</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <h4 class="mb-0 text-success" id="stat-success">0</h4>
                            <small class="text-muted">Success</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <h4 class="mb-0 text-danger" id="stat-failed">0</h4>
                            <small class="text-muted">Failed</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-2">
                            <h4 class="mb-0 text-warning" id="stat-pending">0</h4>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                </div>

                <!-- Elapsed Time -->
                <div class="text-center mt-2">
                    <small class="text-muted">Elapsed: <span id="elapsed-time">0:00</span></small>
                </div>
            </div>
        </div>

        <!-- Snapshots Table -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-camera"></i> Network Snapshots</h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" id="compare-snapshots-btn" title="Compare Snapshots">
                        <i class="fas fa-code-compare"></i> Compare
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-snapshots-btn">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Snapshot</th>
                                <th style="width: 200px;">Progress</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="snapshots-tbody">
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading snapshots...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Devices Table -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> Device List <small id="filter-info" class="text-muted"></small></h5>
                <div class="d-flex gap-2">
                    <input type="text" id="device-search" class="form-control form-control-sm" placeholder="Search devices..." style="width: 200px;">
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-devices-btn">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Bulk Actions Bar -->
                <div id="bulk-actions-bar" class="alert alert-info m-2 d-flex justify-content-between align-items-center" style="display: none !important;">
                    <div>
                        <i class="fas fa-check-square"></i>
                        <strong id="selected-count">0</strong> devices selected
                    </div>
                    <div>
                        <button class="btn btn-sm btn-info me-1" id="bulk-test-btn" title="Test connectivity">
                            <i class="fas fa-plug"></i> Test
                        </button>
                        <button class="btn btn-sm btn-primary me-1" id="bulk-getconfig-btn" title="Get config">
                            <i class="fas fa-download"></i> Get Config
                        </button>
                        <button class="btn btn-sm btn-warning me-1" id="bulk-setconfig-btn" title="Set config">
                            <i class="fas fa-upload"></i> Set Config
                        </button>
                        <button class="btn btn-sm btn-success me-1" id="bulk-backup-btn" title="Backup selected">
                            <i class="fas fa-save"></i> Backup
                        </button>
                        <button class="btn btn-sm btn-danger me-1" id="bulk-delete-btn" title="Delete selected manual devices">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                        <button class="btn btn-sm btn-secondary" id="clear-selection-btn">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <div id="devices-loading" class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="devices-container" style="display: none;">
                    <div class="px-2 pt-2">
                        <button class="btn btn-sm btn-outline-secondary me-2" id="select-all-btn">
                            <i class="fas fa-check-double"></i> Select All
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="select-none-btn">
                            <i class="fas fa-times"></i> Select None
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="select-all-checkbox" class="form-check-input">
                                    </th>
                                    <th>Device Name</th>
                                    <th>Management IP</th>
                                    <th>Type</th>
                                    <th>Source</th>
                                    <th>Last Backup</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="devices-tbody">
                            </tbody>
                        </table>
                    </div>
                    <div class="p-2 border-top">
                        <p class="text-muted mb-0">
                            <strong id="device-count-display">0</strong> devices total
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Snapshot Modal -->
<div class="modal fade" id="viewSnapshotModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-camera"></i> <span id="modal-snapshot-title">Snapshot Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Snapshot Stats -->
                <div class="row mb-4">
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-3 h-100">
                            <h3 class="mb-0 text-primary" id="modal-total">0</h3>
                            <small class="text-muted">Total Devices</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-3 h-100">
                            <h3 class="mb-0 text-success" id="modal-success">0</h3>
                            <small class="text-muted">Successful</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-3 h-100">
                            <h3 class="mb-0 text-danger" id="modal-failed">0</h3>
                            <small class="text-muted">Failed</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-3 h-100">
                            <span class="badge fs-5" id="modal-status-badge">Unknown</span>
                            <small class="text-muted d-block mt-1">Status</small>
                        </div>
                    </div>
                </div>

                <!-- Snapshot Info -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <small class="text-muted">Created:</small>
                        <span id="modal-created"></span>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">Completed:</small>
                        <span id="modal-completed"></span>
                    </div>
                    <div class="col-md-4">
                        <small class="text-muted">Created By:</small>
                        <span id="modal-created-by"></span>
                    </div>
                </div>

                <!-- Search/Filter -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="modal-search" placeholder="Search devices...">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="modal-status-filter">
                            <option value="">All</option>
                            <option value="success">Success</option>
                            <option value="failed">Failed</option>
                        </select>
                    </div>
                </div>

                <!-- Backups Table -->
                <div class="table-responsive" style="max-height: 350px;">
                    <table class="table table-sm table-hover">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Device</th>
                                <th>IP</th>
                                <th>Time</th>
                                <th>Size</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="modal-backups-tbody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-warning" id="modal-recalculate-btn">
                    <i class="fas fa-calculator"></i> Recalculate Counts
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- View Config Modal -->
<div class="modal fade" id="viewConfigModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-code"></i> <span id="config-modal-title">Configuration</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-3"><strong>Device:</strong> <span id="config-device"></span></div>
                    <div class="col-md-3"><strong>Format:</strong> <span id="config-format"></span></div>
                    <div class="col-md-3"><strong>Size:</strong> <span id="config-size"></span></div>
                    <div class="col-md-3"><strong>Time:</strong> <span id="config-time"></span></div>
                </div>

                <!-- Tabs for Config and Diff views -->
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="config-tab" data-bs-toggle="tab" data-bs-target="#config-view" type="button" role="tab">
                            <i class="fas fa-file-alt"></i> Configuration
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="diff-tab" data-bs-toggle="tab" data-bs-target="#diff-view" type="button" role="tab">
                            <i class="fas fa-code-compare"></i> Compare
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Config View Tab -->
                    <div class="tab-pane fade show active" id="config-view" role="tabpanel">
                        <textarea class="form-control font-monospace" id="config-content" rows="20" readonly style="font-size: 12px;"></textarea>
                    </div>

                    <!-- Diff View Tab -->
                    <div class="tab-pane fade" id="diff-view" role="tabpanel">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <label class="form-label mb-0">Compare with:</label>
                                    <select class="form-select form-select-sm d-inline-block ms-2" id="diff-compare-backup" style="width: auto;">
                                        <option value="">Select backup to compare...</option>
                                    </select>
                                </div>
                                <div>
                                    <span class="badge bg-success me-2"><i class="fas fa-plus"></i> <span id="diff-added-count">0</span> added</span>
                                    <span class="badge bg-danger me-2"><i class="fas fa-minus"></i> <span id="diff-removed-count">0</span> removed</span>
                                    <span class="badge bg-secondary"><i class="fas fa-equals"></i> <span id="diff-unchanged-count">0</span> unchanged</span>
                                </div>
                            </div>
                            <div id="diff-loading" class="text-center py-4" style="display: none;">
                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                <span class="ms-2">Loading comparison...</span>
                            </div>
                            <div id="diff-no-previous" class="alert alert-info" style="display: none;">
                                <i class="fas fa-info-circle"></i> No other backups available for comparison.
                            </div>
                            <div id="diff-no-changes" class="alert alert-success" style="display: none;">
                                <i class="fas fa-check-circle"></i> No changes detected between the selected backups.
                            </div>
                            <div id="diff-content-container" class="border rounded" style="max-height: 500px; overflow-y: auto; display: none;">
                                <pre id="diff-content" class="m-0 p-2" style="white-space: pre-wrap; font-size: 0.85rem;"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="copy-config-btn">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button type="button" class="btn btn-outline-success" id="download-config-btn">
                    <i class="fas fa-download"></i> Download
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Single Backup Modal -->
<div class="modal fade" id="singleBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-server"></i> Backup Single Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Device</label>
                    <select class="form-select" id="single-device-select">
                        <option value="">Loading devices...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="start-single-backup-btn">
                    <i class="fas fa-play"></i> Start Backup
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Compare Snapshots Modal -->
<div class="modal fade" id="compareSnapshotsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-code-compare"></i> Compare Snapshots</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Snapshot Selection -->
                <div class="row mb-4">
                    <div class="col-md-5">
                        <label class="form-label"><strong>Base Snapshot (older):</strong></label>
                        <select class="form-select" id="compare-snapshot1">
                            <option value="">Select snapshot...</option>
                        </select>
                        <small class="text-muted" id="snapshot1-info"></small>
                    </div>
                    <div class="col-md-2 d-flex align-items-center justify-content-center">
                        <i class="fas fa-arrow-right fa-2x text-muted"></i>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label"><strong>Current Snapshot (newer):</strong></label>
                        <select class="form-select" id="compare-snapshot2">
                            <option value="">Select snapshot...</option>
                        </select>
                        <small class="text-muted" id="snapshot2-info"></small>
                    </div>
                </div>

                <!-- Compare Button -->
                <div class="text-center mb-4">
                    <button class="btn btn-primary" id="run-comparison-btn">
                        <i class="fas fa-balance-scale"></i> Compare Snapshots
                    </button>
                </div>

                <!-- Loading -->
                <div id="compare-loading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <div class="mt-2">Comparing snapshots...</div>
                </div>

                <!-- Results Summary -->
                <div id="compare-results" style="display: none;">
                    <div class="row mb-4 text-center">
                        <div class="col-md-3">
                            <div class="border rounded p-3 h-100">
                                <h3 class="mb-0 text-primary" id="compare-total">0</h3>
                                <small class="text-muted">Total Devices</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 h-100">
                                <h3 class="mb-0 text-warning" id="compare-changed">0</h3>
                                <small class="text-muted">Changed</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 h-100">
                                <h3 class="mb-0 text-success" id="compare-added">0</h3>
                                <small class="text-muted">Added</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="border rounded p-3 h-100">
                                <h3 class="mb-0 text-danger" id="compare-removed">0</h3>
                                <small class="text-muted">Removed</small>
                            </div>
                        </div>
                    </div>

                    <!-- Filter -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="compare-search" placeholder="Search devices...">
                        </div>
                        <div class="col-md-6">
                            <select class="form-select" id="compare-filter">
                                <option value="">All Devices</option>
                                <option value="changed">Changed Only</option>
                                <option value="added">Added Only</option>
                                <option value="removed">Removed Only</option>
                                <option value="unchanged">Unchanged Only</option>
                            </select>
                        </div>
                    </div>

                    <!-- No Changes Message -->
                    <div id="compare-no-changes" class="alert alert-success" style="display: none;">
                        <i class="fas fa-check-circle"></i> <strong>No configuration changes detected!</strong>
                        All device configurations are identical between the two snapshots.
                    </div>

                    <!-- Comparison Table -->
                    <div class="table-responsive" style="max-height: 400px;">
                        <table class="table table-sm table-hover">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>Device</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="compare-results-tbody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Details Modal -->
<div class="modal fade" id="errorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-exclamation-triangle"></i> <span id="error-modal-title">Backup Error</span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <strong>Device:</strong> <span id="error-device-name"></span>
                </div>
                <div class="mb-3">
                    <strong>Error Message:</strong>
                    <pre id="error-message-content" class="mt-2 p-3 bg-dark text-light border rounded" style="white-space: pre-wrap; max-height: 300px; overflow-y: auto;"></pre>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Cleanup Backups Modal -->
<div class="modal fade" id="cleanupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-broom"></i> Cleanup Backups</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">Select a cleanup option:</p>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="cleanupOption" id="cleanup-orphans" value="orphans" checked>
                    <label class="form-check-label" for="cleanup-orphans">
                        <strong>Delete orphaned backups</strong>
                        <br><small class="text-muted">Remove backups for devices not in current cache. Make sure you've loaded devices on the Devices page first.</small>
                    </label>
                </div>

                <div class="form-check mb-3">
                    <input class="form-check-input" type="radio" name="cleanupOption" id="cleanup-old" value="old">
                    <label class="form-check-label" for="cleanup-old">
                        <strong>Delete old backups</strong>
                        <br><small class="text-muted">Remove backups older than a specified number of days.</small>
                    </label>
                </div>

                <div id="retention-days-group" class="ms-4 mb-3" style="display: none;">
                    <label class="form-label">Delete backups older than:</label>
                    <div class="input-group" style="width: 200px;">
                        <input type="number" class="form-control" id="retention-days-input" value="30" min="1">
                        <span class="input-group-text">days</span>
                    </div>
                </div>

                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-cleanup-btn">
                    <i class="fas fa-trash-alt"></i> Delete Backups
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Manual Device Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus-circle"></i> Add Manual Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="add-device-form">
                    <div class="mb-3">
                        <label for="device-name" class="form-label">Device Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="device-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="device-type" class="form-label">Device Type <span class="text-danger">*</span></label>
                        <select class="form-control" id="device-type" required>
                            <option value="">Select type...</option>
                            <option value="cisco_ios">Cisco IOS</option>
                            <option value="cisco_nxos">Cisco NX-OS</option>
                            <option value="cisco_xe">Cisco IOS XE</option>
                            <option value="cisco_xr">Cisco IOS XR</option>
                            <option value="arista_eos">Arista EOS</option>
                            <option value="juniper_junos">Juniper Junos</option>
                            <option value="linux">Linux</option>
                            <option value="paloalto_panos">Palo Alto PAN-OS</option>
                            <option value="fortinet">Fortinet FortiOS</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-8">
                            <div class="mb-3">
                                <label for="device-host" class="form-label">Host/IP <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="device-host" required>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="mb-3">
                                <label for="device-port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="device-port" value="22">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="device-username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="device-username" placeholder="Optional - use defaults">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="device-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="device-password" placeholder="Optional - use defaults">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="save-device-btn">
                    <i class="fas fa-save"></i> Save Device
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Device Modal -->
<div class="modal fade" id="editDeviceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Device Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-device-form">
                    <input type="hidden" id="edit-device-name">

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Device:</strong> <span id="edit-device-display-name"></span>
                        <br><small class="text-muted">Override settings for this device. Leave fields blank to use defaults.</small>
                    </div>

                    <!-- Connection Settings -->
                    <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-plug"></i> Connection Settings</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-device-type" class="form-label">Device Type (Platform)</label>
                                <select class="form-control" id="edit-device-type">
                                    <option value="">Use default</option>
                                    <option value="cisco_ios">Cisco IOS</option>
                                    <option value="cisco_nxos">Cisco NX-OS</option>
                                    <option value="cisco_xe">Cisco IOS XE</option>
                                    <option value="cisco_xr">Cisco IOS XR</option>
                                    <option value="arista_eos">Arista EOS</option>
                                    <option value="juniper_junos">Juniper Junos</option>
                                    <option value="linux">Linux</option>
                                    <option value="paloalto_panos">Palo Alto PAN-OS</option>
                                    <option value="fortinet">Fortinet FortiOS</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-device-host" class="form-label">Host/IP Override</label>
                                <input type="text" class="form-control" id="edit-device-host" placeholder="Leave blank to use default">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-device-port" class="form-label">Port Override</label>
                                <input type="number" class="form-control" id="edit-device-port" placeholder="22">
                            </div>
                        </div>
                    </div>

                    <!-- Credentials -->
                    <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-key"></i> Credential Overrides</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-device-username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="edit-device-username" placeholder="Leave blank to use service creds">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-device-password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="edit-device-password" placeholder="Leave blank to use service creds">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="edit-device-secret" class="form-label">Enable Secret</label>
                                <input type="password" class="form-control" id="edit-device-secret" placeholder="Leave blank if not needed">
                            </div>
                        </div>
                    </div>

                    <!-- Timeouts -->
                    <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-clock"></i> Timeout Settings (seconds)</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="edit-device-timeout" class="form-label">Command Timeout</label>
                                <input type="number" class="form-control" id="edit-device-timeout" placeholder="Default">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="edit-device-conn-timeout" class="form-label">Connection Timeout</label>
                                <input type="number" class="form-control" id="edit-device-conn-timeout" placeholder="Default">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="edit-device-auth-timeout" class="form-label">Auth Timeout</label>
                                <input type="number" class="form-control" id="edit-device-auth-timeout" placeholder="Default">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="edit-device-banner-timeout" class="form-label">Banner Timeout</label>
                                <input type="number" class="form-control" id="edit-device-banner-timeout" placeholder="Default">
                            </div>
                        </div>
                    </div>

                    <!-- Additional Settings -->
                    <h6 class="border-bottom pb-2 mb-3"><i class="fas fa-cog"></i> Additional Settings</h6>
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="edit-device-notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="edit-device-notes" rows="2" placeholder="Optional notes about this device..."></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <div class="form-check form-switch mt-4">
                                    <input class="form-check-input" type="checkbox" id="edit-device-disabled">
                                    <label class="form-check-label" for="edit-device-disabled">Disable device</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger me-auto" id="delete-device-override-btn">
                    <i class="fas fa-trash"></i> Clear Overrides
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-device-override-btn">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Get Config Modal -->
<div class="modal fade" id="bulkGetConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-download"></i> Bulk Get Config</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-getconfig-form">
                    <div class="mb-3">
                        <label for="bulk-get-command" class="form-label">Command</label>
                        <input type="text" class="form-control" id="bulk-get-command" placeholder="show running-config" required>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label class="form-label mb-0">Credentials</label>
                            <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#bulk-get-credentials-section">
                                <i class="fas fa-chevron-down"></i> <span>Using defaults</span>
                            </button>
                        </div>
                        <div class="collapse" id="bulk-get-credentials-section">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="bulk-get-username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="bulk-get-username">
                                    <small class="form-text text-muted">Leave blank to use default from settings</small>
                                </div>
                                <div class="mb-3">
                                    <label for="bulk-get-password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="bulk-get-password">
                                    <small class="form-text text-muted">Leave blank to use default from settings</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="bulk-get-use-textfsm">
                        <label class="form-check-label" for="bulk-get-use-textfsm">Use TextFSM</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="execute-bulk-getconfig-btn">Execute</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Set Config Modal -->
<div class="modal fade" id="bulkSetConfigModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-upload"></i> Bulk Set Config</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="bulk-setconfig-form">
                    <div class="mb-3">
                        <label class="form-label">Configuration Source</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulk-set-config-source" id="bulk-set-manual" value="manual" checked>
                            <label class="form-check-label" for="bulk-set-manual">Manual Commands</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="bulk-set-config-source" id="bulk-set-template" value="template">
                            <label class="form-check-label" for="bulk-set-template">J2 Template</label>
                        </div>
                    </div>

                    <div id="bulk-set-manual-container">
                        <div class="mb-3">
                            <label for="bulk-set-config" class="form-label">Configuration Commands</label>
                            <textarea class="form-control font-monospace" id="bulk-set-config" rows="6"></textarea>
                        </div>
                    </div>

                    <div id="bulk-set-template-container" style="display: none;">
                        <div class="mb-3">
                            <label for="bulk-set-template-select" class="form-label">Select Template</label>
                            <select class="form-select" id="bulk-set-template-select">
                                <option value="">Loading templates...</option>
                            </select>
                        </div>
                        <div class="mb-3" id="bulk-set-template-vars-container" style="display: none;">
                            <label class="form-label">Template Variables (JSON)</label>
                            <textarea class="form-control font-monospace" id="bulk-set-template-vars" rows="6" placeholder='{"interface_name": "GigabitEthernet0/1"}'></textarea>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <label class="form-label mb-0">Credentials</label>
                            <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#bulk-set-credentials-section">
                                <i class="fas fa-chevron-down"></i> <span>Using defaults</span>
                            </button>
                        </div>
                        <div class="collapse" id="bulk-set-credentials-section">
                            <div class="card card-body mt-2">
                                <div class="mb-3">
                                    <label for="bulk-set-username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="bulk-set-username">
                                    <small class="form-text text-muted">Leave blank to use default from settings</small>
                                </div>
                                <div class="mb-3">
                                    <label for="bulk-set-password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="bulk-set-password">
                                    <small class="form-text text-muted">Leave blank to use default from settings</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="bulk-set-dry-run">
                        <label class="form-check-label" for="bulk-set-dry-run">Dry Run (test only)</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="execute-bulk-setconfig-btn">Execute</button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Status Modal -->
<div class="modal fade" id="bulkStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-tasks"></i> Bulk Operation Progress</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="progress" style="height: 25px;">
                        <div id="bulk-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;">0%</div>
                    </div>
                </div>
                <div class="row text-center">
                    <div class="col-4">
                        <h4 id="bulk-completed-count" class="text-primary">0</h4>
                        <small class="text-muted">Completed</small>
                    </div>
                    <div class="col-4">
                        <h4 id="bulk-success-count" class="text-success">0</h4>
                        <small class="text-muted">Successful</small>
                    </div>
                    <div class="col-4">
                        <h4 id="bulk-failed-count" class="text-danger">0</h4>
                        <small class="text-muted">Failed</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="/monitor" class="btn btn-primary">View Jobs</a>
            </div>
        </div>
    </div>
</div>

<!-- View Backup Modal (for device table) -->
<div class="modal fade" id="viewBackupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-file-code"></i> <span id="view-backup-device-name">Device</span> - Configuration Backup</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Created:</small>
                            <span id="view-backup-created" class="ms-2">-</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Format:</small>
                            <span id="view-backup-format" class="ms-2">-</span>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Size:</small>
                            <span id="view-backup-size" class="ms-2">-</span>
                        </div>
                    </div>
                </div>
                <div id="view-backup-loading" class="text-center py-4">
                    <div class="spinner-border" role="status"></div>
                    <p class="mt-2 text-muted">Loading backup...</p>
                </div>
                <div id="view-backup-content-container" style="display: none;">
                    <textarea id="view-backup-config" class="form-control font-monospace" rows="20" readonly style="font-size: 12px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="copy-backup-btn">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button type="button" class="btn btn-outline-primary" id="download-backup-btn">
                    <i class="fas fa-download"></i> Download
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- All Backups Modal -->
<div class="modal fade" id="allBackupsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-database"></i> All Configuration Backups</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-select form-select-sm" id="filter-backup-device">
                            <option value="">All Devices</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-sm btn-outline-secondary" id="refresh-backups-btn">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="col-md-4 text-end">
                        <span class="text-muted">Showing <span id="backup-count">0</span> backups</span>
                    </div>
                </div>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover table-sm">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th>Device</th>
                                <th>Created</th>
                                <th>Format</th>
                                <th>Size</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="all-backups-table-body">
                        </tbody>
                    </table>
                </div>
                <nav class="mt-2">
                    <ul class="pagination pagination-sm justify-content-center mb-0">
                        <li class="page-item" id="prev-page-item">
                            <a class="page-link" href="#" id="prev-page">Previous</a>
                        </li>
                        <li class="page-item" id="next-page-item">
                            <a class="page-link" href="#" id="next-page">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
        <!-- End Page Content -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/auth-guard.js"></script>
    <script src="/static/js/timezone-utils.js"></script>
    <script src="/static/js/task-manager.js"></script>
    <script>
        let systemTimezone = 'UTC';
        let timezoneLoaded = false;

        // Load system timezone asynchronously
        async function loadSystemTimezone() {
            try {
                const response = await $.ajax({
                    url: '/api/settings',
                    method: 'GET'
                });
                if (response.success && response.settings.system_timezone) {
                    systemTimezone = response.settings.system_timezone;
                    console.log('System timezone loaded:', systemTimezone);
                }
            } catch (error) {
                systemTimezone = 'UTC';
                console.log('Failed to load system timezone, using UTC');
            }
            timezoneLoaded = true;
        }

        // Update system time tooltip every second
        function updateSystemTime() {
            const now = new Date();
            let timeString;

            try {
                const options = {
                    timeZone: systemTimezone,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                };
                const formatter = new Intl.DateTimeFormat('en-CA', options);
                const parts = formatter.formatToParts(now);
                const dateMap = {};
                parts.forEach(part => {
                    dateMap[part.type] = part.value;
                });
                timeString = `${dateMap.year}-${dateMap.month}-${dateMap.day} ${dateMap.hour}:${dateMap.minute}:${dateMap.second}`;

                if (systemTimezone === 'UTC') {
                    timeString += ' UTC';
                } else {
                    timeString += ` (${systemTimezone})`;
                }
            } catch (e) {
                timeString = now.toISOString().slice(0, 19).replace('T', ' ') + ' UTC';
            }

            const $container = $('#system-time-container');
            $container.attr('data-bs-original-title', 'Server Time: ' + timeString);
            $container.attr('title', 'Server Time: ' + timeString);
        }

        // Handle logout - clear JWT tokens and redirect
        function handleLogout(event) {
            event.preventDefault();
            if (typeof NetStacksAPI !== 'undefined') {
                NetStacksAPI.clearTokens();
            } else {
                localStorage.removeItem('netstacks_jwt_token');
                localStorage.removeItem('netstacks_jwt_refresh');
                localStorage.removeItem('netstacks_jwt_expiry');
            }
            window.location.href = '/logout';
        }

        // Initialize on page load
        $(document).ready(async function() {
            await loadSystemTimezone();
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
            updateSystemTime();
            setInterval(updateSystemTime, 1000);
        });
    </script>
<script src="/static/js/form-utils.js"></script>
<script>
// State - Snapshots
let activeSnapshotId = null;
let pollInterval = null;
let snapshotStartTime = null;
let currentModalSnapshot = null;
let currentModalBackups = [];
let snapshotsList = [];  // Store loaded snapshots for comparison
let currentComparisonData = [];  // Store comparison results for filtering

// State - Devices
let allDevices = [];
let selectedDevices = [];
let deviceBackups = {};  // Map of device_name -> latest backup info
let deviceOverrides = {};  // Map of device_name -> override settings
let runningTasks = [];
let taskPollInterval = null;

// State - All Backups Modal
let backupsPage = 0;
const backupsPageSize = 50;

// Initialize
$(document).ready(function() {
    // Load data
    loadSnapshots();
    loadSummary();
    loadDevicesTable();
    loadDeviceBackupStatus();
    loadDeviceOverrides();

    // Check for active snapshots
    checkActiveSnapshots();

    // Check for URL parameters (e.g., ?backup=123)
    checkUrlParams();

    // Snapshot event handlers
    $('#create-snapshot-btn').click(createSnapshot);
    $('#run-single-backup-btn').click(showSingleBackupModal);
    $('#start-single-backup-btn').click(startSingleBackup);
    $('#refresh-snapshots-btn').click(loadSnapshots);
    $('#fix-stale-btn').click(fixStaleSnapshots);
    $('#cleanup-btn').click(showCleanupModal);
    $('#confirm-cleanup-btn').click(executeCleanup);
    $('#modal-search').on('input', filterModalBackups);
    $('#modal-status-filter').change(filterModalBackups);
    $('#modal-recalculate-btn').click(recalculateSnapshot);
    $('#copy-config-btn').click(copyConfig);
    $('#download-config-btn').click(downloadConfig);

    // Compare snapshots handlers
    $('#compare-snapshots-btn').click(showCompareSnapshotsModal);
    $('#run-comparison-btn').click(runSnapshotComparison);
    $('#compare-search').on('input', filterComparisonResults);
    $('#compare-filter').change(filterComparisonResults);

    // Toggle retention days input when "old backups" option selected
    $('input[name="cleanupOption"]').change(function() {
        if ($('#cleanup-old').is(':checked')) {
            $('#retention-days-group').slideDown();
        } else {
            $('#retention-days-group').slideUp();
        }
    });

    // Device event handlers
    $('#add-manual-device-btn').click(showAddDeviceModal);
    $('#save-device-btn').click(saveNewDevice);
    $('#clear-cache-btn').click(clearCacheAndReload);
    $('#refresh-devices-btn').click(loadDevicesTable);
    $('#device-search').on('input', filterDevicesTable);

    // Device selection handlers
    $('#select-all-checkbox').change(function() {
        const isChecked = $(this).is(':checked');
        $('.device-checkbox').prop('checked', isChecked);
        updateSelectedDevices();
    });
    $('#select-all-btn').click(function() {
        $('.device-checkbox').prop('checked', true);
        $('#select-all-checkbox').prop('checked', true);
        updateSelectedDevices();
    });
    $('#select-none-btn').click(function() {
        $('.device-checkbox').prop('checked', false);
        $('#select-all-checkbox').prop('checked', false);
        updateSelectedDevices();
    });
    $('#clear-selection-btn').click(function() {
        $('.device-checkbox').prop('checked', false);
        $('#select-all-checkbox').prop('checked', false);
        updateSelectedDevices();
    });

    // Bulk action handlers
    $('#bulk-test-btn').click(executeBulkTestConnectivity);
    $('#bulk-getconfig-btn').click(showBulkGetConfigModal);
    $('#bulk-setconfig-btn').click(showBulkSetConfigModal);
    $('#bulk-backup-btn').click(executeBulkBackup);
    $('#bulk-delete-btn').click(executeBulkDelete);

    // Bulk config execution
    $('#execute-bulk-getconfig-btn').click(executeBulkGetConfig);
    $('#execute-bulk-setconfig-btn').click(executeBulkSetConfig);

    // Template source toggle
    $('input[name="bulk-set-config-source"]').change(function() {
        if ($(this).val() === 'manual') {
            $('#bulk-set-manual-container').show();
            $('#bulk-set-template-container').hide();
        } else {
            $('#bulk-set-manual-container').hide();
            $('#bulk-set-template-container').show();
            loadBulkTemplates();
        }
    });
    $('#bulk-set-template-select').change(function() {
        if ($(this).val()) {
            $('#bulk-set-template-vars-container').show();
        } else {
            $('#bulk-set-template-vars-container').hide();
        }
    });

    // Device edit handlers
    $('#save-device-override-btn').click(saveDeviceOverride);
    $('#delete-device-override-btn').click(deleteDeviceOverride);

    // Backup modal handlers
    $('#copy-backup-btn').click(copyBackupConfig);
    $('#download-backup-btn').click(downloadBackupConfig);

    // View All Backups handlers
    $('#view-all-backups-btn').click(function() {
        loadAllBackups();
        const modal = new bootstrap.Modal(document.getElementById('allBackupsModal'));
        modal.show();
    });
    $('#refresh-backups-btn').click(function() {
        loadAllBackups($('#filter-backup-device').val());
    });
    $('#filter-backup-device').change(function() {
        backupsPage = 0;
        loadAllBackups($(this).val());
    });
    $('#prev-page').click(function(e) {
        e.preventDefault();
        if (backupsPage > 0) {
            backupsPage--;
            loadAllBackups($('#filter-backup-device').val());
        }
    });
    $('#next-page').click(function(e) {
        e.preventDefault();
        backupsPage++;
        loadAllBackups($('#filter-backup-device').val());
    });
});

// Load summary stats
function loadSummary() {
    console.log('Loading summary...');
    $.get('/api/config-backups?limit=1')
        .done(function(response) {
            console.log('Summary response:', response);
            // Handle both response formats: response.data.summary or response.summary
            const data = response.data || response;
            if (response.success && data.summary) {
                const s = data.summary;
                $('#backup-summary').html(`
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <h3 class="mb-0 text-primary">${s.total_backups || 0}</h3>
                            <small class="text-muted">Total Backups</small>
                        </div>
                        <div class="col-6">
                            <h3 class="mb-0 text-success">${s.unique_devices || 0}</h3>
                            <small class="text-muted">Devices</small>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="fas fa-clock"></i> Latest: ${s.latest_backup ? formatDate(s.latest_backup) : 'Never'}
                    </small>
                `);

                // Populate device filter
                if (s.devices_with_backups && s.devices_with_backups.length > 0) {
                    const $filter = $('#device-filter');
                    $filter.find('option:not(:first)').remove();
                    s.devices_with_backups.forEach(d => {
                        $filter.append(`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`);
                    });
                }
            } else {
                console.log('No summary data in response');
                $('#backup-summary').html(`
                    <div class="text-center text-muted">
                        <p class="mb-0">No backups yet</p>
                    </div>
                `);
            }
        })
        .fail(function(xhr, status, error) {
            console.error('Failed to load summary:', status, error);
            $('#backup-summary').html(`
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Error loading summary
                </div>
            `);
        });
}

// Load snapshots
function loadSnapshots() {
    $.get('/api/config-snapshots?limit=20')
        .done(function(response) {
            if (response.success && response.snapshots) {
                snapshotsList = response.snapshots;  // Store for comparison modal
                renderSnapshots(response.snapshots);
            } else {
                snapshotsList = [];
                $('#snapshots-tbody').html('<tr><td colspan="5" class="text-center text-muted">No snapshots found</td></tr>');
            }
        })
        .fail(function() {
            $('#snapshots-tbody').html('<tr><td colspan="5" class="text-center text-danger">Error loading snapshots</td></tr>');
        });
}

// Render snapshots table
function renderSnapshots(snapshots) {
    const $tbody = $('#snapshots-tbody');
    $tbody.empty();

    if (!snapshots || snapshots.length === 0) {
        $tbody.html('<tr><td colspan="5" class="text-center text-muted py-4">No snapshots yet. Click "Create Network Snapshot" to create one.</td></tr>');
        return;
    }

    snapshots.forEach(function(s) {
        const total = s.total_devices || 0;
        const success = s.success_count || 0;
        const failed = s.failed_count || 0;
        const completed = success + failed;
        const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

        // Status badge
        let statusBadge = '';
        switch(s.status) {
            case 'complete':
                statusBadge = '<span class="badge bg-success">Complete</span>';
                break;
            case 'partial':
                statusBadge = '<span class="badge bg-warning text-dark">Partial</span>';
                break;
            case 'failed':
                statusBadge = '<span class="badge bg-danger">Failed</span>';
                break;
            case 'in_progress':
                statusBadge = '<span class="badge bg-info"><i class="fas fa-spinner fa-spin"></i> In Progress</span>';
                break;
            default:
                statusBadge = `<span class="badge bg-secondary">${s.status}</span>`;
        }

        // Progress bar
        const successPct = total > 0 ? (success / total * 100) : 0;
        const failedPct = total > 0 ? (failed / total * 100) : 0;
        const pendingPct = 100 - successPct - failedPct;

        const progressBar = `
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" style="width: ${successPct}%" title="${success} success">${success > 0 ? success : ''}</div>
                <div class="progress-bar bg-danger" style="width: ${failedPct}%" title="${failed} failed">${failed > 0 ? failed : ''}</div>
                ${s.status === 'in_progress' ? `<div class="progress-bar bg-secondary progress-bar-striped progress-bar-animated" style="width: ${pendingPct}%"></div>` : ''}
            </div>
            <small class="text-muted">${completed} / ${total}</small>
        `;

        $tbody.append(`
            <tr>
                <td>
                    <strong>${escapeHtml(s.name || 'Unnamed')}</strong>
                    ${s.created_by ? `<br><small class="text-muted">by ${escapeHtml(s.created_by)}</small>` : ''}
                </td>
                <td>${progressBar}</td>
                <td>${statusBadge}</td>
                <td><small>${formatDate(s.created_at)}</small></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewSnapshot('${s.snapshot_id}')" title="View">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSnapshot('${s.snapshot_id}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
}

// Load backups
function loadBackups() {
    const device = $('#device-filter').val();
    let url = '/api/config-backups?limit=100';
    if (device) url += `&device=${encodeURIComponent(device)}`;

    $.get(url)
        .done(function(response) {
            // Handle both response formats: response.data.backups or response.backups
            const data = response.data || response;
            if (response.success && data.backups) {
                renderBackups(data.backups);
            }
        });
}

// Render backups table
function renderBackups(backups) {
    const $tbody = $('#backups-tbody');
    $tbody.empty();

    if (!backups || backups.length === 0) {
        $tbody.html('<tr><td colspan="5" class="text-center text-muted py-4">No backups found</td></tr>');
        return;
    }

    backups.forEach(function(b) {
        const statusBadge = b.status === 'success'
            ? '<span class="badge bg-success">OK</span>'
            : '<span class="badge bg-danger">Failed</span>';

        $tbody.append(`
            <tr>
                <td>
                    <i class="fas fa-server text-muted"></i> ${escapeHtml(b.device_name)}
                    ${b.device_ip ? `<br><small class="text-muted">${escapeHtml(b.device_ip)}</small>` : ''}
                </td>
                <td><small>${formatDate(b.created_at)}</small></td>
                <td><small>${formatSize(b.file_size)}</small></td>
                <td>${statusBadge}</td>
                <td>
                    ${b.status === 'success' ? `
                        <button class="btn btn-sm btn-outline-primary" onclick="viewConfig('${b.backup_id}')" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `);
    });
}

// Load devices for single backup
function loadDevices() {
    $.get('/api/devices/cached')
        .done(function(response) {
            if (response.success && response.devices) {
                cachedDevices = response.devices;
                const $select = $('#single-device-select');
                $select.empty();
                $select.append('<option value="">-- Select Device --</option>');
                response.devices.forEach(d => {
                    $select.append(`<option value="${escapeHtml(d.name)}">${escapeHtml(d.name)}</option>`);
                });
            }
        });
}

// Check for active snapshots on page load
function checkActiveSnapshots() {
    $.get('/api/config-snapshots?limit=5')
        .done(function(response) {
            if (response.success && response.snapshots) {
                const active = response.snapshots.find(s => s.status === 'in_progress');
                if (active) {
                    activeSnapshotId = active.snapshot_id;
                    snapshotStartTime = new Date(active.created_at);
                    showActiveSnapshot(active);
                    startPolling();
                }
            }
        });
}

// Create snapshot
function createSnapshot() {
    console.log('createSnapshot() called');
    if (!confirm('Create a network snapshot of all devices?')) {
        console.log('User cancelled snapshot creation');
        return;
    }
    console.log('User confirmed, starting snapshot...');

    const $btn = $('#create-snapshot-btn');
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting...');

    $.ajax({
        url: '/api/config-backups/run-all',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({})
    })
    .done(function(response) {
        console.log('Snapshot response:', response);
        if (response.success) {
            activeSnapshotId = response.snapshot_id;
            snapshotStartTime = new Date();

            // Calculate totals - submitted and failed are counts
            const totalDevices = (response.submitted || 0) + (response.errors ? response.errors.length : 0);
            const failedCount = response.errors ? response.errors.length : 0;

            console.log('Starting snapshot polling, total devices:', totalDevices);

            showActiveSnapshot({
                name: `Snapshot ${new Date().toLocaleString()}`,
                total_devices: totalDevices,
                success_count: 0,
                failed_count: failedCount,
                status: 'in_progress'
            });

            startPolling();
            loadSnapshots();
            loadSummary();
        } else {
            alert('Error: ' + response.error);
        }
    })
    .fail(function(xhr, textStatus) {
        if (textStatus !== 'abort' && xhr.status !== 0) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to create snapshot'));
        }
    })
    .always(function() {
        $btn.prop('disabled', false).html('<i class="fas fa-camera"></i> Create Network Snapshot');
    });
}

// Show active snapshot progress
function showActiveSnapshot(snapshot) {
    console.log('Showing active snapshot panel:', snapshot);
    const $card = $('#active-snapshot-card');
    // Remove Bootstrap classes and use jQuery show for compatibility with fadeOut
    $card.removeClass('d-none d-block');
    $card.show();
    $('#active-snapshot-title').html('<i class="fas fa-spinner fa-spin"></i> ' + (snapshot.name || 'Snapshot In Progress'));
    updateProgress(snapshot);
}

// Update progress display
function updateProgress(snapshot) {
    const total = snapshot.total_devices || 0;
    const success = snapshot.success_count || 0;
    const failed = snapshot.failed_count || 0;
    const completed = success + failed;
    const pending = total - completed;
    const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

    // Update stats
    $('#stat-total').text(total);
    $('#stat-success').text(success);
    $('#stat-failed').text(failed);
    $('#stat-pending').text(pending);
    $('#active-snapshot-pct').text(pct + '%');

    // Update progress bar
    const successPct = total > 0 ? (success / total * 100) : 0;
    const failedPct = total > 0 ? (failed / total * 100) : 0;
    const pendingPct = total > 0 ? (pending / total * 100) : 0;

    $('#progress-success-bar').css('width', successPct + '%');
    $('#progress-success-text').text(success > 0 ? success : '');

    $('#progress-failed-bar').css('width', failedPct + '%');
    $('#progress-failed-text').text(failed > 0 ? failed : '');

    $('#progress-pending-bar').css('width', pendingPct + '%');
    $('#progress-pending-text').text(pending > 0 ? pending + ' pending' : '');

    // Update elapsed time
    if (snapshotStartTime) {
        const elapsed = Math.floor((new Date() - snapshotStartTime) / 1000);
        const mins = Math.floor(elapsed / 60);
        const secs = elapsed % 60;
        $('#elapsed-time').text(`${mins}:${secs.toString().padStart(2, '0')}`);
    }
}

// Start polling for snapshot progress
function startPolling() {
    if (pollInterval) clearInterval(pollInterval);

    console.log('Starting polling for snapshot:', activeSnapshotId);

    pollInterval = setInterval(function() {
        if (!activeSnapshotId) {
            clearInterval(pollInterval);
            return;
        }

        $.get(`/api/config-snapshots/${activeSnapshotId}`)
            .done(function(response) {
                console.log('Polling response:', response);
                if (response.success && response.snapshot) {
                    const s = response.snapshot;
                    updateProgress(s);
                    loadSnapshots(); // Refresh table too

                    // Check if done
                    if (s.status !== 'in_progress') {
                        console.log('Snapshot completed with status:', s.status);
                        clearInterval(pollInterval);
                        pollInterval = null;

                        // Update progress bar to show completion
                        $('#active-snapshot-title').html('<i class="fas fa-check-circle"></i> Snapshot Complete');

                        // Hide after delay with fallback
                        console.log('Scheduling card hide in 3 seconds...');
                        setTimeout(function() {
                            console.log('Hiding active snapshot card now');
                            const $card = $('#active-snapshot-card');
                            // Use fadeOut with callback to ensure it completes
                            $card.fadeOut(400, function() {
                                console.log('fadeOut complete');
                                // Also explicitly hide in case fadeOut didn't work
                                $(this).css('display', 'none').removeClass('d-block');
                            });
                            activeSnapshotId = null;
                            snapshotStartTime = null;
                            loadBackups();
                            loadSummary();
                        }, 3000);
                    }
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Polling error:', status, error);
            });
    }, 2000);
}

// View snapshot details
function viewSnapshot(snapshotId) {
    currentModalSnapshot = snapshotId;
    $('#modal-backups-tbody').html('<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>');
    $('#viewSnapshotModal').modal('show');

    $.get(`/api/config-snapshots/${snapshotId}`)
        .done(function(response) {
            if (response.success && response.snapshot) {
                const s = response.snapshot;

                // Update header
                $('#modal-snapshot-title').text(s.name || 'Snapshot Details');
                $('#modal-total').text(s.total_devices || 0);
                $('#modal-success').text(s.success_count || 0);
                $('#modal-failed').text(s.failed_count || 0);

                // Status badge
                let badgeClass = 'bg-secondary';
                if (s.status === 'complete') badgeClass = 'bg-success';
                else if (s.status === 'partial') badgeClass = 'bg-warning text-dark';
                else if (s.status === 'failed') badgeClass = 'bg-danger';
                else if (s.status === 'in_progress') badgeClass = 'bg-info';
                $('#modal-status-badge').removeClass().addClass(`badge fs-5 ${badgeClass}`).text(s.status);

                // Info
                $('#modal-created').text(formatDate(s.created_at));
                $('#modal-completed').text(s.completed_at ? formatDate(s.completed_at) : 'In Progress');
                $('#modal-created-by').text(s.created_by || 'system');

                // Store backups for filtering
                currentModalBackups = s.backups || [];
                renderModalBackups(currentModalBackups);
            }
        });
}

// Store backup errors for lookup
let backupErrors = {};

// Render modal backups
function renderModalBackups(backups) {
    const $tbody = $('#modal-backups-tbody');
    $tbody.empty();
    backupErrors = {};  // Reset error storage

    if (!backups || backups.length === 0) {
        $tbody.html('<tr><td colspan="6" class="text-center text-muted">No backups in this snapshot</td></tr>');
        return;
    }

    backups.forEach(function(b) {
        let statusBadge;
        let actionButtons = '';

        if (b.status === 'success') {
            statusBadge = '<span class="badge bg-success">OK</span>';
            actionButtons = `
                <button class="btn btn-sm btn-outline-primary view-config-btn" data-backup-id="${b.backup_id}" title="View Config">
                    <i class="fas fa-eye"></i>
                </button>
            `;
        } else {
            statusBadge = '<span class="badge bg-danger">Failed</span>';
            // Store error message for later lookup
            backupErrors[b.backup_id] = {
                device_name: b.device_name,
                error_message: b.error_message || 'No error details available'
            };
            actionButtons = `
                <button class="btn btn-sm btn-outline-danger view-error-btn" data-backup-id="${b.backup_id}" title="View Error">
                    <i class="fas fa-exclamation-circle"></i>
                </button>
            `;
        }

        $tbody.append(`
            <tr>
                <td>${escapeHtml(b.device_name)}</td>
                <td><small>${escapeHtml(b.device_ip || '-')}</small></td>
                <td><small>${formatDate(b.created_at)}</small></td>
                <td><small>${formatSize(b.file_size)}</small></td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
            </tr>
        `);
    });

    // Bind click handlers using event delegation
    $tbody.off('click', '.view-config-btn').on('click', '.view-config-btn', function() {
        const backupId = $(this).data('backup-id');
        viewConfig(backupId);
    });

    $tbody.off('click', '.view-error-btn').on('click', '.view-error-btn', function() {
        const backupId = $(this).data('backup-id');
        const errorInfo = backupErrors[backupId];
        if (errorInfo) {
            viewError(errorInfo.device_name, errorInfo.error_message);
        }
    });
}

// Filter modal backups
function filterModalBackups() {
    const search = $('#modal-search').val().toLowerCase();
    const status = $('#modal-status-filter').val();

    let filtered = currentModalBackups;

    if (search) {
        filtered = filtered.filter(b =>
            (b.device_name || '').toLowerCase().includes(search) ||
            (b.device_ip || '').toLowerCase().includes(search)
        );
    }

    if (status) {
        filtered = filtered.filter(b => b.status === status);
    }

    renderModalBackups(filtered);
}

// Recalculate snapshot counts
function recalculateSnapshot() {
    if (!currentModalSnapshot) return;
    if (!confirm('Recalculate snapshot counts from actual backups?')) return;

    $.ajax({
        url: `/api/config-snapshots/${currentModalSnapshot}/recalculate`,
        method: 'POST'
    })
    .done(function(response) {
        if (response.success) {
            alert('Counts recalculated successfully');
            viewSnapshot(currentModalSnapshot);
            loadSnapshots();
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// Delete snapshot
function deleteSnapshot(snapshotId) {
    if (!confirm('Delete this snapshot and all its backups?')) return;

    $.ajax({
        url: `/api/config-snapshots/${snapshotId}`,
        method: 'DELETE'
    })
    .done(function(response) {
        if (response.success) {
            loadSnapshots();
            loadBackups();
            loadSummary();
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// View error details for failed backup
function viewError(deviceName, errorMessage) {
    $('#error-device-name').text(deviceName);
    $('#error-message-content').text(errorMessage);
    $('#errorModal').modal('show');
}

// View config
function viewConfig(backupId) {
    $.get(`/api/config-backups/${backupId}`)
        .done(function(response) {
            // Handle both response formats: response.data.backup or response.backup
            const data = response.data || response;
            if (response.success && data.backup) {
                const b = data.backup;
                $('#config-modal-title').text(`Configuration: ${b.device_name}`);
                $('#config-device').text(b.device_name);
                $('#config-format').text(b.config_format || 'native');
                $('#config-size').text(formatSize(b.file_size));
                $('#config-time').text(formatDate(b.created_at));
                $('#config-content').val(b.config_content || '');
                $('#viewConfigModal').data('backup', b);

                // Reset to config tab
                $('#config-tab').tab('show');

                // Reset diff view
                resetDiffView();

                // Load other backups for comparison
                loadBackupsForComparison(b.device_name, b.backup_id);

                $('#viewConfigModal').modal('show');
            }
        });
}

// Reset diff view to initial state
function resetDiffView() {
    $('#diff-compare-backup').html('<option value="">Select backup to compare...</option>');
    $('#diff-loading').hide();
    $('#diff-no-previous').hide();
    $('#diff-no-changes').hide();
    $('#diff-content-container').hide();
    $('#diff-content').html('');
    $('#diff-added-count').text('0');
    $('#diff-removed-count').text('0');
    $('#diff-unchanged-count').text('0');
}

// Load other backups for comparison dropdown
function loadBackupsForComparison(deviceName, currentBackupId) {
    $.get(`/api/config-backups?device=${encodeURIComponent(deviceName)}&limit=20`)
        .done(function(response) {
            // Handle both response formats: response.data.backups or response.backups
            const data = response.data || response;
            if (response.success && data.backups) {
                const $select = $('#diff-compare-backup');
                $select.html('<option value="">Select backup to compare...</option>');

                // Filter out current backup and add others
                const otherBackups = data.backups.filter(b => b.backup_id !== currentBackupId);

                if (otherBackups.length === 0) {
                    $select.append('<option value="" disabled>No other backups available</option>');
                    return;
                }

                otherBackups.forEach(backup => {
                    const date = formatDate(backup.created_at);
                    const formatLabel = backup.config_format === 'set' ? ' (set)' : '';
                    $select.append(`<option value="${backup.backup_id}">${date}${formatLabel}</option>`);
                });
            }
        });
}

// When diff tab is shown, load the diff
$('#diff-tab').on('shown.bs.tab', function() {
    const compareBackupId = $('#diff-compare-backup').val();
    if (compareBackupId) {
        loadDiff(compareBackupId);
    } else {
        // Try to auto-select first available backup
        const $select = $('#diff-compare-backup');
        const firstOption = $select.find('option[value!=""]:not(:disabled)').first().val();
        if (firstOption) {
            $select.val(firstOption);
            loadDiff(firstOption);
        } else {
            $('#diff-no-previous').show();
        }
    }
});

// When comparison backup changes
$('#diff-compare-backup').change(function() {
    const compareBackupId = $(this).val();
    if (compareBackupId) {
        loadDiff(compareBackupId);
    }
});

// Load and display diff between current and selected backup
function loadDiff(compareBackupId) {
    const currentBackup = $('#viewConfigModal').data('backup');
    if (!currentBackup) return;

    // Show loading
    $('#diff-loading').show();
    $('#diff-no-previous').hide();
    $('#diff-no-changes').hide();
    $('#diff-content-container').hide();

    // Fetch the comparison backup
    $.get(`/api/config-backups/${compareBackupId}`)
        .done(function(response) {
            $('#diff-loading').hide();

            // Handle both response formats: response.data.backup or response.backup
            const data = response.data || response;
            if (response.success && data.backup) {
                const compareBackup = data.backup;
                const currentContent = currentBackup.config_content || '';
                const compareContent = compareBackup.config_content || '';

                // Compute and display diff
                displayDiff(currentContent, compareContent);
            } else {
                $('#diff-no-previous').show();
            }
        })
        .fail(function() {
            $('#diff-loading').hide();
            $('#diff-no-previous').show();
        });
}

// Compute and display the diff between two configs
function displayDiff(currentContent, previousContent) {
    const currentLines = currentContent.split('\n');
    const previousLines = previousContent.split('\n');

    // Compute line diff
    const diff = computeLineDiff(previousLines, currentLines);

    if (diff.added === 0 && diff.removed === 0) {
        $('#diff-no-changes').show();
        $('#diff-content-container').hide();
        $('#diff-added-count').text('0');
        $('#diff-removed-count').text('0');
        $('#diff-unchanged-count').text(currentLines.length);
        return;
    }

    // Update counts
    $('#diff-added-count').text(diff.added);
    $('#diff-removed-count').text(diff.removed);
    $('#diff-unchanged-count').text(diff.unchanged);

    // Display diff content
    $('#diff-content').html(diff.html);
    $('#diff-content-container').show();
    $('#diff-no-changes').hide();
}

// Compute line-by-line diff
function computeLineDiff(oldLines, newLines) {
    const oldSet = new Set(oldLines);
    const newSet = new Set(newLines);

    let html = '';
    let added = 0;
    let removed = 0;
    let unchanged = 0;

    // First pass: count removed and added
    oldLines.forEach(line => {
        if (!newSet.has(line)) removed++;
    });
    newLines.forEach(line => {
        if (!oldSet.has(line)) added++;
    });

    // Build unified diff output
    let i = 0, j = 0;

    while (i < oldLines.length || j < newLines.length) {
        const oldLine = i < oldLines.length ? oldLines[i] : null;
        const newLine = j < newLines.length ? newLines[j] : null;

        if (oldLine === newLine) {
            unchanged++;
            html += `<div class="diff-line diff-unchanged"><span class="diff-line-num">${j + 1}</span><span class="diff-line-content">${escapeHtml(newLine)}</span></div>`;
            i++;
            j++;
        } else if (oldLine !== null && !newSet.has(oldLine)) {
            html += `<div class="diff-line diff-removed"><span class="diff-line-num">-</span><span class="diff-line-content">${escapeHtml(oldLine)}</span></div>`;
            i++;
        } else if (newLine !== null && !oldSet.has(newLine)) {
            html += `<div class="diff-line diff-added"><span class="diff-line-num">+</span><span class="diff-line-content">${escapeHtml(newLine)}</span></div>`;
            j++;
        } else {
            unchanged++;
            html += `<div class="diff-line diff-unchanged"><span class="diff-line-num">${j + 1}</span><span class="diff-line-content">${escapeHtml(newLine)}</span></div>`;
            i++;
            j++;
        }
    }

    return { html, added, removed, unchanged };
}

// Check for backup parameter in URL and open modal
function checkUrlParams() {
    const urlParams = new URLSearchParams(window.location.search);
    const backupId = urlParams.get('backup');
    if (backupId) {
        // Clear the URL parameter without refreshing
        window.history.replaceState({}, document.title, window.location.pathname);
        // Open the backup view
        viewConfig(backupId);
    }
}

// Copy config to clipboard
function copyConfig() {
    const content = $('#config-content').val();
    navigator.clipboard.writeText(content).then(function() {
        const $btn = $('#copy-config-btn');
        $btn.html('<i class="fas fa-check"></i> Copied!');
        setTimeout(() => $btn.html('<i class="fas fa-copy"></i> Copy'), 2000);
    });
}

// Download config
function downloadConfig() {
    const backup = $('#viewConfigModal').data('backup');
    if (!backup) return;

    const blob = new Blob([backup.config_content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${backup.device_name}_${backup.created_at.replace(/[: ]/g, '_')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Single backup
function showSingleBackupModal() {
    $('#singleBackupModal').modal('show');
}

function startSingleBackup() {
    const device = $('#single-device-select').val();
    if (!device) {
        alert('Please select a device');
        return;
    }

    const $btn = $('#start-single-backup-btn');
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting...');

    $.ajax({
        url: '/api/config-backups/run-single',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ device_name: device })
    })
    .done(function(response) {
        if (response.success) {
            $('#singleBackupModal').modal('hide');
            alert(`Backup started for ${device}`);
            setTimeout(loadBackups, 5000);
        } else {
            alert('Error: ' + response.error);
        }
    })
    .always(function() {
        $btn.prop('disabled', false).html('<i class="fas fa-play"></i> Start Backup');
    });
}

// Fix stale snapshots
function fixStaleSnapshots() {
    if (!confirm('Fix snapshots stuck in "In Progress" state for over 30 minutes?')) return;

    $.ajax({
        url: '/api/config-snapshots/fix-stale',
        method: 'POST'
    })
    .done(function(response) {
        if (response.success) {
            alert(`Fixed ${response.fixed_count} stale snapshots`);
            loadSnapshots();
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// Show cleanup modal
function showCleanupModal() {
    // Reset to default state
    $('#cleanup-orphans').prop('checked', true);
    $('#retention-days-group').hide();
    $('#retention-days-input').val('30');
    $('#cleanupModal').modal('show');
}

// Execute cleanup based on selected option
function executeCleanup() {
    const $btn = $('#confirm-cleanup-btn');
    const selectedOption = $('input[name="cleanupOption"]:checked').val();

    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Deleting...');

    if (selectedOption === 'orphans') {
        // Delete orphaned backups
        $.ajax({
            url: '/api/config-backups/cleanup-orphans',
            method: 'POST'
        })
        .done(function(response) {
            $('#cleanupModal').modal('hide');
            if (response.success) {
                alert(`Deleted ${response.deleted_count} orphaned backups from ${response.orphaned_devices} devices.\n\nDevices in cache: ${response.cached_device_count}`);
                loadBackups();
                loadSummary();
                loadSnapshots();
            } else {
                alert('Error: ' + response.error);
            }
        })
        .fail(function(xhr) {
            $('#cleanupModal').modal('hide');
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to cleanup backups'));
        })
        .always(function() {
            $btn.prop('disabled', false).html('<i class="fas fa-trash-alt"></i> Delete Backups');
        });
    } else {
        // Delete old backups
        const days = parseInt($('#retention-days-input').val()) || 30;

        $.ajax({
            url: '/api/config-backups/cleanup',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ retention_days: days })
        })
        .done(function(response) {
            $('#cleanupModal').modal('hide');
            if (response.success) {
                alert(`Deleted ${response.deleted_count} backups older than ${days} days`);
                loadBackups();
                loadSummary();
            } else {
                alert('Error: ' + response.error);
            }
        })
        .fail(function(xhr) {
            $('#cleanupModal').modal('hide');
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to cleanup backups'));
        })
        .always(function() {
            $btn.prop('disabled', false).html('<i class="fas fa-trash-alt"></i> Delete Backups');
        });
    }
}

// =============================================================================
// Snapshot Comparison Functions
// =============================================================================

// Show compare snapshots modal
function showCompareSnapshotsModal() {
    // Reset state
    currentComparisonData = [];
    $('#compare-results').hide();
    $('#compare-loading').hide();
    $('#compare-no-changes').hide();
    $('#compare-results-tbody').empty();
    $('#compare-search').val('');
    $('#compare-filter').val('');

    // Populate snapshot dropdowns with completed snapshots
    const completedSnapshots = snapshotsList.filter(s => s.status === 'complete' || s.status === 'partial');
    const $select1 = $('#compare-snapshot1');
    const $select2 = $('#compare-snapshot2');

    $select1.html('<option value="">Select snapshot...</option>');
    $select2.html('<option value="">Select snapshot...</option>');

    completedSnapshots.forEach(s => {
        const date = formatDate(s.created_at);
        const label = `${s.name || 'Unnamed'} - ${date} (${s.success_count}/${s.total_devices})`;
        $select1.append(`<option value="${s.snapshot_id}">${label}</option>`);
        $select2.append(`<option value="${s.snapshot_id}">${label}</option>`);
    });

    // Auto-select first two snapshots if available
    if (completedSnapshots.length >= 2) {
        $select1.val(completedSnapshots[1].snapshot_id);  // Older one
        $select2.val(completedSnapshots[0].snapshot_id);  // Newer one
    }

    $('#compareSnapshotsModal').modal('show');
}

// Run snapshot comparison
function runSnapshotComparison() {
    const snapshot1 = $('#compare-snapshot1').val();
    const snapshot2 = $('#compare-snapshot2').val();

    if (!snapshot1 || !snapshot2) {
        alert('Please select both snapshots to compare');
        return;
    }

    if (snapshot1 === snapshot2) {
        alert('Please select two different snapshots');
        return;
    }

    // Show loading
    $('#compare-loading').show();
    $('#compare-results').hide();
    $('#compare-no-changes').hide();

    $.get(`/api/config-snapshots/${snapshot1}/compare/${snapshot2}`)
        .done(function(response) {
            $('#compare-loading').hide();

            if (response.success) {
                currentComparisonData = response.comparison;
                const summary = response.summary;

                // Update summary counts
                $('#compare-total').text(summary.total_devices);
                $('#compare-changed').text(summary.changed);
                $('#compare-added').text(summary.only_in_snapshot2);
                $('#compare-removed').text(summary.only_in_snapshot1);

                // Show results
                $('#compare-results').show();

                // Check if no changes
                if (summary.changed === 0 && summary.only_in_snapshot1 === 0 && summary.only_in_snapshot2 === 0) {
                    $('#compare-no-changes').show();
                } else {
                    $('#compare-no-changes').hide();
                }

                renderComparisonResults(currentComparisonData);
            } else {
                alert('Error: ' + response.error);
            }
        })
        .fail(function(xhr) {
            $('#compare-loading').hide();
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to compare snapshots'));
        });
}

// Render comparison results table
function renderComparisonResults(data) {
    const $tbody = $('#compare-results-tbody');
    $tbody.empty();

    if (!data || data.length === 0) {
        $tbody.html('<tr><td colspan="3" class="text-center text-muted">No devices to display</td></tr>');
        return;
    }

    data.forEach(function(item) {
        let statusBadge = '';
        let statusClass = '';
        let actionButtons = '';

        if (!item.in_snapshot1 && item.in_snapshot2) {
            // Added in snapshot2
            statusBadge = '<span class="badge bg-success"><i class="fas fa-plus"></i> Added</span>';
            statusClass = 'added';
            actionButtons = `
                <button class="btn btn-sm btn-outline-primary" onclick="viewConfig('${item.backup2_id}')" title="View New Config">
                    <i class="fas fa-eye"></i>
                </button>
            `;
        } else if (item.in_snapshot1 && !item.in_snapshot2) {
            // Removed in snapshot2
            statusBadge = '<span class="badge bg-danger"><i class="fas fa-minus"></i> Removed</span>';
            statusClass = 'removed';
            actionButtons = `
                <button class="btn btn-sm btn-outline-secondary" onclick="viewConfig('${item.backup1_id}')" title="View Old Config">
                    <i class="fas fa-eye"></i>
                </button>
            `;
        } else if (item.changed) {
            // Changed
            statusBadge = '<span class="badge bg-warning text-dark"><i class="fas fa-exchange-alt"></i> Changed</span>';
            statusClass = 'changed';
            actionButtons = `
                <button class="btn btn-sm btn-outline-warning" onclick="viewDeviceDiff('${item.backup1_id}', '${item.backup2_id}', '${escapeHtml(item.device_name)}')" title="View Diff">
                    <i class="fas fa-code-compare"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary" onclick="viewConfig('${item.backup2_id}')" title="View Current">
                    <i class="fas fa-eye"></i>
                </button>
            `;
        } else {
            // Unchanged
            statusBadge = '<span class="badge bg-secondary"><i class="fas fa-equals"></i> Unchanged</span>';
            statusClass = 'unchanged';
            actionButtons = `
                <button class="btn btn-sm btn-outline-primary" onclick="viewConfig('${item.backup2_id}')" title="View Config">
                    <i class="fas fa-eye"></i>
                </button>
            `;
        }

        $tbody.append(`
            <tr data-status="${statusClass}">
                <td><i class="fas fa-server text-muted"></i> ${escapeHtml(item.device_name)}</td>
                <td>${statusBadge}</td>
                <td>${actionButtons}</td>
            </tr>
        `);
    });
}

// Filter comparison results
function filterComparisonResults() {
    const search = $('#compare-search').val().toLowerCase();
    const filter = $('#compare-filter').val();

    let filtered = currentComparisonData;

    // Apply search filter
    if (search) {
        filtered = filtered.filter(item => item.device_name.toLowerCase().includes(search));
    }

    // Apply status filter
    if (filter) {
        filtered = filtered.filter(item => {
            if (filter === 'changed') return item.changed && item.in_snapshot1 && item.in_snapshot2;
            if (filter === 'added') return !item.in_snapshot1 && item.in_snapshot2;
            if (filter === 'removed') return item.in_snapshot1 && !item.in_snapshot2;
            if (filter === 'unchanged') return !item.changed && item.in_snapshot1 && item.in_snapshot2;
            return true;
        });
    }

    renderComparisonResults(filtered);
}

// View diff between two specific backups
function viewDeviceDiff(backup1Id, backup2Id, deviceName) {
    // Fetch both backups and show diff
    Promise.all([
        $.get(`/api/config-backups/${backup1Id}`),
        $.get(`/api/config-backups/${backup2Id}`)
    ]).then(function([response1, response2]) {
        // Handle both response formats: response.data.backup or response.backup
        const data1 = response1.data || response1;
        const data2 = response2.data || response2;
        if (response1.success && response2.success && data1.backup && data2.backup) {
            const oldConfig = data1.backup.config_content || '';
            const newConfig = data2.backup.config_content || '';

            // Open the config modal with the new backup, then switch to diff tab
            $('#config-modal-title').text(`Diff: ${deviceName}`);
            $('#config-device').text(deviceName);
            $('#config-format').text(data2.backup.config_format || 'native');
            $('#config-size').text(formatSize(data2.backup.file_size));
            $('#config-time').text(formatDate(data2.backup.created_at));
            $('#config-content').val(newConfig);
            $('#viewConfigModal').data('backup', data2.backup);

            // Display the diff directly
            displayDiff(newConfig, oldConfig);

            // Switch to diff tab
            $('#diff-tab').tab('show');

            // Hide compare snapshots modal and show config modal
            $('#compareSnapshotsModal').modal('hide');
            setTimeout(() => {
                $('#viewConfigModal').modal('show');
            }, 300);
        }
    }).catch(function() {
        alert('Error loading backup configurations');
    });
}

// Utility functions
function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    return new Date(dateStr).toLocaleString();
}

function formatSize(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =============================================================================
// All Backups Modal Functions
// =============================================================================

function loadAllBackups(deviceFilter = '') {
    const offset = backupsPage * backupsPageSize;
    let url = `/api/config-backups?limit=${backupsPageSize}&offset=${offset}`;
    if (deviceFilter) {
        url += `&device=${encodeURIComponent(deviceFilter)}`;
    }

    $.get(url)
        .done(function(response) {
            const data = response.data || response;
            if (response.success && data.backups) {
                renderAllBackupsTable(data.backups);
                $('#backup-count').text(data.backups.length);
                $('#prev-page-item').toggleClass('disabled', backupsPage === 0);
                $('#next-page-item').toggleClass('disabled', data.backups.length < backupsPageSize);

                // Populate device filter if not already done
                if (data.summary && data.summary.devices_with_backups) {
                    const $filter = $('#filter-backup-device');
                    if ($filter.find('option').length <= 1) {
                        data.summary.devices_with_backups.forEach(d => {
                            $filter.append(`<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`);
                        });
                    }
                }
            }
        })
        .fail(function() {
            $('#all-backups-table-body').html('<tr><td colspan="6" class="text-center text-danger">Failed to load backups</td></tr>');
        });
}

function renderAllBackupsTable(backups) {
    const $tbody = $('#all-backups-table-body');
    $tbody.empty();

    if (!backups || backups.length === 0) {
        $tbody.html('<tr><td colspan="6" class="text-center text-muted">No backups found</td></tr>');
        return;
    }

    backups.forEach(function(backup) {
        const statusBadge = backup.status === 'success'
            ? '<span class="badge bg-success">Success</span>'
            : '<span class="badge bg-danger">Failed</span>';

        const formatBadge = backup.config_format === 'set'
            ? '<span class="badge bg-info">Set</span>'
            : '<span class="badge bg-secondary">Native</span>';

        $tbody.append(`
            <tr>
                <td><i class="fas fa-server text-muted"></i> ${escapeHtml(backup.device_name)}</td>
                <td><small>${formatDate(backup.created_at)}</small></td>
                <td>${formatBadge}</td>
                <td><small>${formatFileSize(backup.file_size || 0)}</small></td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-all-backup-btn" data-id="${backup.backup_id}" data-device="${escapeHtml(backup.device_name)}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-all-backup-btn" data-id="${backup.backup_id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });

    // Bind handlers
    $('.view-all-backup-btn').click(function() {
        const backupId = $(this).data('id');
        const deviceName = $(this).data('device');
        // Close allBackupsModal, open viewBackupModal
        bootstrap.Modal.getInstance(document.getElementById('allBackupsModal')).hide();
        viewBackupConfig(backupId, deviceName);
    });

    $('.delete-all-backup-btn').click(function() {
        const backupId = $(this).data('id');
        deleteBackupFromList(backupId);
    });
}

function deleteBackupFromList(backupId) {
    if (!confirm('Are you sure you want to delete this backup?')) return;

    $.ajax({
        url: `/api/config-backups/${backupId}`,
        method: 'DELETE'
    })
    .done(function(response) {
        if (response.success) {
            loadAllBackups($('#filter-backup-device').val());
            loadSummary();
            loadDeviceBackupStatus();
        } else {
            alert('Error: ' + (response.error || 'Failed to delete backup'));
        }
    })
    .fail(function() {
        alert('Failed to delete backup');
    });
}

// =============================================================================
// Device Management Functions
// =============================================================================

// Load devices table
function loadDevicesTable() {
    console.log('Loading devices table...');
    $('#devices-loading').show();
    $('#devices-container').hide();

    $.get('/api/devices')
        .done(function(response) {
            console.log('Devices response:', response);
            if (response.success) {
                // Handle both response formats: response.data.devices or response.devices
                const data = response.data || response;
                allDevices = data.devices || [];
                renderDevicesTable(allDevices);
                $('#device-count-display').text(allDevices.length);
            } else {
                console.error('Error loading devices:', response.error);
                $('#devices-tbody').html(`
                    <tr><td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Error: ${escapeHtml(response.error || 'Failed to load devices')}
                    </td></tr>
                `);
            }
        })
        .fail(function(xhr) {
            console.error('Failed to load devices:', xhr);
            $('#devices-tbody').html(`
                <tr><td colspan="7" class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle"></i> Failed to load devices
                </td></tr>
            `);
        })
        .always(function() {
            $('#devices-loading').hide();
            $('#devices-container').show();
        });
}

// Render devices table
function renderDevicesTable(devices) {
    const $tbody = $('#devices-tbody');
    $tbody.empty();

    if (!devices || devices.length === 0) {
        $tbody.html(`
            <tr><td colspan="7" class="text-center text-muted py-4">
                <i class="fas fa-server"></i> No devices in cache.
                <br><small>Add a manual device or sync from NetBox.</small>
            </td></tr>
        `);
        return;
    }

    devices.forEach(device => {
        const name = device.name || device.device_name || 'Unknown';
        const ip = device.primary_ip || device.host || device.ip || device.management_ip || '-';
        const deviceType = device.platform || device.device_type || '-';
        const source = device.source || 'netbox';
        const isManual = source === 'manual';
        const lastBackup = deviceBackups[name];
        const override = deviceOverrides[name];
        const isDisabled = override?.disabled;

        const sourceLabel = isManual
            ? '<span class="badge bg-warning text-dark">Manual</span>'
            : '<span class="badge bg-info">NetBox</span>';

        const lastBackupDisplay = lastBackup
            ? `<span class="text-success" title="${formatDate(lastBackup.created_at)}">${formatTimeAgo(lastBackup.created_at)}</span>`
            : '<span class="text-muted">Never</span>';

        $tbody.append(`
            <tr${isDisabled ? ' style="opacity: 0.6;"' : ''}>
                <td>
                    <input type="checkbox" class="form-check-input device-checkbox"
                           data-device="${escapeHtml(name)}"
                           data-ip="${escapeHtml(ip)}"
                           data-type="${escapeHtml(deviceType)}"
                           data-source="${escapeHtml(source)}">
                </td>
                <td>
                    ${escapeHtml(name)}
                    ${isDisabled ? '<span class="badge bg-secondary ms-1">Disabled</span>' : ''}
                    ${override ? '<i class="fas fa-cog text-info ms-1" title="Has overrides"></i>' : ''}
                </td>
                <td>${escapeHtml(ip)}</td>
                <td>${escapeHtml(deviceType)}</td>
                <td>${sourceLabel}</td>
                <td>${lastBackupDisplay}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary btn-sm" onclick="testDeviceConnectivity('${escapeHtml(name)}')" title="Test">
                            <i class="fas fa-plug"></i>
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="showEditDeviceModal('${escapeHtml(name)}')" title="Edit">
                            <i class="fas fa-cog"></i>
                        </button>
                        ${lastBackup ? `
                        <button class="btn btn-outline-success btn-sm" onclick="viewDeviceBackup('${escapeHtml(name)}')" title="View Backup">
                            <i class="fas fa-file-code"></i>
                        </button>
                        ` : ''}
                        ${isManual ? `
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteManualDevice('${escapeHtml(name)}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </div>
                </td>
            </tr>
        `);
    });

    // Re-attach checkbox event handlers
    $('.device-checkbox').change(updateSelectedDevices);
}

// Filter devices table by search
function filterDevicesTable() {
    const search = $('#device-search').val().toLowerCase();
    if (!search) {
        renderDevicesTable(allDevices);
        $('#filter-info').text('');
        return;
    }

    const filtered = allDevices.filter(device => {
        const name = (device.name || device.device_name || '').toLowerCase();
        const ip = (device.primary_ip || device.ip || device.management_ip || '').toLowerCase();
        const type = (device.platform || device.device_type || '').toLowerCase();
        return name.includes(search) || ip.includes(search) || type.includes(search);
    });

    renderDevicesTable(filtered);
    $('#filter-info').text(`(${filtered.length} of ${allDevices.length})`);
}

// Load device backup status
function loadDeviceBackupStatus() {
    $.get('/api/config-backups?limit=500')
        .done(function(response) {
            // Handle both response formats: response.data.backups or response.backups
            const data = response.data || response;
            if (response.success && data.backups) {
                // Build map of device -> latest backup
                deviceBackups = {};
                data.backups.forEach(backup => {
                    const deviceName = backup.device_name;
                    if (!deviceBackups[deviceName] || new Date(backup.created_at) > new Date(deviceBackups[deviceName].created_at)) {
                        deviceBackups[deviceName] = backup;
                    }
                });
                // Re-render table with backup info
                if (allDevices.length > 0) {
                    renderDevicesTable(allDevices);
                }
            }
        });
}

// Load device overrides
function loadDeviceOverrides() {
    $.get('/api/device-overrides')
        .done(function(response) {
            // Handle both response formats: response.data.overrides or response.overrides
            const data = response.data || response;
            if (response.success && data.overrides) {
                deviceOverrides = {};
                data.overrides.forEach(override => {
                    deviceOverrides[override.device_name] = override;
                });
                // Re-render table with override indicators
                if (allDevices.length > 0) {
                    renderDevicesTable(allDevices);
                }
            }
        });
}

// Update selected devices
function updateSelectedDevices() {
    selectedDevices = [];
    $('.device-checkbox:checked').each(function() {
        selectedDevices.push({
            name: $(this).data('device'),
            ip: $(this).data('ip'),
            type: $(this).data('type'),
            source: $(this).data('source')
        });
    });

    // Show/hide bulk actions bar
    if (selectedDevices.length > 0) {
        $('#bulk-actions-bar').attr('style', '').show();
        $('#selected-count').text(selectedDevices.length);
    } else {
        $('#bulk-actions-bar').hide().attr('style', 'display: none !important;');
    }
}

// Show add device modal
function showAddDeviceModal() {
    $('#add-device-form')[0].reset();
    $('#addDeviceModal').modal('show');
}

// Save new manual device
function saveNewDevice() {
    const name = $('#device-name').val().trim();
    const deviceType = $('#device-type').val();
    const host = $('#device-host').val().trim();
    const port = parseInt($('#device-port').val()) || 22;
    const username = $('#device-username').val().trim();
    const password = $('#device-password').val();

    if (!name || !deviceType || !host) {
        alert('Please fill in all required fields');
        return;
    }

    const deviceData = {
        name: name,
        device_type: deviceType,
        host: host,
        port: port,
        source: 'manual'
    };

    if (username) deviceData.username = username;
    if (password) deviceData.password = password;

    $.ajax({
        url: '/api/devices',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(deviceData)
    })
    .done(function(response) {
        if (response.success) {
            $('#addDeviceModal').modal('hide');
            loadDevicesTable();
            alert('Device added successfully');
        } else {
            alert('Error: ' + (response.error || 'Failed to add device'));
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to add device'));
    });
}

// Clear cache and reload devices
function clearCacheAndReload() {
    if (!confirm('This will reload all devices from NetBox. Continue?')) {
        return;
    }

    $.post('/api/devices/reload')
        .done(function(response) {
            if (response.success) {
                loadDevicesTable();
                loadSummary();
                alert('Devices reloaded successfully');
            } else {
                alert('Error: ' + (response.error || 'Failed to reload devices'));
            }
        })
        .fail(function(xhr) {
            alert('Error: ' + (xhr.responseJSON?.error || 'Failed to reload devices'));
        });
}

// Show edit device modal
function showEditDeviceModal(deviceName) {
    $('#edit-device-name').val(deviceName);
    $('#edit-device-display-name').text(deviceName);

    // Reset form
    $('#edit-device-type').val('');
    $('#edit-device-host').val('');
    $('#edit-device-port').val('');
    $('#edit-device-username').val('');
    $('#edit-device-password').val('');
    $('#edit-device-secret').val('');
    $('#edit-device-timeout').val('');
    $('#edit-device-conn-timeout').val('');
    $('#edit-device-auth-timeout').val('');
    $('#edit-device-banner-timeout').val('');
    $('#edit-device-notes').val('');
    $('#edit-device-disabled').prop('checked', false);

    // Load existing overrides
    const override = deviceOverrides[deviceName];
    if (override) {
        if (override.device_type) $('#edit-device-type').val(override.device_type);
        if (override.host) $('#edit-device-host').val(override.host);
        if (override.port) $('#edit-device-port').val(override.port);
        if (override.username) $('#edit-device-username').val(override.username);
        if (override.timeout) $('#edit-device-timeout').val(override.timeout);
        if (override.conn_timeout) $('#edit-device-conn-timeout').val(override.conn_timeout);
        if (override.auth_timeout) $('#edit-device-auth-timeout').val(override.auth_timeout);
        if (override.banner_timeout) $('#edit-device-banner-timeout').val(override.banner_timeout);
        if (override.notes) $('#edit-device-notes').val(override.notes);
        if (override.disabled) $('#edit-device-disabled').prop('checked', true);
    }

    $('#editDeviceModal').modal('show');
}

// Save device override
function saveDeviceOverride() {
    const deviceName = $('#edit-device-name').val();
    const overrideData = {
        device_name: deviceName
    };

    // Collect non-empty values
    const deviceType = $('#edit-device-type').val();
    const host = $('#edit-device-host').val().trim();
    const port = $('#edit-device-port').val();
    const username = $('#edit-device-username').val().trim();
    const password = $('#edit-device-password').val();
    const secret = $('#edit-device-secret').val();
    const timeout = $('#edit-device-timeout').val();
    const connTimeout = $('#edit-device-conn-timeout').val();
    const authTimeout = $('#edit-device-auth-timeout').val();
    const bannerTimeout = $('#edit-device-banner-timeout').val();
    const notes = $('#edit-device-notes').val().trim();
    const disabled = $('#edit-device-disabled').is(':checked');

    if (deviceType) overrideData.device_type = deviceType;
    if (host) overrideData.host = host;
    if (port) overrideData.port = parseInt(port);
    if (username) overrideData.username = username;
    if (password) overrideData.password = password;
    if (secret) overrideData.secret = secret;
    if (timeout) overrideData.timeout = parseInt(timeout);
    if (connTimeout) overrideData.conn_timeout = parseInt(connTimeout);
    if (authTimeout) overrideData.auth_timeout = parseInt(authTimeout);
    if (bannerTimeout) overrideData.banner_timeout = parseInt(bannerTimeout);
    if (notes) overrideData.notes = notes;
    overrideData.disabled = disabled;

    $.ajax({
        url: `/api/device-overrides/${encodeURIComponent(deviceName)}`,
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(overrideData)
    })
    .done(function(response) {
        if (response.success) {
            $('#editDeviceModal').modal('hide');
            loadDeviceOverrides();
            loadDevicesTable();
            alert('Settings saved successfully');
        } else {
            alert('Error: ' + (response.error || 'Failed to save settings'));
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to save settings'));
    });
}

// Delete device override
function deleteDeviceOverride() {
    const deviceName = $('#edit-device-name').val();

    if (!confirm(`Clear all overrides for ${deviceName}?`)) {
        return;
    }

    $.ajax({
        url: `/api/device-overrides/${encodeURIComponent(deviceName)}`,
        method: 'DELETE'
    })
    .done(function(response) {
        if (response.success) {
            $('#editDeviceModal').modal('hide');
            delete deviceOverrides[deviceName];
            renderDevicesTable(allDevices);
            alert('Overrides cleared');
        } else {
            alert('Error: ' + (response.error || 'Failed to clear overrides'));
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to clear overrides'));
    });
}

// Test device connectivity
function testDeviceConnectivity(deviceName) {
    const $btn = $(`button[onclick="testDeviceConnectivity('${deviceName}')"]`);
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

    $.post(`/api/devices/${encodeURIComponent(deviceName)}/test`)
        .done(function(response) {
            const data = response.data || response;
            if (data.success) {
                let msg = `${deviceName}: Connection successful`;
                if (data.response_ms) {
                    msg += ` (${data.response_ms}ms)`;
                }
                if (data.device_info && data.device_info.prompt) {
                    msg += `\nPrompt: ${data.device_info.prompt}`;
                }
                alert(msg);
            } else {
                alert(`${deviceName}: Connection failed\n${data.message || 'Unknown error'}`);
            }
            $btn.prop('disabled', false).html('<i class="fas fa-plug"></i>');
        })
        .fail(function(xhr) {
            const errData = xhr.responseJSON?.data || xhr.responseJSON || {};
            alert('Error: ' + (errData.message || xhr.responseJSON?.error || 'Failed to test connectivity'));
            $btn.prop('disabled', false).html('<i class="fas fa-plug"></i>');
        });
}

// View device backup
function viewDeviceBackup(deviceName) {
    const backup = deviceBackups[deviceName];
    if (!backup) {
        alert('No backup found for this device');
        return;
    }

    $('#view-backup-device-name').text(deviceName);
    $('#view-backup-created').text(formatDate(backup.created_at));
    $('#view-backup-format').text(backup.config_format || 'native');
    $('#view-backup-size').text(formatSize(backup.file_size));

    $('#view-backup-loading').show();
    $('#view-backup-content-container').hide();
    $('#viewBackupModal').modal('show');

    // Fetch full backup content
    $.get(`/api/config-backups/${backup.backup_id}`)
        .done(function(response) {
            // Handle both response formats: response.data.backup or response.backup
            const data = response.data || response;
            if (response.success && data.backup) {
                $('#view-backup-config').val(data.backup.config_content || '');
                $('#view-backup-loading').hide();
                $('#view-backup-content-container').show();
            } else {
                $('#view-backup-loading').html('<p class="text-danger">Failed to load backup</p>');
            }
        })
        .fail(function() {
            $('#view-backup-loading').html('<p class="text-danger">Failed to load backup</p>');
        });
}

// Copy backup config
function copyBackupConfig() {
    const config = $('#view-backup-config').val();
    navigator.clipboard.writeText(config).then(() => {
        const $btn = $('#copy-backup-btn');
        const original = $btn.html();
        $btn.html('<i class="fas fa-check"></i> Copied!');
        setTimeout(() => $btn.html(original), 2000);
    });
}

// Download backup config
function downloadBackupConfig() {
    const config = $('#view-backup-config').val();
    const deviceName = $('#view-backup-device-name').text();
    const blob = new Blob([config], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${deviceName}_backup.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
}

// Delete manual device
function deleteManualDevice(deviceName) {
    if (!confirm(`Delete device "${deviceName}"? This cannot be undone.`)) {
        return;
    }

    $.ajax({
        url: `/api/devices/${encodeURIComponent(deviceName)}`,
        method: 'DELETE'
    })
    .done(function(response) {
        if (response.success) {
            loadDevicesTable();
            alert('Device deleted');
        } else {
            alert('Error: ' + (response.error || 'Failed to delete device'));
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to delete device'));
    });
}

// =============================================================================
// Bulk Operations
// =============================================================================

// Execute bulk test connectivity
function executeBulkTestConnectivity() {
    if (selectedDevices.length === 0) return;

    const deviceNames = selectedDevices.map(d => d.name);

    showBulkProgress();

    $.ajax({
        url: '/api/devices/bulk/test',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ devices: deviceNames })
    })
    .done(function(response) {
        if (response.success && response.data && response.data.task_ids) {
            pollBulkProgress(response.data.task_ids);
        } else {
            alert('Error: ' + (response.error || 'Failed to start bulk test'));
            $('#bulkStatusModal').modal('hide');
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to start bulk test'));
        $('#bulkStatusModal').modal('hide');
    });
}

// Show bulk get config modal
function showBulkGetConfigModal() {
    if (selectedDevices.length === 0) return;
    $('#bulk-get-command').val('show running-config');
    $('#bulk-get-username').val('');
    $('#bulk-get-password').val('');
    $('#bulk-get-use-textfsm').prop('checked', false);
    $('#bulkGetConfigModal').modal('show');
}

// Execute bulk get config
function executeBulkGetConfig() {
    const command = $('#bulk-get-command').val().trim();
    if (!command) {
        alert('Please enter a command');
        return;
    }

    const deviceNames = selectedDevices.map(d => d.name);
    const payload = {
        devices: deviceNames,
        command: command,
        use_textfsm: $('#bulk-get-use-textfsm').is(':checked')
    };

    const username = $('#bulk-get-username').val().trim();
    const password = $('#bulk-get-password').val();
    if (username) payload.username = username;
    if (password) payload.password = password;

    $('#bulkGetConfigModal').modal('hide');
    showBulkProgress();

    $.ajax({
        url: '/api/devices/bulk/get-config',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload)
    })
    .done(function(response) {
        if (response.success && response.data && response.data.task_ids) {
            pollBulkProgress(response.data.task_ids);
        } else {
            alert('Error: ' + (response.error || 'Failed to start bulk get config'));
            $('#bulkStatusModal').modal('hide');
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to start bulk get config'));
        $('#bulkStatusModal').modal('hide');
    });
}

// Show bulk set config modal
function showBulkSetConfigModal() {
    if (selectedDevices.length === 0) return;
    $('#bulk-set-config').val('');
    $('#bulk-set-username').val('');
    $('#bulk-set-password').val('');
    $('#bulk-set-dry-run').prop('checked', false);
    $('#bulk-set-manual').prop('checked', true);
    $('#bulk-set-manual-container').show();
    $('#bulk-set-template-container').hide();
    $('#bulkSetConfigModal').modal('show');
}

// Load templates for bulk set config
function loadBulkTemplates() {
    $.get('/api/templates')
        .done(function(response) {
            const $select = $('#bulk-set-template-select');
            $select.html('<option value="">Select template...</option>');
            if (response.success && response.templates) {
                response.templates.forEach(t => {
                    $select.append(`<option value="${escapeHtml(t.name)}">${escapeHtml(t.name)}</option>`);
                });
            }
        });
}

// Execute bulk set config
function executeBulkSetConfig() {
    const source = $('input[name="bulk-set-config-source"]:checked').val();
    const deviceNames = selectedDevices.map(d => d.name);

    let config = '';
    let templateName = '';
    let templateVars = {};

    if (source === 'manual') {
        config = $('#bulk-set-config').val().trim();
        if (!config) {
            alert('Please enter configuration commands');
            return;
        }
    } else {
        templateName = $('#bulk-set-template-select').val();
        if (!templateName) {
            alert('Please select a template');
            return;
        }
        try {
            const varsText = $('#bulk-set-template-vars').val().trim();
            if (varsText) {
                templateVars = JSON.parse(varsText);
            }
        } catch (e) {
            alert('Invalid JSON in template variables');
            return;
        }
    }

    const payload = {
        devices: deviceNames,
        dry_run: $('#bulk-set-dry-run').is(':checked')
    };

    if (source === 'manual') {
        payload.config = config;
    } else {
        payload.template_name = templateName;
        payload.template_vars = templateVars;
    }

    const username = $('#bulk-set-username').val().trim();
    const password = $('#bulk-set-password').val();
    if (username) payload.username = username;
    if (password) payload.password = password;

    $('#bulkSetConfigModal').modal('hide');
    showBulkProgress();

    $.ajax({
        url: '/api/devices/bulk/set-config',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload)
    })
    .done(function(response) {
        if (response.success && response.data && response.data.task_ids) {
            pollBulkProgress(response.data.task_ids);
        } else {
            alert('Error: ' + (response.error || 'Failed to start bulk set config'));
            $('#bulkStatusModal').modal('hide');
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to start bulk set config'));
        $('#bulkStatusModal').modal('hide');
    });
}

// Execute bulk backup
function executeBulkBackup() {
    if (selectedDevices.length === 0) return;

    const deviceNames = selectedDevices.map(d => d.name);

    showBulkProgress();

    $.ajax({
        url: '/api/devices/bulk/backup',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ devices: deviceNames })
    })
    .done(function(response) {
        if (response.success && response.data && response.data.task_ids) {
            pollBulkProgress(response.data.task_ids);
        } else {
            alert('Error: ' + (response.error || 'Failed to start bulk backup'));
            $('#bulkStatusModal').modal('hide');
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to start bulk backup'));
        $('#bulkStatusModal').modal('hide');
    });
}

// Execute bulk delete
function executeBulkDelete() {
    // Filter to only manual devices
    const manualDevices = selectedDevices.filter(d => d.source === 'manual');

    if (manualDevices.length === 0) {
        alert('No manual devices selected. Only manual devices can be deleted.');
        return;
    }

    if (!confirm(`Delete ${manualDevices.length} manual device(s)? This cannot be undone.`)) {
        return;
    }

    const deviceNames = manualDevices.map(d => d.name);

    $.ajax({
        url: '/api/devices/bulk/delete',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ devices: deviceNames })
    })
    .done(function(response) {
        if (response.success) {
            loadDevicesTable();
            $('.device-checkbox').prop('checked', false);
            updateSelectedDevices();
            alert(`${response.deleted || deviceNames.length} device(s) deleted`);
        } else {
            alert('Error: ' + (response.error || 'Failed to delete devices'));
        }
    })
    .fail(function(xhr) {
        alert('Error: ' + (xhr.responseJSON?.error || 'Failed to delete devices'));
    });
}

// Show bulk progress modal
function showBulkProgress() {
    $('#bulk-progress-bar').css('width', '0%').text('0%');
    $('#bulk-completed-count').text('0');
    $('#bulk-success-count').text('0');
    $('#bulk-failed-count').text('0');
    $('#bulkStatusModal').modal('show');
}

// Poll bulk progress
function pollBulkProgress(taskIds) {
    const total = taskIds.length;
    let completed = 0;
    let success = 0;
    let failed = 0;

    function checkTasks() {
        const pending = taskIds.filter((_, i) => {
            // Already processed
            return true;
        });

        Promise.all(taskIds.map(taskId =>
            $.get(`/api/celery/task/${taskId}`).then(
                response => ({ taskId, response }),
                () => ({ taskId, response: { status: 'error' } })
            )
        )).then(results => {
            completed = 0;
            success = 0;
            failed = 0;

            results.forEach(({ response }) => {
                if (response.status === 'SUCCESS') {
                    completed++;
                    success++;
                } else if (response.status === 'FAILURE' || response.status === 'error') {
                    completed++;
                    failed++;
                } else if (response.status === 'PENDING' || response.status === 'STARTED') {
                    // Still running
                }
            });

            // Count still running as not completed
            const stillRunning = results.filter(r =>
                r.response.status === 'PENDING' || r.response.status === 'STARTED'
            ).length;

            completed = total - stillRunning;

            const percent = Math.round((completed / total) * 100);
            $('#bulk-progress-bar').css('width', percent + '%').text(percent + '%');
            $('#bulk-completed-count').text(completed);
            $('#bulk-success-count').text(success);
            $('#bulk-failed-count').text(failed);

            if (completed < total) {
                setTimeout(checkTasks, 2000);
            } else {
                // Done
                $('#bulk-progress-bar')
                    .removeClass('progress-bar-animated')
                    .addClass(failed > 0 ? 'bg-warning' : 'bg-success');
                loadDeviceBackupStatus();
            }
        });
    }

    setTimeout(checkTasks, 1000);
}

// Poll single task result
function pollTaskResult(taskId, callback) {
    function check() {
        $.get(`/api/celery/task/${taskId}`)
            .done(function(response) {
                if (response.status === 'SUCCESS') {
                    callback({ success: true, result: response.result });
                } else if (response.status === 'FAILURE') {
                    callback({ success: false, error: response.error || 'Task failed' });
                } else {
                    setTimeout(check, 1000);
                }
            })
            .fail(function() {
                callback({ success: false, error: 'Failed to check task status' });
            });
    }
    check();
}

// Format time ago
function formatTimeAgo(dateStr) {
    if (!dateStr) return 'Never';
    const date = new Date(dateStr);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000);

    if (diff < 60) return 'Just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
    return formatDate(dateStr);
}
</script>
    <!-- NetStacks AI Assistant -->
    <script src="/static/js/assistant.js?v=4"></script>
</body>
</html>
