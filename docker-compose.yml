services:
  # NetStacks Web UI (Frontend + API)
  netstacks:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: netstacks
    environment:
      # Database Configuration
      - DB_FILE=/data/netstacks.db
      - DATABASE_URL=postgresql://netstacks:${POSTGRES_PASSWORD:-netstacks_secret_change_me}@postgres:5432/netstacks
      - USE_POSTGRES=${USE_POSTGRES:-true}
      # Celery Configuration
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      # Timezone Configuration
      - TZ=${TZ:-America/New_York}
    ports:
      - "8089:8088"
    volumes:
      - netstacks-data:/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - netstacks-network
    depends_on:
      - redis
      - postgres
    restart: unless-stopped

  # Celery Worker for device operations
  celery-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: netstacks-celery-worker
    command: celery -A tasks worker -l info -Q device_tasks,celery -c ${CELERY_WORKERS:-20}
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DB_FILE=/data/netstacks.db
      - DATABASE_URL=postgresql://netstacks:${POSTGRES_PASSWORD:-netstacks_secret_change_me}@postgres:5432/netstacks
      - TZ=${TZ:-America/New_York}
    volumes:
      - netstacks-data:/data
      - /etc/localtime:/etc/localtime:ro
    networks:
      - netstacks-network
    depends_on:
      - redis
    restart: unless-stopped

  # Celery Beat for scheduled tasks (Netbox sync, etc.)
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: netstacks-celery-beat
    command: celery -A tasks beat -l info --schedule=/data/celerybeat-schedule
    environment:
      - CELERY_BROKER_URL=redis://redis:6379/0
      - CELERY_RESULT_BACKEND=redis://redis:6379/0
      - DB_FILE=/data/netstacks.db
      - TZ=${TZ:-America/New_York}
    volumes:
      - netstacks-data:/data
    networks:
      - netstacks-network
    depends_on:
      - redis
    restart: unless-stopped

  # Redis (message broker for Celery)
  redis:
    image: redis:7-alpine
    container_name: netstacks-redis
    volumes:
      - redis-data:/data
    networks:
      - netstacks-network
    restart: unless-stopped

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: netstacks-postgres
    environment:
      - POSTGRES_DB=netstacks
      - POSTGRES_USER=netstacks
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-netstacks_secret_change_me}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - netstacks-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U netstacks"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  netstacks-network:
    name: netstacks-network

volumes:
  netstacks-data:
  postgres-data:
  redis-data:
