{% extends "base.html" %}

{% block title %}Procedures (MOP) - NetStacks{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-list-check"></i> Method of Procedures (MOP)
        </h1>
    </div>
</div>

<div class="row">
    <!-- MOPs List -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-folder"></i> Saved Procedures</h5>
                <button class="btn btn-sm btn-primary" id="create-mop-btn">
                    <i class="fas fa-plus"></i> New
                </button>
            </div>
            <div class="card-body p-0">
                <div id="mops-list" class="list-group list-group-flush" style="max-height: 600px; overflow-y: auto;">
                    <div class="p-3 text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MOP Editor -->
    <div class="col-md-8">
        <div id="no-mop-selected" class="card">
            <div class="card-body text-center text-muted py-5">
                <i class="fas fa-arrow-left fa-3x mb-3"></i>
                <h4>No Procedure Selected</h4>
                <p>Select a procedure from the list or create a new one</p>
            </div>
        </div>

        <div id="mop-editor" class="card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-edit"></i> <span id="mop-title">Procedure Editor</span></h5>
                <div>
                    <button class="btn btn-sm btn-success" id="execute-mop-btn">
                        <i class="fas fa-play"></i> Execute
                    </button>
                    <button class="btn btn-sm btn-warning" id="save-mop-btn">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button class="btn btn-sm btn-danger" id="delete-mop-btn">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
            <div class="card-body">
                <input type="hidden" id="current-mop-id">

                <div class="mb-3">
                    <label for="mop-name" class="form-label">Procedure Name</label>
                    <input type="text" class="form-control" id="mop-name" placeholder="My Network Change Procedure">
                </div>

                <div class="mb-3">
                    <label for="mop-description" class="form-label">Description</label>
                    <textarea class="form-control" id="mop-description" rows="2" placeholder="Brief description of this procedure"></textarea>
                </div>

                <div class="mb-3">
                    <label for="mop-devices" class="form-label">
                        <i class="fas fa-server"></i> Target Devices
                    </label>
                    <div class="input-group mb-2">
                        <select class="form-select" id="mop-device-dropdown">
                            <option value="">Select a device...</option>
                        </select>
                        <button class="btn btn-outline-primary" type="button" id="add-mop-device-btn">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                    <div id="mop-devices-list" class="border rounded p-2" style="min-height: 100px; max-height: 200px; overflow-y: auto;">
                        <small class="text-muted">No devices added yet</small>
                    </div>
                    <small class="form-text text-muted">
                        Add devices to this procedure. Steps can only use these devices.
                    </small>
                </div>

                <!-- Variables Info -->
                <div id="mop-variables-info" class="alert alert-info" style="display: none;">
                    <strong><i class="fas fa-code"></i> Variables detected:</strong>
                    <span id="mop-variables-list"></span>
                </div>

                <hr>

                <!-- Execution Status (appears above steps during execution) -->
                <div id="execution-status" class="mb-3" style="display: none;"></div>

                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0"><i class="fas fa-list-ol"></i> Steps</h6>
                    <button class="btn btn-sm btn-outline-primary" id="add-step-btn">
                        <i class="fas fa-plus"></i> Add Step
                    </button>
                </div>

                <div id="steps-container">
                    <div class="text-center text-muted py-3">
                        No steps added yet. Click "Add Step" to begin.
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden div for compatibility (no longer used) -->
        <div id="execution-results" style="display: none;">
            <div id="execution-steps-results"></div>
        </div>
    </div>
</div>

<!-- Create MOP Modal -->
<div class="modal fade" id="createMopModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Create New Procedure</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-mop-form">
                    <div class="mb-3">
                        <label for="new-mop-name" class="form-label">Procedure Name *</label>
                        <input type="text" class="form-control" id="new-mop-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="new-mop-description" class="form-label">Description</label>
                        <textarea class="form-control" id="new-mop-description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="new-mop-devices" class="form-label">
                            <i class="fas fa-server"></i> Target Devices
                        </label>
                        <div class="input-group mb-2">
                            <select class="form-select" id="new-mop-device-dropdown">
                                <option value="">Select a device...</option>
                            </select>
                            <button class="btn btn-outline-primary" type="button" id="add-new-mop-device-btn">
                                <i class="fas fa-plus"></i> Add
                            </button>
                        </div>
                        <div id="new-mop-devices-list" class="border rounded p-2" style="min-height: 80px; max-height: 150px; overflow-y: auto;">
                            <small class="text-muted">No devices added yet</small>
                        </div>
                        <small class="form-text text-muted">Add devices to this procedure.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-create-mop-btn">
                    <i class="fas fa-plus"></i> Create
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add Step Modal -->
<div class="modal fade" id="addStepModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus"></i> <span id="step-modal-title">Add Step</span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-step-id">
                <input type="hidden" id="edit-step-order">

                <div class="mb-3">
                    <label for="step-name" class="form-label">Step Name *</label>
                    <input type="text" class="form-control" id="step-name" placeholder="e.g., Check BGP Status" required>
                </div>

                <div class="mb-3">
                    <label for="step-type" class="form-label">Step Type *</label>
                    <select class="form-select" id="step-type" required>
                        <option value="">Select type...</option>
                        <option value="getconfig">Get Config - Retrieve command output</option>
                        <option value="setconfig">Set Config - Push configuration commands</option>
                        <option value="template">Push Template - Deploy Jinja2 template</option>
                        <option value="deploy_stack">Deploy Stack - Deploy a service stack</option>
                        <option value="api">API Call - Call external API</option>
                        <option value="code">Code/Script - Process data with Python</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label for="step-devices" class="form-label">Target Devices *</label>
                    <div class="btn-group btn-group-sm mb-2 w-100" role="group">
                        <input type="radio" class="btn-check" name="device-mode" id="device-mode-select" checked autocomplete="off">
                        <label class="btn btn-outline-primary" for="device-mode-select">
                            <i class="fas fa-list"></i> Select Devices
                        </label>
                        <input type="radio" class="btn-check" name="device-mode" id="device-mode-variable" autocomplete="off">
                        <label class="btn btn-outline-primary" for="device-mode-variable">
                            <i class="fas fa-code"></i> Use Variable
                        </label>
                    </div>
                    <select class="form-select" id="step-devices" multiple size="8" required>
                        <option value="">Loading devices...</option>
                    </select>
                    <input type="text" class="form-control" id="step-devices-variable" placeholder="{{devices}}" style="display:none;">
                    <small class="form-text text-muted" id="device-select-help">Hold Ctrl/Cmd to select multiple devices</small>
                    <small class="form-text text-muted" id="device-variable-help" style="display:none;">
                        Use <code>{{'{{'}}variable{{'}}'}}</code> syntax. You'll be prompted to select devices at runtime.
                    </small>
                </div>

                <!-- Variable Reference Helper -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-info w-100" type="button" data-bs-toggle="collapse" data-bs-target="#variableHelperCollapse">
                        <i class="fas fa-question-circle"></i> Variable Reference Guide
                    </button>
                    <div class="collapse mt-2" id="variableHelperCollapse">
                        <div class="card card-body small">
                            <h6><i class="fas fa-info-circle"></i> Understanding MOP Variables</h6>

                            <div class="mb-3">
                                <strong>Device-Centric Structure:</strong>
                                <p class="mb-1">All data is organized by device name first, then by step:</p>
                                <code>mop.devices.DEVICE_NAME.stepX.output</code>
                            </div>

                            <div class="mb-3">
                                <strong>Available Variables:</strong>
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Variable</th>
                                            <th>Description</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td><code>{{'{{'}}mop.devices.DEVICE_NAME.name{{'}}'}}</code></td>
                                            <td>Device name</td>
                                        </tr>
                                        <tr>
                                            <td><code>{{'{{'}}mop.devices.DEVICE_NAME.site{{'}}'}}</code></td>
                                            <td>Device site/location</td>
                                        </tr>
                                        <tr>
                                            <td><code>{{'{{'}}mop.devices.DEVICE_NAME.ip_address{{'}}'}}</code></td>
                                            <td>Device IP address</td>
                                        </tr>
                                        <tr>
                                            <td><code>{{'{{'}}mop.devices.DEVICE_NAME.device_type{{'}}'}}</code></td>
                                            <td>Device type/model</td>
                                        </tr>
                                        <tr>
                                            <td><code>{{'{{'}}mop.devices.DEVICE_NAME.step0.output{{'}}'}}</code></td>
                                            <td>Output from step 0 for this device</td>
                                        </tr>
                                        <tr>
                                            <td><code>{{'{{'}}mop.devices.DEVICE_NAME.step0.status{{'}}'}}</code></td>
                                            <td>Status of step 0 for this device</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <div class="mb-3">
                                <strong>Step Outputs:</strong>
                                <ul class="mb-1">
                                    <li><strong>GetConfig/SetConfig/Template:</strong> Runs per-device, stores output at <code>mop.devices.DEVICE_NAME.stepX.output</code></li>
                                    <li><strong>API:</strong> Runs once for entire MOP, stores result at <code>stepX.result</code></li>
                                    <li><strong>Code:</strong> Runs once, can access all devices via <code>mop['devices']</code>, stores result at <code>stepX.result</code></li>
                                </ul>
                            </div>

                            <div class="alert alert-warning mb-2">
                                <strong><i class="fas fa-exclamation-triangle"></i> Important:</strong> Replace <code>DEVICE_NAME</code> with the actual device name (e.g., <code>router01</code>).
                                You must know the device name to reference it in API/Code steps.
                            </div>

                            <div>
                                <strong>Code Step Example (Loop All Devices):</strong>
                                <pre class="bg-body-secondary p-2 rounded mb-0"><code># Loop through all devices selected in the MOP
for device_name, device in mop['devices'].items():
    output = device.get('step0', {}).get('output', '')
    site = device.get('site', '')
    print(f"{device_name} at {site}: {output}")

result = {'processed': True}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GetConfig Configuration -->
                <div id="getconfig-config" style="display: none;">
                    <h6 class="border-top pt-3">Get Config Options</h6>
                    <div class="mb-3">
                        <label for="getconfig-command" class="form-label">Command *</label>
                        <input type="text" class="form-control" id="getconfig-command" placeholder="show running-config">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="getconfig-cache">
                        <label class="form-check-label" for="getconfig-cache">Enable Cache</label>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="getconfig-textfsm">
                        <label class="form-check-label" for="getconfig-textfsm">Use TextFSM</label>
                    </div>
                </div>

                <!-- SetConfig Configuration -->
                <div id="setconfig-config" style="display: none;">
                    <h6 class="border-top pt-3">Set Config Options</h6>
                    <div class="mb-3">
                        <label for="setconfig-commands" class="form-label">Configuration Commands *</label>
                        <textarea class="form-control font-monospace" id="setconfig-commands" rows="8" placeholder="interface GigabitEthernet0/1&#10;  description Configured via MOP&#10;  no shutdown"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="setconfig-dryrun">
                        <label class="form-check-label" for="setconfig-dryrun">Dry Run (validate only)</label>
                    </div>
                </div>

                <!-- Template Configuration -->
                <div id="template-config" style="display: none;">
                    <h6 class="border-top pt-3">Template Options</h6>
                    <div class="mb-3">
                        <label for="template-select" class="form-label">Select Template *</label>
                        <select class="form-select" id="template-select">
                            <option value="">Loading templates...</option>
                        </select>
                    </div>
                    <div id="template-vars-container"></div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="template-dryrun">
                        <label class="form-check-label" for="template-dryrun">Dry Run (validate only)</label>
                    </div>
                </div>

                <!-- Deploy Stack Configuration -->
                <div id="deploy-stack-config" style="display: none;">
                    <h6 class="border-top pt-3">Deploy Stack Options</h6>
                    <div class="alert alert-info small">
                        <i class="fas fa-info-circle"></i> Deploy an existing service stack. The stack must be created beforehand in the Service Stacks page.
                    </div>
                    <div class="mb-3">
                        <label for="stack-select" class="form-label">Select Service Stack *</label>
                        <select class="form-select" id="stack-select">
                            <option value="">Loading stacks...</option>
                        </select>
                        <small class="form-text text-muted">Choose a service stack to deploy</small>
                    </div>
                    <div id="stack-info-container" style="display:none;">
                        <div class="alert alert-secondary small">
                            <strong>Stack Details:</strong>
                            <div id="stack-info-details"></div>
                        </div>
                    </div>
                </div>

                <!-- API Call Configuration -->
                <div id="api-config" style="display: none;">
                    <h6 class="border-top pt-3">API Call Options</h6>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Simple Variable Reference:</strong>
                        <ul class="mb-0 mt-2 small">
                            <li><code>{{'{{'}}step0.output{{'}}'}}</code> - Output from step 0 (when using "For Each")</li>
                            <li><code>{{'{{'}}step0.devices.router1.output{{'}}'}}</code> - Specific device output</li>
                            <li><code>{{'{{'}}step1.result{{'}}'}}</code> - Result from a code step</li>
                        </ul>
                    </div>

                    <!-- API Resource Selector -->
                    <div class="mb-3">
                        <label for="api-resource" class="form-label">
                            <i class="fas fa-plug"></i> API Resource *
                            <a href="/settings" target="_blank" class="text-decoration-none small ms-2">
                                <i class="fas fa-cog"></i> Manage Resources
                            </a>
                        </label>
                        <select class="form-select" id="api-resource" required>
                            <option value="">-- Select an API Resource --</option>
                        </select>
                        <small class="form-text text-muted">Select a saved API resource (URL, auth configured in Settings)</small>
                    </div>

                    <!-- Resource Info Display -->
                    <div class="mb-3" id="api-resource-info" style="display:none;">
                        <div class="alert alert-secondary small mb-0">
                            <strong>Base URL:</strong> <span id="resource-base-url"></span><br>
                            <strong>Auth:</strong> <span id="resource-auth-type"></span>
                        </div>
                    </div>

                    <!-- Endpoint Path -->
                    <div class="mb-3">
                        <label for="api-endpoint" class="form-label">Endpoint Path *</label>
                        <input type="text" class="form-control" id="api-endpoint" placeholder="/api/devices/{{device}}" required>
                        <small class="form-text text-muted">
                            Path to append to the resource base URL<br>
                            <i class="fas fa-lightbulb text-warning"></i> <strong>Tip:</strong> Use <code>{{'{{'}}variable{{'}}'}}</code> for substitution from previous steps
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="api-method" class="form-label">HTTP Method</label>
                        <select class="form-select" id="api-method">
                            <option value="GET">GET</option>
                            <option value="POST">POST</option>
                            <option value="PUT">PUT</option>
                            <option value="DELETE">DELETE</option>
                            <option value="PATCH">PATCH</option>
                        </select>
                    </div>

                    <!-- Request Body (shown for POST/PUT/PATCH) -->
                    <div class="mb-3" id="api-body-group">
                        <label for="api-body" class="form-label">Request Body (JSON)</label>
                        <textarea class="form-control font-monospace" id="api-body" rows="6" placeholder='{"name": "{{device}}", "data": "{{step0_router1_output}}"}'></textarea>
                        <small class="form-text text-muted">
                            JSON body to send with POST/PUT/PATCH requests<br>
                            <i class="fas fa-lightbulb text-warning"></i> <strong>Tip:</strong> Use <code>{{'{{'}}variable{{'}}'}}</code> for dynamic substitution
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="api-jsonpath" class="form-label">JSONPath (Optional)</label>
                        <input type="text" class="form-control" id="api-jsonpath" placeholder="$.data.ip_address">
                        <small class="form-text text-muted">Path to extract specific value from API response (e.g., $.data.ip_address)</small>
                    </div>

                    <!-- Test API Section -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0"><strong>Test API Configuration</strong></label>
                        </div>

                        <!-- Test variable values -->
                        <div class="mb-2" id="mop-test-variables-container" style="display:none;">
                            <label class="form-label small">Test Variable Values</label>
                            <div id="mop-test-variables-inputs"></div>
                        </div>

                        <button type="button" class="btn btn-sm btn-primary w-100" id="mop-test-api-btn">
                            <i class="fas fa-flask"></i> Test API Call
                        </button>

                        <div id="mop-api-test-result" class="mt-2" style="display:none;">
                            <!-- Test results will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- Code/Script Configuration -->
                <div id="code-config" style="display: none;">
                    <h6 class="border-top pt-3">Code/Script Options</h6>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> <strong>Device-centric access:</strong>
                        <ul class="mb-0 mt-2 small">
                            <li><code>mop['devices']['router01']['step0']['output']</code> - Specific device step output</li>
                            <li><code>mop['devices']['router01']['site']</code> - Device metadata (site, ip_address, etc.)</li>
                            <li><code>for device in mop['devices'].values():</code> - Loop through all devices</li>
                        </ul>
                    </div>
                    <div class="mb-3">
                        <label for="code-script" class="form-label">Python Code *</label>
                        <textarea class="form-control font-monospace" id="code-script" rows="12" placeholder="# Example: Extract hostname from each device&#10;hostnames = {}&#10;for device_name, device in mop['devices'].items():&#10;    output = str(device.get('step0', {}).get('output', ''))&#10;    # Parse hostname&#10;    import re&#10;    match = re.search(r'hostname (\S+)', output)&#10;    hostnames[device_name] = match.group(1) if match else 'unknown'&#10;&#10;result = {'hostnames': hostnames}"></textarea>
                        <small class="form-text text-muted">Store output in <code>result</code> dict. Available: mop, json, re modules</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-add-step-btn">
                    <i class="fas fa-check"></i> <span id="step-confirm-text">Add Step</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Execute MOP Variables Modal -->
<div class="modal fade" id="executeMopModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-play"></i> Execute Procedure</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Provide runtime variables for this execution
                </div>

                <div id="execution-variables-container">
                    <!-- Variables will be dynamically added here -->
                </div>

                <div id="no-variables-message" style="display: none;">
                    <p class="text-muted">No variables detected in this procedure. Click Execute to run.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirm-execute-mop-btn">
                    <i class="fas fa-play"></i> Execute
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Execution Details Modal -->
<div class="modal fade" id="executionDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-info-circle"></i> Step Execution Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="execution-detail-content" class="p-3 border rounded bg-body-secondary" style="max-height: 600px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copy-result-btn">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/mop.js') }}"></script>
{% endblock %}
