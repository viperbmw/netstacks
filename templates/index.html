{% extends "base.html" %}

{% block title %}Dashboard - NetStacks{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-tachometer-alt"></i> NetStacks Dashboard
        </h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <a href="/workers" class="text-decoration-none">
            <div class="card text-white bg-primary dashboard-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Celery Workers</h5>
                            <h2 id="worker-count">-</h2>
                        </div>
                        <div>
                            <i class="fas fa-cogs fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/devices" class="text-decoration-none">
            <div class="card text-white bg-success dashboard-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Devices</h5>
                            <h2 id="device-count">-</h2>
                        </div>
                        <div>
                            <i class="fas fa-server fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/monitor" class="text-decoration-none">
            <div class="card text-white bg-warning dashboard-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Queued Jobs</h5>
                            <h2 id="queued-count">-</h2>
                        </div>
                        <div>
                            <i class="fas fa-clock fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/monitor" class="text-decoration-none">
            <div class="card text-white bg-info dashboard-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title">Running Jobs</h5>
                            <h2 id="running-count">-</h2>
                        </div>
                        <div>
                            <i class="fas fa-play-circle fa-3x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Service Stacks Summary -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-layer-group"></i> Service Stacks</h5>
                    <a href="/service-stacks" class="btn btn-sm btn-light">
                        <i class="fas fa-plus"></i> Manage Stacks
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div id="service-stacks-loading" class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="service-stacks-container" style="display: none;">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="total-stacks-count">0</h3>
                                    <small class="text-muted">Total Deployed Stacks</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="active-deployments-count">0</h3>
                                    <small class="text-muted">Fully Deployed</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="scheduled-stacks-count">0</h3>
                                    <small class="text-muted">Scheduled Stacks</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-secondary">
                                <div class="card-body text-center">
                                    <h3 class="mb-0" id="total-services-count">0</h3>
                                    <small class="text-muted">Deployed Services</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Stack Name</th>
                                    <th>Services</th>
                                    <th>State</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="service-stacks-body">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="no-service-stacks" style="display: none;" class="text-center text-muted">
                    <i class="fas fa-layer-group fa-3x mb-3 opacity-25"></i>
                    <p>No deployed service stacks yet</p>
                    <a href="/service-stacks" class="btn btn-sm btn-primary">
                        <i class="fas fa-plus"></i> Deploy Your First Stack
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scheduled Tasks Panels -->
<div class="row mb-4">
    <!-- Upcoming Scheduled Operations -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-clock"></i> Upcoming Scheduled Operations</h5>
            </div>
            <div class="card-body">
                <div id="scheduled-tasks-loading" class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="scheduled-tasks-container" style="display: none;">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Operation</th>
                                    <th>Next Run</th>
                                    <th>Target</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="scheduled-tasks-body">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="no-scheduled-tasks" style="display: none;" class="text-center text-muted">
                    <p>No scheduled operations configured</p>
                </div>
            </div>
            <div class="card-footer">
                <a href="/service-stacks" class="text-decoration-none">
                    Manage Service Stacks <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Completed Scheduled Operations -->
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-check-circle"></i> Completed Scheduled Operations</h5>
            </div>
            <div class="card-body">
                <div id="completed-schedules-loading" class="text-center">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="completed-schedules-container" style="display: none;">
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Operation</th>
                                    <th>Last Run</th>
                                    <th>Count</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="completed-schedules-body"></tbody>
                        </table>
                    </div>
                </div>
                <div id="no-completed-schedules" style="display: none;" class="text-center text-muted">
                    <p>No completed scheduled operations yet</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tasks"></i> Recent Tasks</h5>
                    <div class="input-group input-group-sm" style="width: 250px;">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="task-search" placeholder="Search devices...">
                        <button class="btn btn-outline-secondary" type="button" id="task-search-clear" title="Clear search">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div id="recent-tasks-loading" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="recent-tasks-container" style="display: none;">
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Device</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                </tr>
                            </thead>
                            <tbody id="recent-tasks-body">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="no-tasks-found" style="display: none;" class="text-center text-muted">
                    <p>No tasks found matching your search</p>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-server"></i> Devices</h5>
            </div>
            <div class="card-body">
                <div id="devices-list-loading" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="devices-list-container" style="display: none; max-height: 400px; overflow-y: auto;">
                    <div class="list-group" id="devices-list-body">
                    </div>
                </div>
            </div>
            <div class="card-footer">
                <a href="/devices" class="text-decoration-none">
                    View All Devices <i class="fas fa-arrow-right"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Task Results Modal -->
<div class="modal fade" id="taskResultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-tasks"></i> Task Results</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="task-results-loading" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading task details...</p>
                </div>
                <div id="task-results-content" style="display: none;">
                    <!-- Task Info -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Task ID:</strong> <span id="task-result-id"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Device:</strong> <span id="task-result-device"></span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Status:</strong> <span id="task-result-status"></span>
                        </div>
                        <div class="col-md-6">
                            <strong>Created:</strong> <span id="task-result-created"></span>
                        </div>
                    </div>

                    <!-- Task Result -->
                    <div class="mt-3">
                        <strong>Result:</strong>
                        <pre id="task-result-output" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                    </div>
                </div>
                <div id="task-results-error" style="display: none;" class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> <span id="task-error-message"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="/monitor" class="btn btn-primary">
                    <i class="fas fa-chart-line"></i> Go to Job Monitor
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Edit Schedule Modal -->
<div class="modal fade" id="editScheduleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Schedule</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-schedule-id">
                <form id="edit-schedule-form">
                    <div class="mb-3">
                        <label for="edit-schedule-type-select" class="form-label">Schedule Type *</label>
                        <select class="form-select" id="edit-schedule-type-select" required>
                            <option value="once">One-time</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>

                    <!-- One-time schedule -->
                    <div class="mb-3" id="edit-schedule-datetime-section" style="display: none;">
                        <label for="edit-schedule-datetime" class="form-label">Date and Time *</label>
                        <input type="datetime-local" class="form-control" id="edit-schedule-datetime">
                    </div>

                    <!-- Recurring schedule time -->
                    <div class="mb-3" id="edit-schedule-time-section" style="display: none;">
                        <label for="edit-schedule-time" class="form-label">Time *</label>
                        <input type="time" class="form-control" id="edit-schedule-time">
                    </div>

                    <!-- Weekly schedule day -->
                    <div class="mb-3" id="edit-schedule-day-week-section" style="display: none;">
                        <label for="edit-schedule-day-week" class="form-label">Day of Week *</label>
                        <select class="form-select" id="edit-schedule-day-week">
                            <option value="0">Monday</option>
                            <option value="1">Tuesday</option>
                            <option value="2">Wednesday</option>
                            <option value="3">Thursday</option>
                            <option value="4">Friday</option>
                            <option value="5">Saturday</option>
                            <option value="6">Sunday</option>
                        </select>
                    </div>

                    <!-- Monthly schedule day -->
                    <div class="mb-3" id="edit-schedule-day-month-section" style="display: none;">
                        <label for="edit-schedule-day-month" class="form-label">Day of Month *</label>
                        <input type="number" class="form-control" id="edit-schedule-day-month" min="1" max="31" placeholder="1-31">
                    </div>

                    <div class="mb-3">
                        <label for="edit-schedule-enabled" class="form-label">Status</label>
                        <select class="form-select" id="edit-schedule-enabled">
                            <option value="1">Enabled</option>
                            <option value="0">Disabled</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-schedule-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
