{% extends "base.html" %}

{% block title %}AI Agents - NetStacks{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="fas fa-robot"></i> AI Agents</h1>
                <p class="text-muted mb-0">Manage and monitor AI agents for network operations</p>
            </div>
            <div>
                <span class="badge bg-secondary me-2" id="last-refresh">Never</span>
                <button class="btn btn-outline-primary btn-sm" id="refresh-all-btn">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <a href="#" class="text-decoration-none stat-card-link" data-filter="active">
            <div class="card bg-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Active Agents</h6>
                            <h2 id="active-agents-count">0</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-circle-check fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="#" class="text-decoration-none stat-card-link" data-filter="all">
            <div class="card bg-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Agents</h6>
                            <h2 id="total-agents-count">0</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-robot fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/agents/chat" class="text-decoration-none">
            <div class="card bg-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Sessions Today</h6>
                            <h2 id="sessions-today">0</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-comments fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="/approvals" class="text-decoration-none">
            <div class="card bg-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Pending Approvals</h6>
                            <h2 id="pending-approvals">0</h2>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- Interactive Agent Workflow Diagram -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-project-diagram"></i> Agent Workflow Architecture</h5>
                <small class="text-muted">Click any agent for details | Watch handoffs in real-time</small>
            </div>
            <div class="card-body p-0" style="background: linear-gradient(135deg, #1a1d21 0%, #2d3238 100%);">
                <div id="workflow-diagram" style="width: 100%; height: 520px; position: relative; overflow: hidden;">
                    <svg id="workflow-svg" width="100%" height="100%" viewBox="0 0 1000 500">
                        <!-- Gradient definitions -->
                        <defs>
                            <linearGradient id="activeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="inactiveGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#6b7280;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4b5563;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="triageGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="bgpGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2563eb;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="ospfGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="isisGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#ec4899;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#db2777;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="generalGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#14b8a6;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#0d9488;stop-opacity:1" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <filter id="shadow">
                                <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
                            </filter>
                            <!-- Animated arrow marker -->
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" fill="#10b981">
                                <polygon points="0 0, 10 3.5, 0 7" />
                            </marker>
                            <marker id="arrowhead-gray" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto" fill="#6b7280">
                                <polygon points="0 0, 10 3.5, 0 7" />
                            </marker>
                        </defs>

                        <!-- Background grid -->
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#374151" stroke-width="0.5" opacity="0.3"/>
                        </pattern>
                        <rect width="100%" height="100%" fill="url(#grid)"/>

                        <!-- Input Sources (Left side) -->
                        <g id="input-sources" transform="translate(20, 80)">
                            <!-- Alert Webhook -->
                            <g class="input-node" data-source="alert">
                                <rect x="0" y="0" width="120" height="50" rx="6" fill="#1f2937" stroke="#ef4444" stroke-width="2"/>
                                <text x="60" y="20" text-anchor="middle" fill="#ef4444" font-size="11" font-weight="bold">
                                    <tspan class="fas">&#xf0f3;</tspan> Alerts
                                </text>
                                <text x="60" y="36" text-anchor="middle" fill="#9ca3af" font-size="9">Webhook Input</text>
                            </g>
                            <!-- User Chat -->
                            <g class="input-node" data-source="user" transform="translate(0, 70)">
                                <rect x="0" y="0" width="120" height="50" rx="6" fill="#1f2937" stroke="#3b82f6" stroke-width="2"/>
                                <text x="60" y="20" text-anchor="middle" fill="#3b82f6" font-size="11" font-weight="bold">
                                    <tspan class="fas">&#xf007;</tspan> User Chat
                                </text>
                                <text x="60" y="36" text-anchor="middle" fill="#9ca3af" font-size="9">NOC Operators</text>
                            </g>
                            <!-- Scheduled -->
                            <g class="input-node" data-source="scheduled" transform="translate(0, 140)">
                                <rect x="0" y="0" width="120" height="50" rx="6" fill="#1f2937" stroke="#8b5cf6" stroke-width="2"/>
                                <text x="60" y="20" text-anchor="middle" fill="#8b5cf6" font-size="11" font-weight="bold">
                                    <tspan class="fas">&#xf017;</tspan> Scheduled
                                </text>
                                <text x="60" y="36" text-anchor="middle" fill="#9ca3af" font-size="9">Automated Tasks</text>
                            </g>
                        </g>

                        <!-- Connection Lines from inputs to Triage -->
                        <g id="input-connections">
                            <path id="conn-alert-triage" class="workflow-line" d="M 140,105 Q 200,105 260,200" stroke="#6b7280" stroke-width="2" fill="none" marker-end="url(#arrowhead-gray)"/>
                            <path id="conn-user-triage" class="workflow-line" d="M 140,175 L 260,200" stroke="#6b7280" stroke-width="2" fill="none" marker-end="url(#arrowhead-gray)"/>
                            <path id="conn-scheduled-triage" class="workflow-line" d="M 140,245 Q 200,245 260,200" stroke="#6b7280" stroke-width="2" fill="none" marker-end="url(#arrowhead-gray)"/>
                        </g>

                        <!-- Triage Agent (Center) -->
                        <g id="node-triage" class="agent-node" data-agent-type="triage" transform="translate(260, 140)">
                            <rect x="0" y="0" width="180" height="120" rx="10" fill="url(#inactiveGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="180" height="120" rx="10" fill="none" stroke="#8b5cf6" stroke-width="3" class="node-border"/>
                            <text x="90" y="30" text-anchor="middle" fill="white" font-weight="bold" font-size="15">
                                <tspan class="fas">&#xf0e8;</tspan> Triage Agent
                            </text>
                            <text x="90" y="50" text-anchor="middle" fill="#d1d5db" font-size="10">Initial Issue Assessment</text>
                            <line x1="20" y1="65" x2="160" y2="65" stroke="#4b5563" stroke-width="1"/>
                            <text x="90" y="82" text-anchor="middle" fill="#9ca3af" font-size="9">Routes to specialists based on</text>
                            <text x="90" y="95" text-anchor="middle" fill="#9ca3af" font-size="9">issue classification</text>
                            <circle cx="160" cy="15" r="10" fill="#6b7280" class="status-indicator" id="triage-status"/>
                            <text x="160" y="19" text-anchor="middle" fill="white" font-size="8" id="triage-count">0</text>
                        </g>

                        <!-- Handoff Connections -->
                        <g id="handoff-connections">
                            <!-- Triage to BGP -->
                            <path id="conn-triage-bgp" class="handoff-line" d="M 440,170 Q 500,120 560,120" stroke="#6b7280" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowhead-gray)"/>
                            <text x="485" y="125" fill="#6b7280" font-size="8" class="handoff-label">BGP Issue</text>

                            <!-- Triage to OSPF -->
                            <path id="conn-triage-ospf" class="handoff-line" d="M 440,200 L 560,200" stroke="#6b7280" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowhead-gray)"/>
                            <text x="485" y="192" fill="#6b7280" font-size="8" class="handoff-label">OSPF Issue</text>

                            <!-- Triage to ISIS -->
                            <path id="conn-triage-isis" class="handoff-line" d="M 440,230 Q 500,280 560,280" stroke="#6b7280" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowhead-gray)"/>
                            <text x="485" y="270" fill="#6b7280" font-size="8" class="handoff-label">IS-IS Issue</text>

                            <!-- Triage to General -->
                            <path id="conn-triage-general" class="handoff-line" d="M 440,250 Q 500,350 560,360" stroke="#6b7280" stroke-width="2" fill="none" stroke-dasharray="5,5" marker-end="url(#arrowhead-gray)"/>
                            <text x="485" y="330" fill="#6b7280" font-size="8" class="handoff-label">Other</text>
                        </g>

                        <!-- Specialist Agents (Right side) -->
                        <!-- BGP Agent -->
                        <g id="node-bgp" class="agent-node" data-agent-type="bgp" transform="translate(560, 70)">
                            <rect x="0" y="0" width="160" height="100" rx="8" fill="url(#inactiveGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="160" height="100" rx="8" fill="none" stroke="#3b82f6" stroke-width="2" class="node-border"/>
                            <text x="80" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="13">
                                <tspan class="fas">&#xf0ec;</tspan> BGP Specialist
                            </text>
                            <text x="80" y="45" text-anchor="middle" fill="#d1d5db" font-size="9">Border Gateway Protocol</text>
                            <text x="80" y="62" text-anchor="middle" fill="#9ca3af" font-size="8">Neighbor states, AS-PATH</text>
                            <text x="80" y="75" text-anchor="middle" fill="#9ca3af" font-size="8">Route filtering, Communities</text>
                            <circle cx="140" cy="12" r="8" fill="#6b7280" class="status-indicator" id="bgp-status"/>
                            <text x="140" y="15" text-anchor="middle" fill="white" font-size="7" id="bgp-count">0</text>
                        </g>

                        <!-- OSPF Agent -->
                        <g id="node-ospf" class="agent-node" data-agent-type="ospf" transform="translate(560, 180)">
                            <rect x="0" y="0" width="160" height="100" rx="8" fill="url(#inactiveGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="160" height="100" rx="8" fill="none" stroke="#f59e0b" stroke-width="2" class="node-border"/>
                            <text x="80" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="13">
                                <tspan class="fas">&#xf126;</tspan> OSPF Specialist
                            </text>
                            <text x="80" y="45" text-anchor="middle" fill="#d1d5db" font-size="9">Open Shortest Path First</text>
                            <text x="80" y="62" text-anchor="middle" fill="#9ca3af" font-size="8">LSAs, Areas, DR/BDR</text>
                            <text x="80" y="75" text-anchor="middle" fill="#9ca3af" font-size="8">SPF calculation, Adjacency</text>
                            <circle cx="140" cy="12" r="8" fill="#6b7280" class="status-indicator" id="ospf-status"/>
                            <text x="140" y="15" text-anchor="middle" fill="white" font-size="7" id="ospf-count">0</text>
                        </g>

                        <!-- ISIS Agent -->
                        <g id="node-isis" class="agent-node" data-agent-type="isis" transform="translate(560, 290)">
                            <rect x="0" y="0" width="160" height="100" rx="8" fill="url(#inactiveGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="160" height="100" rx="8" fill="none" stroke="#ec4899" stroke-width="2" class="node-border"/>
                            <text x="80" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="13">
                                <tspan class="fas">&#xf126;</tspan> IS-IS Specialist
                            </text>
                            <text x="80" y="45" text-anchor="middle" fill="#d1d5db" font-size="9">Intermediate System</text>
                            <text x="80" y="62" text-anchor="middle" fill="#9ca3af" font-size="8">Levels, NET addresses</text>
                            <text x="80" y="75" text-anchor="middle" fill="#9ca3af" font-size="8">LSP, CSNP/PSNP</text>
                            <circle cx="140" cy="12" r="8" fill="#6b7280" class="status-indicator" id="isis-status"/>
                            <text x="140" y="15" text-anchor="middle" fill="white" font-size="7" id="isis-count">0</text>
                        </g>

                        <!-- General Agent -->
                        <g id="node-general" class="agent-node" data-agent-type="general" transform="translate(560, 400)">
                            <rect x="0" y="0" width="160" height="80" rx="8" fill="url(#inactiveGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="160" height="80" rx="8" fill="none" stroke="#14b8a6" stroke-width="2" class="node-border"/>
                            <text x="80" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="13">
                                <tspan class="fas">&#xf085;</tspan> General Agent
                            </text>
                            <text x="80" y="45" text-anchor="middle" fill="#d1d5db" font-size="9">Catch-all Specialist</text>
                            <text x="80" y="62" text-anchor="middle" fill="#9ca3af" font-size="8">Layer 2, Config, Other</text>
                            <circle cx="140" cy="12" r="8" fill="#6b7280" class="status-indicator" id="general-status"/>
                            <text x="140" y="15" text-anchor="middle" fill="white" font-size="7" id="general-count">0</text>
                        </g>

                        <!-- Output Actions (Far Right) -->
                        <g id="output-actions" transform="translate(780, 120)">
                            <!-- Device Commands -->
                            <g class="output-node" transform="translate(0, 0)">
                                <rect x="0" y="0" width="140" height="45" rx="6" fill="#1f2937" stroke="#10b981" stroke-width="2"/>
                                <text x="70" y="18" text-anchor="middle" fill="#10b981" font-size="10" font-weight="bold">
                                    <tspan class="fas">&#xf233;</tspan> Device Commands
                                </text>
                                <text x="70" y="33" text-anchor="middle" fill="#9ca3af" font-size="8">show/config</text>
                            </g>
                            <!-- Knowledge Search -->
                            <g class="output-node" transform="translate(0, 55)">
                                <rect x="0" y="0" width="140" height="45" rx="6" fill="#1f2937" stroke="#06b6d4" stroke-width="2"/>
                                <text x="70" y="18" text-anchor="middle" fill="#06b6d4" font-size="10" font-weight="bold">
                                    <tspan class="fas">&#xf02d;</tspan> Knowledge Base
                                </text>
                                <text x="70" y="33" text-anchor="middle" fill="#9ca3af" font-size="8">RAG Search</text>
                            </g>
                            <!-- Escalation -->
                            <g class="output-node" transform="translate(0, 110)">
                                <rect x="0" y="0" width="140" height="45" rx="6" fill="#1f2937" stroke="#f59e0b" stroke-width="2"/>
                                <text x="70" y="18" text-anchor="middle" fill="#f59e0b" font-size="10" font-weight="bold">
                                    <tspan class="fas">&#xf0a1;</tspan> Escalation
                                </text>
                                <text x="70" y="33" text-anchor="middle" fill="#9ca3af" font-size="8">Human NOC</text>
                            </g>
                            <!-- Incident Creation -->
                            <g class="output-node" transform="translate(0, 165)">
                                <rect x="0" y="0" width="140" height="45" rx="6" fill="#1f2937" stroke="#ef4444" stroke-width="2"/>
                                <text x="70" y="18" text-anchor="middle" fill="#ef4444" font-size="10" font-weight="bold">
                                    <tspan class="fas">&#xf071;</tspan> Incidents
                                </text>
                                <text x="70" y="33" text-anchor="middle" fill="#9ca3af" font-size="8">Create/Update</text>
                            </g>
                        </g>

                        <!-- Connection lines from specialists to outputs -->
                        <g id="output-connections" opacity="0.4">
                            <path d="M 720,120 L 780,142" stroke="#10b981" stroke-width="1" fill="none"/>
                            <path d="M 720,230 L 780,142" stroke="#10b981" stroke-width="1" fill="none"/>
                            <path d="M 720,340 L 780,142" stroke="#10b981" stroke-width="1" fill="none"/>
                            <path d="M 720,440 L 780,142" stroke="#10b981" stroke-width="1" fill="none"/>
                        </g>

                        <!-- Live Activity Indicator -->
                        <g id="activity-indicator" transform="translate(430, 460)">
                            <rect x="0" y="0" width="140" height="30" rx="15" fill="#1f2937" stroke="#374151" stroke-width="1"/>
                            <circle cx="20" cy="15" r="5" fill="#6b7280" id="activity-dot"/>
                            <text x="75" y="19" text-anchor="middle" fill="#9ca3af" font-size="10" id="activity-text">Idle</text>
                        </g>

                        <!-- Legend -->
                        <g id="legend" transform="translate(20, 420)">
                            <text x="0" y="0" fill="#6b7280" font-size="9" font-weight="bold">LEGEND:</text>
                            <circle cx="10" cy="20" r="6" fill="#10b981"/>
                            <text x="25" y="24" fill="#9ca3af" font-size="9">Active Agent</text>
                            <circle cx="100" cy="20" r="6" fill="#6b7280"/>
                            <text x="115" y="24" fill="#9ca3af" font-size="9">Inactive</text>
                            <line x1="175" y1="20" x2="205" y2="20" stroke="#10b981" stroke-width="2"/>
                            <text x="215" y="24" fill="#9ca3af" font-size="9">Active Flow</text>
                        </g>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Cards Grid -->
<div class="row mb-4">
    <div class="col-12">
        <h5 class="text-muted mb-3"><i class="fas fa-cubes"></i> Agent Status</h5>
    </div>
</div>

<div class="row g-3" id="agent-cards">
    <!-- Triage Agent Card -->
    <div class="col-md-4 col-lg-2-4">
        <div class="card agent-card h-100" id="triage-card" data-agent-type="triage">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <span><i class="fas fa-sitemap text-purple"></i> Triage</span>
                <span class="badge bg-secondary agent-status-badge" id="triage-badge">--</span>
            </div>
            <div class="card-body py-2">
                <div class="row g-1 mb-2">
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Sessions</small>
                            <div class="fs-6" id="triage-sessions">0</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Handoffs</small>
                            <div class="fs-6" id="triage-handoffs">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer py-1">
                <button class="btn btn-sm btn-outline-primary w-100 chat-agent-btn" data-type="triage">
                    <i class="fas fa-comments"></i> Chat
                </button>
            </div>
        </div>
    </div>

    <!-- BGP Agent Card -->
    <div class="col-md-4 col-lg-2-4">
        <div class="card agent-card h-100" id="bgp-card" data-agent-type="bgp">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <span><i class="fas fa-exchange-alt text-info"></i> BGP</span>
                <span class="badge bg-secondary agent-status-badge" id="bgp-badge">--</span>
            </div>
            <div class="card-body py-2">
                <div class="row g-1 mb-2">
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Sessions</small>
                            <div class="fs-6" id="bgp-sessions">0</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Resolved</small>
                            <div class="fs-6" id="bgp-resolved">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer py-1">
                <button class="btn btn-sm btn-outline-primary w-100 chat-agent-btn" data-type="bgp">
                    <i class="fas fa-comments"></i> Chat
                </button>
            </div>
        </div>
    </div>

    <!-- OSPF Agent Card -->
    <div class="col-md-4 col-lg-2-4">
        <div class="card agent-card h-100" id="ospf-card" data-agent-type="ospf">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <span><i class="fas fa-code-branch text-warning"></i> OSPF</span>
                <span class="badge bg-secondary agent-status-badge" id="ospf-badge">--</span>
            </div>
            <div class="card-body py-2">
                <div class="row g-1 mb-2">
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Sessions</small>
                            <div class="fs-6" id="ospf-sessions">0</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Resolved</small>
                            <div class="fs-6" id="ospf-resolved">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer py-1">
                <button class="btn btn-sm btn-outline-primary w-100 chat-agent-btn" data-type="ospf">
                    <i class="fas fa-comments"></i> Chat
                </button>
            </div>
        </div>
    </div>

    <!-- IS-IS Agent Card -->
    <div class="col-md-4 col-lg-2-4">
        <div class="card agent-card h-100" id="isis-card" data-agent-type="isis">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <span><i class="fas fa-project-diagram text-pink"></i> IS-IS</span>
                <span class="badge bg-secondary agent-status-badge" id="isis-badge">--</span>
            </div>
            <div class="card-body py-2">
                <div class="row g-1 mb-2">
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Sessions</small>
                            <div class="fs-6" id="isis-sessions">0</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Resolved</small>
                            <div class="fs-6" id="isis-resolved">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer py-1">
                <button class="btn btn-sm btn-outline-primary w-100 chat-agent-btn" data-type="isis">
                    <i class="fas fa-comments"></i> Chat
                </button>
            </div>
        </div>
    </div>

    <!-- General Agent Card -->
    <div class="col-md-4 col-lg-2-4">
        <div class="card agent-card h-100" id="general-card" data-agent-type="general">
            <div class="card-header d-flex justify-content-between align-items-center py-2">
                <span><i class="fas fa-cogs text-teal"></i> General</span>
                <span class="badge bg-secondary agent-status-badge" id="general-badge">--</span>
            </div>
            <div class="card-body py-2">
                <div class="row g-1 mb-2">
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Sessions</small>
                            <div class="fs-6" id="general-sessions">0</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box-sm">
                            <small class="text-muted">Resolved</small>
                            <div class="fs-6" id="general-resolved">0</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-footer py-1">
                <button class="btn btn-sm btn-outline-primary w-100 chat-agent-btn" data-type="general">
                    <i class="fas fa-comments"></i> Chat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Agent Panel (collapsible) -->
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center py-2">
        <h6 class="mb-0">
            <i class="fas fa-plus-circle"></i> Create New Agent
        </h6>
        <button class="btn btn-sm btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#create-agent-panel">
            <i class="fas fa-chevron-down"></i>
        </button>
    </div>
    <div class="collapse" id="create-agent-panel">
        <div class="card-body py-2">
            <form id="create-agent-form">
                <div class="row">
                    <div class="col-md-2">
                        <label for="agent-name" class="form-label small mb-1">Agent Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control form-control-sm" id="agent-name" required>
                    </div>
                    <div class="col-md-2">
                        <label for="agent-type" class="form-label small mb-1">Agent Type <span class="text-danger">*</span></label>
                        <select class="form-control form-control-sm" id="agent-type" required>
                            <option value="">Select type...</option>
                            <option value="triage">Triage</option>
                            <option value="bgp">BGP Specialist</option>
                            <option value="ospf">OSPF Specialist</option>
                            <option value="isis">IS-IS Specialist</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="llm-provider" class="form-label small mb-1">LLM Provider</label>
                        <select class="form-control form-control-sm" id="llm-provider">
                            <option value="anthropic">Anthropic</option>
                            <option value="openrouter">OpenRouter</option>
                            <option value="openai">OpenAI</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="llm-model" class="form-label small mb-1">Model</label>
                        <input type="text" class="form-control form-control-sm" id="llm-model" placeholder="claude-3-5-sonnet-20241022">
                    </div>
                    <div class="col-md-3">
                        <label for="agent-description" class="form-label small mb-1">Description</label>
                        <input type="text" class="form-control form-control-sm" id="agent-description" placeholder="Optional description">
                    </div>
                    <div class="col-md-1 d-flex align-items-end">
                        <button type="submit" class="btn btn-sm btn-success w-100">
                            <i class="fas fa-save"></i> Create
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Agent List -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="fas fa-list"></i> All Agents</h5>
        <div class="d-flex gap-2">
            <input type="text" id="agent-search" class="form-control form-control-sm" placeholder="Search agents..." style="width: 200px;">
        </div>
    </div>
    <div class="card-body">
        <div id="agents-loading" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="agents-container" style="display: none;">
            <div class="table-responsive">
                <table class="table table-hover table-striped table-sm">
                    <thead class="sticky-top bg-body-tertiary">
                        <tr>
                            <th>Status</th>
                            <th>Name</th>
                            <th>Type</th>
                            <th>LLM Provider</th>
                            <th>Model</th>
                            <th>Sessions</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="agents-body">
                    </tbody>
                </table>
            </div>
        </div>
        <div id="agents-empty" class="text-center text-muted py-4" style="display: none;">
            <i class="fas fa-robot fa-3x mb-3"></i>
            <p>No agents configured. Create one to get started!</p>
        </div>
    </div>
</div>

<!-- Edit Agent Modal -->
<div class="modal fade" id="editAgentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Agent</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-agent-form">
                    <input type="hidden" id="edit-agent-id">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-agent-name" class="form-label">Agent Name</label>
                            <input type="text" class="form-control" id="edit-agent-name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-agent-type" class="form-label">Agent Type</label>
                            <select class="form-control" id="edit-agent-type" required>
                                <option value="triage">Triage</option>
                                <option value="bgp">BGP Specialist</option>
                                <option value="ospf">OSPF Specialist</option>
                                <option value="isis">IS-IS Specialist</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-llm-provider" class="form-label">LLM Provider</label>
                            <select class="form-control" id="edit-llm-provider">
                                <option value="anthropic">Anthropic</option>
                                <option value="openrouter">OpenRouter</option>
                                <option value="openai">OpenAI</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-llm-model" class="form-label">Model</label>
                            <input type="text" class="form-control" id="edit-llm-model">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="edit-temperature" class="form-label">Temperature</label>
                            <input type="number" class="form-control" id="edit-temperature" step="0.1" min="0" max="2" value="0.7">
                        </div>
                        <div class="col-md-4">
                            <label for="edit-max-tokens" class="form-label">Max Tokens</label>
                            <input type="number" class="form-control" id="edit-max-tokens" value="4096">
                        </div>
                        <div class="col-md-4">
                            <label for="edit-max-iterations" class="form-label">Max Iterations</label>
                            <input type="number" class="form-control" id="edit-max-iterations" value="10">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="edit-description" class="form-label">Description</label>
                        <textarea class="form-control" id="edit-description" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="edit-system-prompt" class="form-label">Custom System Prompt (optional)</label>
                        <textarea class="form-control font-monospace" id="edit-system-prompt" rows="4" placeholder="Leave blank to use default for agent type..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Enabled Tools</label>
                        <div id="edit-tools-list" class="row">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger me-auto" id="delete-agent-btn">
                    <i class="fas fa-trash"></i> Delete
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-agent-btn">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Agent Sessions Modal -->
<div class="modal fade" id="agentSessionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-history"></i> Session History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="sessions-loading" class="text-center">
                    <div class="spinner-border" role="status"></div>
                </div>
                <div id="sessions-container" style="display: none;">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Session ID</th>
                                <th>Status</th>
                                <th>Trigger</th>
                                <th>Started</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sessions-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Agent Details Modal -->
<div class="modal fade" id="agentDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="agentDetailsTitle">
                    <i class="fas fa-robot"></i> Agent Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="agentDetailsBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="modal-chat-btn">
                    <i class="fas fa-comments"></i> Start Chat
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.agent-card {
    transition: all 0.3s ease;
    border: 1px solid #374151;
}
.agent-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.agent-card.active {
    border-color: #10b981;
}
.agent-card.active .card-header {
    border-bottom-color: #10b981;
}
.agent-card.inactive {
    border-color: #6b7280;
    opacity: 0.7;
}
.metric-box-sm {
    background: rgba(55, 65, 81, 0.5);
    padding: 6px 8px;
    border-radius: 4px;
    text-align: center;
}
.agent-node {
    cursor: pointer;
}
.agent-node .node-bg {
    transition: filter 0.2s ease, opacity 0.2s ease;
}
.agent-node:hover .node-bg {
    filter: url(#glow) url(#shadow);
    opacity: 0.9;
}
.agent-node .node-border {
    transition: stroke-width 0.2s ease;
}
.agent-node:hover .node-border {
    stroke-width: 4;
}
.input-node, .output-node {
    cursor: default;
    opacity: 0.9;
}
.input-node:hover, .output-node:hover {
    opacity: 1;
}
.workflow-line {
    transition: stroke 0.3s ease, stroke-width 0.3s ease;
}
.workflow-line.active {
    stroke: #10b981;
    stroke-dasharray: none;
}
.handoff-line {
    transition: stroke 0.3s ease, stroke-width 0.3s ease, stroke-dasharray 0.3s ease;
}
.handoff-line.active {
    stroke: #10b981;
    stroke-dasharray: none;
    stroke-width: 3;
}
.handoff-label {
    transition: fill 0.3s ease;
}
.status-indicator.active {
    fill: #10b981;
    animation: pulse 2s infinite;
}
.status-indicator.processing {
    fill: #f59e0b;
    animation: pulse-fast 0.5s infinite;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
@keyframes pulse-fast {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}
.activity-dot.active {
    fill: #10b981;
    animation: pulse 1s infinite;
}
.activity-dot.processing {
    fill: #f59e0b;
    animation: pulse-fast 0.3s infinite;
}
.text-purple { color: #8b5cf6 !important; }
.text-pink { color: #ec4899 !important; }
.text-teal { color: #14b8a6 !important; }
.fa-spin-click {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
@media (min-width: 992px) {
    .col-lg-2-4 {
        flex: 0 0 auto;
        width: 20%;
    }
}
@keyframes flowAnimation {
    0% { stroke-dashoffset: 20; }
    100% { stroke-dashoffset: 0; }
}
.handoff-line.animating {
    stroke: #10b981;
    stroke-width: 3;
    stroke-dasharray: 10 5;
    animation: flowAnimation 0.5s linear infinite;
}
</style>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let agents = [];
    let currentAgentId = null;
    let agentDetailsModal;
    let agentTypeStats = {
        triage: { active: false, sessions: 0, handoffs: 0 },
        bgp: { active: false, sessions: 0, resolved: 0 },
        ospf: { active: false, sessions: 0, resolved: 0 },
        isis: { active: false, sessions: 0, resolved: 0 },
        general: { active: false, sessions: 0, resolved: 0 }
    };

    agentDetailsModal = new bootstrap.Modal(document.getElementById('agentDetailsModal'));

    document.querySelectorAll('.agent-node').forEach(node => {
        node.addEventListener('click', function() {
            const agentType = this.dataset.agentType;
            showAgentTypeDetails(agentType);
        });
    });

    function loadAgents() {
        $('#agents-loading').show();
        $('#agents-container').hide();
        $('#agents-empty').hide();

        const refreshIcon = document.getElementById('refresh-icon');
        if (refreshIcon) refreshIcon.classList.add('fa-spin-click');

        NetStacksAPI.ajax({
            url: '/agents/api/agents',
            method: 'GET',
            success: function(response) {
                agents = response.agents || [];
                renderAgents();
                updateStats();
                updateWorkflowDiagram();

                const now = new Date();
                document.getElementById('last-refresh').textContent = 'Updated: ' + now.toLocaleTimeString();

                if (refreshIcon) refreshIcon.classList.remove('fa-spin-click');
            },
            error: function(xhr) {
                console.error('Error loading agents:', xhr);
                showToast('Error loading agents', 'danger');
                if (refreshIcon) refreshIcon.classList.remove('fa-spin-click');
            }
        });
    }

    function renderAgents() {
        const $tbody = $('#agents-body');
        $tbody.empty();

        if (agents.length === 0) {
            $('#agents-loading').hide();
            $('#agents-container').hide();
            $('#agents-empty').show();
            return;
        }

        const searchTerm = $('#agent-search').val().toLowerCase();
        const filteredAgents = agents.filter(a =>
            a.agent_name.toLowerCase().includes(searchTerm) ||
            a.agent_type.toLowerCase().includes(searchTerm)
        );

        filteredAgents.forEach(function(agent) {
            const statusBadge = agent.is_active
                ? '<span class="badge bg-success"><i class="fas fa-circle"></i> Active</span>'
                : '<span class="badge bg-secondary"><i class="fas fa-circle"></i> Inactive</span>';

            $tbody.append(`
                <tr>
                    <td>${statusBadge}</td>
                    <td><strong>${escapeHtml(agent.agent_name)}</strong></td>
                    <td><span class="badge bg-info">${escapeHtml(agent.agent_type)}</span></td>
                    <td>${escapeHtml(agent.llm_provider || 'anthropic')}</td>
                    <td><code>${escapeHtml(agent.llm_model || 'default')}</code></td>
                    <td>${agent.session_count || 0}</td>
                    <td>${formatDate(agent.created_at)}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary chat-btn" data-id="${agent.agent_id}" title="Chat">
                                <i class="fas fa-comments"></i>
                            </button>
                            <button class="btn btn-outline-secondary edit-btn" data-id="${agent.agent_id}" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-${agent.is_active ? 'warning' : 'success'} toggle-btn" data-id="${agent.agent_id}" data-active="${agent.is_active}" title="${agent.is_active ? 'Deactivate' : 'Activate'}">
                                <i class="fas fa-${agent.is_active ? 'pause' : 'play'}"></i>
                            </button>
                            <button class="btn btn-outline-info sessions-btn" data-id="${agent.agent_id}" title="Sessions">
                                <i class="fas fa-history"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `);
        });

        $('#agents-loading').hide();
        $('#agents-container').show();
    }

    function updateStats() {
        const activeCount = agents.filter(a => a.is_active).length;
        $('#active-agents-count').text(activeCount);
        $('#total-agents-count').text(agents.length);

        Object.keys(agentTypeStats).forEach(type => {
            agentTypeStats[type] = { active: false, sessions: 0, handoffs: 0, resolved: 0 };
        });

        agents.forEach(agent => {
            const type = agent.agent_type;
            if (agentTypeStats[type]) {
                if (agent.is_active) agentTypeStats[type].active = true;
                agentTypeStats[type].sessions += agent.session_count || 0;
            }
        });

        Object.keys(agentTypeStats).forEach(type => {
            const stats = agentTypeStats[type];
            const card = document.getElementById(`${type}-card`);
            const badge = document.getElementById(`${type}-badge`);
            const sessionsEl = document.getElementById(`${type}-sessions`);

            if (card) {
                card.classList.remove('active', 'inactive');
                card.classList.add(stats.active ? 'active' : 'inactive');
            }
            if (badge) {
                badge.className = `badge ${stats.active ? 'bg-success' : 'bg-secondary'} agent-status-badge`;
                badge.textContent = stats.active ? 'Active' : 'Inactive';
            }
            if (sessionsEl) {
                sessionsEl.textContent = stats.sessions;
            }
        });

        // Fetch sessions today
        NetStacksAPI.ajax({
            url: '/agents/api/stats',
            method: 'GET',
            success: function(response) {
                $('#sessions-today').text(response.sessions_today || 0);
            }
        });

        // Fetch pending approvals (still using Flask route for now)
        $.ajax({
            url: '/approvals/api/approvals?status=pending',
            method: 'GET',
            success: function(response) {
                $('#pending-approvals').text(response.approvals ? response.approvals.length : 0);
            }
        });
    }

    function updateWorkflowDiagram() {
        Object.keys(agentTypeStats).forEach(type => {
            const stats = agentTypeStats[type];
            const nodeId = `node-${type}`;
            const node = document.getElementById(nodeId);

            if (node) {
                const bg = node.querySelector('.node-bg');
                const statusIndicator = document.getElementById(`${type}-status`);
                const countText = document.getElementById(`${type}-count`);

                if (bg) {
                    if (stats.active) {
                        bg.setAttribute('fill', `url(#${type}Gradient)`);
                    } else {
                        bg.setAttribute('fill', 'url(#inactiveGradient)');
                    }
                }

                if (statusIndicator) {
                    statusIndicator.classList.remove('active', 'processing');
                    if (stats.active) {
                        statusIndicator.classList.add('active');
                        statusIndicator.setAttribute('fill', '#10b981');
                    } else {
                        statusIndicator.setAttribute('fill', '#6b7280');
                    }
                }

                if (countText) {
                    countText.textContent = stats.sessions;
                }
            }
        });

        const triageActive = agentTypeStats.triage.active;
        ['bgp', 'ospf', 'isis', 'general'].forEach(type => {
            const line = document.getElementById(`conn-triage-${type}`);
            if (line) {
                line.classList.remove('active');
                if (triageActive && agentTypeStats[type].active) {
                    line.classList.add('active');
                    line.setAttribute('stroke', '#10b981');
                    line.setAttribute('marker-end', 'url(#arrowhead)');
                } else {
                    line.setAttribute('stroke', '#6b7280');
                    line.setAttribute('marker-end', 'url(#arrowhead-gray)');
                }
            }
        });

        const inputConnections = ['alert', 'user', 'scheduled'];
        inputConnections.forEach(input => {
            const line = document.getElementById(`conn-${input}-triage`);
            if (line) {
                if (triageActive) {
                    line.setAttribute('stroke', '#10b981');
                    line.setAttribute('marker-end', 'url(#arrowhead)');
                } else {
                    line.setAttribute('stroke', '#6b7280');
                    line.setAttribute('marker-end', 'url(#arrowhead-gray)');
                }
            }
        });

        const activityDot = document.getElementById('activity-dot');
        const activityText = document.getElementById('activity-text');
        const anyActive = Object.values(agentTypeStats).some(s => s.active);

        if (activityDot && activityText) {
            activityDot.classList.remove('active', 'processing');
            if (anyActive) {
                activityDot.classList.add('active');
                activityText.textContent = 'Ready';
            } else {
                activityText.textContent = 'Idle';
            }
        }
    }

    function showAgentTypeDetails(agentType) {
        const typeInfo = {
            triage: {
                title: 'Triage Agent',
                icon: 'fa-sitemap',
                color: '#8b5cf6',
                description: 'Initial issue assessment and routing agent. Analyzes incoming issues and hands off to appropriate specialist agents.',
                capabilities: ['Issue classification and categorization', 'Automatic handoff to specialist agents', 'Initial diagnostic data collection', 'Priority assessment']
            },
            bgp: {
                title: 'BGP Specialist',
                icon: 'fa-exchange-alt',
                color: '#3b82f6',
                description: 'Expert in Border Gateway Protocol troubleshooting and analysis.',
                capabilities: ['BGP neighbor state analysis', 'AS-PATH manipulation and filtering', 'Route propagation troubleshooting', 'BGP community analysis']
            },
            ospf: {
                title: 'OSPF Specialist',
                icon: 'fa-code-branch',
                color: '#f59e0b',
                description: 'Expert in OSPF routing protocol troubleshooting.',
                capabilities: ['OSPF neighbor adjacency analysis', 'LSA type analysis and LSDB issues', 'Area configuration troubleshooting', 'SPF calculation and convergence']
            },
            isis: {
                title: 'IS-IS Specialist',
                icon: 'fa-project-diagram',
                color: '#ec4899',
                description: 'Expert in IS-IS routing protocol troubleshooting.',
                capabilities: ['IS-IS adjacency troubleshooting', 'Level 1/2 routing issues', 'NET address configuration', 'LSP and CSNP/PSNP analysis']
            },
            general: {
                title: 'General Agent',
                icon: 'fa-cogs',
                color: '#14b8a6',
                description: 'Catch-all specialist for issues not covered by other agents.',
                capabilities: ['Layer 2 switching issues', 'General configuration problems', 'Multi-protocol issues', 'Device connectivity']
            }
        };

        const info = typeInfo[agentType];
        const stats = agentTypeStats[agentType];
        const agentsOfType = agents.filter(a => a.agent_type === agentType);

        document.getElementById('agentDetailsTitle').innerHTML = `
            <i class="fas ${info.icon}" style="color: ${info.color}"></i> ${info.title}
        `;

        let agentListHtml = '';
        if (agentsOfType.length > 0) {
            agentListHtml = `
                <h6 class="mt-4 mb-3"><i class="fas fa-robot"></i> Configured Agents</h6>
                <table class="table table-sm table-dark">
                    <thead><tr><th>Name</th><th>Status</th><th>LLM</th><th>Sessions</th></tr></thead>
                    <tbody>
                        ${agentsOfType.map(a => `
                            <tr>
                                <td>${escapeHtml(a.agent_name)}</td>
                                <td><span class="badge ${a.is_active ? 'bg-success' : 'bg-secondary'}">${a.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td><code>${escapeHtml(a.llm_model || 'default')}</code></td>
                                <td>${a.session_count || 0}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        } else {
            agentListHtml = `
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle"></i> No ${info.title} agents configured yet.
                    <button class="btn btn-sm btn-primary ms-3" onclick="$('#agent-type').val('${agentType}'); $('#create-agent-panel').collapse('show'); bootstrap.Modal.getInstance(document.getElementById('agentDetailsModal')).hide();">
                        Create One
                    </button>
                </div>
            `;
        }

        document.getElementById('agentDetailsBody').innerHTML = `
            <p class="text-muted">${info.description}</p>
            <div class="row g-3 mb-4">
                <div class="col-md-4">
                    <div class="card bg-dark">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Status</h6>
                            <span class="badge ${stats.active ? 'bg-success' : 'bg-secondary'} fs-5">${stats.active ? 'Active' : 'Inactive'}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Total Sessions</h6>
                            <span class="fs-5">${stats.sessions}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Agents</h6>
                            <span class="fs-5">${agentsOfType.length}</span>
                        </div>
                    </div>
                </div>
            </div>
            <h6 class="mb-3"><i class="fas fa-check-circle"></i> Capabilities</h6>
            <ul class="list-group list-group-flush mb-4">
                ${info.capabilities.map(cap => `
                    <li class="list-group-item bg-transparent text-light border-secondary">
                        <i class="fas fa-chevron-right text-muted me-2"></i>${cap}
                    </li>
                `).join('')}
            </ul>
            ${agentListHtml}
        `;

        document.getElementById('modal-chat-btn').onclick = function() {
            window.location.href = '/agents/chat';
        };

        agentDetailsModal.show();
    }

    $('#create-agent-form').on('submit', function(e) {
        e.preventDefault();

        const data = {
            agent_name: $('#agent-name').val(),
            agent_type: $('#agent-type').val(),
            llm_provider: $('#llm-provider').val(),
            llm_model: $('#llm-model').val() || null,
            description: $('#agent-description').val() || null
        };

        NetStacksAPI.ajax({
            url: '/agents/api/agents',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                showToast('Agent created successfully', 'success');
                $('#create-agent-form')[0].reset();
                loadAgents();
            },
            error: function(xhr) {
                showToast('Error creating agent: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
            }
        });
    });

    $(document).on('click', '.edit-btn', function() {
        const agentId = $(this).data('id');
        const agent = agents.find(a => a.agent_id === agentId);
        if (!agent) return;

        currentAgentId = agentId;
        $('#edit-agent-id').val(agentId);
        $('#edit-agent-name').val(agent.agent_name);
        $('#edit-agent-type').val(agent.agent_type);
        $('#edit-llm-provider').val(agent.llm_provider || 'anthropic');
        $('#edit-llm-model').val(agent.llm_model || '');
        $('#edit-temperature').val(agent.temperature || 0.7);
        $('#edit-max-tokens').val(agent.max_tokens || 4096);
        $('#edit-max-iterations').val(agent.max_iterations || 10);
        $('#edit-description').val(agent.description || '');
        $('#edit-system-prompt').val(agent.system_prompt || '');

        loadAvailableTools(agent.enabled_tools || []);

        new bootstrap.Modal($('#editAgentModal')).show();
    });

    function loadAvailableTools(enabledTools) {
        NetStacksAPI.ajax({
            url: '/agents/api/agents/tools',
            method: 'GET',
            success: function(response) {
                const $container = $('#edit-tools-list');
                $container.empty();

                (response.tools || []).forEach(function(tool) {
                    const isEnabled = enabledTools.includes(tool.name);
                    $container.append(`
                        <div class="col-md-4 mb-2">
                            <div class="form-check">
                                <input class="form-check-input tool-checkbox" type="checkbox"
                                       value="${tool.name}" id="tool-${tool.name}" ${isEnabled ? 'checked' : ''}>
                                <label class="form-check-label" for="tool-${tool.name}">
                                    ${escapeHtml(tool.name)}
                                </label>
                            </div>
                        </div>
                    `);
                });
            }
        });
    }

    $('#save-agent-btn').on('click', function() {
        const enabledTools = [];
        $('.tool-checkbox:checked').each(function() {
            enabledTools.push($(this).val());
        });

        const data = {
            agent_name: $('#edit-agent-name').val(),
            agent_type: $('#edit-agent-type').val(),
            llm_provider: $('#edit-llm-provider').val(),
            llm_model: $('#edit-llm-model').val() || null,
            temperature: parseFloat($('#edit-temperature').val()),
            max_tokens: parseInt($('#edit-max-tokens').val()),
            max_iterations: parseInt($('#edit-max-iterations').val()),
            description: $('#edit-description').val() || null,
            system_prompt: $('#edit-system-prompt').val() || null,
            enabled_tools: enabledTools
        };

        NetStacksAPI.ajax({
            url: `/api/agents/${currentAgentId}`,
            method: 'PATCH',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                showToast('Agent updated successfully', 'success');
                bootstrap.Modal.getInstance($('#editAgentModal')).hide();
                loadAgents();
            },
            error: function(xhr) {
                showToast('Error updating agent: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
            }
        });
    });

    $('#delete-agent-btn').on('click', function() {
        if (!confirm('Are you sure you want to delete this agent?')) return;

        NetStacksAPI.ajax({
            url: `/api/agents/${currentAgentId}`,
            method: 'DELETE',
            success: function(response) {
                showToast('Agent deleted successfully', 'success');
                bootstrap.Modal.getInstance($('#editAgentModal')).hide();
                loadAgents();
            },
            error: function(xhr) {
                showToast('Error deleting agent: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
            }
        });
    });

    $(document).on('click', '.toggle-btn', function() {
        const agentId = $(this).data('id');
        const isActive = $(this).data('active');

        NetStacksAPI.ajax({
            url: `/api/agents/${agentId}/toggle`,
            method: 'POST',
            success: function(response) {
                showToast(`Agent ${isActive ? 'deactivated' : 'activated'}`, 'success');
                loadAgents();
            },
            error: function(xhr) {
                showToast('Error toggling agent: ' + (xhr.responseJSON?.error || 'Unknown error'), 'danger');
            }
        });
    });

    $(document).on('click', '.chat-btn, .chat-agent-btn', function() {
        window.location.href = '/agents/chat';
    });

    $(document).on('click', '.sessions-btn', function() {
        const agentId = $(this).data('id');

        $('#sessions-loading').show();
        $('#sessions-container').hide();

        // Sessions are still handled by Flask for now (not in microservice)
        $.ajax({
            url: `/agents/api/agents/${agentId}/sessions`,
            method: 'GET',
            success: function(response) {
                const $tbody = $('#sessions-body');
                $tbody.empty();

                (response.sessions || []).forEach(function(session) {
                    $tbody.append(`
                        <tr>
                            <td><code>${session.session_id.substring(0, 8)}...</code></td>
                            <td><span class="badge bg-${session.status === 'active' ? 'success' : 'secondary'}">${session.status}</span></td>
                            <td>${session.trigger_type || 'user'}</td>
                            <td>${formatDate(session.created_at)}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-info view-session-btn" data-id="${session.session_id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });

                $('#sessions-loading').hide();
                $('#sessions-container').show();
            },
            error: function(xhr) {
                showToast('Error loading sessions', 'danger');
            }
        });

        new bootstrap.Modal($('#agentSessionsModal')).show();
    });

    $('#agent-search').on('input', function() {
        renderAgents();
    });

    $('#refresh-all-btn').on('click', loadAgents);

    $(document).on('click', '.stat-card-link', function(e) {
        e.preventDefault();
        const filter = $(this).data('filter');
        if (filter === 'active') {
            $('#agent-search').val('active');
        } else {
            $('#agent-search').val('');
        }
        renderAgents();
        $('html, body').animate({
            scrollTop: $('#agents-container').offset().top - 100
        }, 300);
    });

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatDate(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function showToast(message, type) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const $alert = $(`<div class="alert ${alertClass} alert-dismissible fade show position-fixed" style="top: 70px; right: 20px; z-index: 9999;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>`);
        $('body').append($alert);
        setTimeout(() => $alert.alert('close'), 3000);
    }

    loadAgents();

    setInterval(loadAgents, 30000);
});
</script>
{% endblock %}
