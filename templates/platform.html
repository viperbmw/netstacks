{% extends "base.html" %}

{% block title %}Platform Health - NetStacks{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h3><i class="fas fa-heartbeat text-primary"></i> Platform Health</h3>
            <div>
                <span class="badge bg-secondary me-2" id="last-refresh">Never</span>
                <button class="btn btn-outline-primary btn-sm" onclick="refreshHealth()">
                    <i class="fas fa-sync-alt" id="refresh-icon"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Overall Status Banner -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" id="overall-status-card">
            <div class="card-body d-flex align-items-center justify-content-between py-3">
                <div class="d-flex align-items-center">
                    <div id="overall-status-icon" class="me-3">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                    </div>
                    <div>
                        <h5 class="mb-0" id="overall-status-text">Checking services...</h5>
                        <small class="text-muted" id="services-summary">Initializing health checks</small>
                    </div>
                </div>
                <div class="d-flex gap-2" id="quick-stats">
                    <span class="badge bg-success fs-6" id="healthy-count">0 Healthy</span>
                    <span class="badge bg-danger fs-6" id="unhealthy-count">0 Unhealthy</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Platform Statistics Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Platform Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row" id="platform-stats">
                    <div class="col-md-2 col-sm-4 text-center mb-3">
                        <div class="h3 mb-0" id="stat-devices">-</div>
                        <small class="text-muted">Devices</small>
                    </div>
                    <div class="col-md-2 col-sm-4 text-center mb-3">
                        <div class="h3 mb-0" id="stat-templates">-</div>
                        <small class="text-muted">Templates</small>
                    </div>
                    <div class="col-md-2 col-sm-4 text-center mb-3">
                        <div class="h3 mb-0" id="stat-stacks">-</div>
                        <small class="text-muted">Stacks</small>
                    </div>
                    <div class="col-md-2 col-sm-4 text-center mb-3">
                        <div class="h3 mb-0" id="stat-incidents">-</div>
                        <small class="text-muted">Open Incidents</small>
                    </div>
                    <div class="col-md-2 col-sm-4 text-center mb-3">
                        <div class="h3 mb-0" id="stat-agents">-</div>
                        <small class="text-muted">Active Agents</small>
                    </div>
                    <div class="col-md-2 col-sm-4 text-center mb-3">
                        <div class="h3 mb-0" id="stat-backups">-</div>
                        <small class="text-muted">Recent Backups</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Interactive Architecture Diagram -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-project-diagram"></i> Architecture Overview</h5>
                <small class="text-muted">Click any component for details</small>
            </div>
            <div class="card-body p-0" style="background: linear-gradient(135deg, #1a1d21 0%, #2d3238 100%);">
                <div id="architecture-diagram" style="width: 100%; height: 500px; position: relative; overflow: hidden;">
                    <svg id="arch-svg" width="100%" height="100%" viewBox="0 0 900 480">
                        <!-- Gradient definitions -->
                        <defs>
                            <linearGradient id="healthyGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="unhealthyGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="unknownGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#6b7280;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#4b5563;stop-opacity:1" />
                            </linearGradient>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                            <filter id="shadow">
                                <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.3"/>
                            </filter>
                            <!-- Animated dash pattern -->
                            <pattern id="flowPattern" patternUnits="userSpaceOnUse" width="20" height="1">
                                <rect width="10" height="1" fill="#10b981" opacity="0.8">
                                    <animate attributeName="x" from="0" to="20" dur="1s" repeatCount="indefinite"/>
                                </rect>
                            </pattern>
                        </defs>

                        <!-- Background grid -->
                        <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                            <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#374151" stroke-width="0.5" opacity="0.3"/>
                        </pattern>
                        <rect width="100%" height="100%" fill="url(#grid)"/>

                        <!-- Connection Lines (drawn first, behind nodes) -->
                        <g id="connections">
                            <!-- Traefik to Services -->
                            <path id="conn-traefik-auth" class="connection-line" d="M 450,80 L 200,160" stroke="#4b5563" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                            <path id="conn-traefik-devices" class="connection-line" d="M 450,80 L 450,160" stroke="#4b5563" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                            <path id="conn-traefik-config" class="connection-line" d="M 450,80 L 700,160" stroke="#4b5563" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                            <path id="conn-traefik-ai" class="connection-line" d="M 550,80 L 700,300" stroke="#4b5563" stroke-width="2" fill="none" stroke-dasharray="5,5"/>

                            <!-- Services to Database -->
                            <path id="conn-auth-db" class="connection-line" d="M 200,230 L 350,320" stroke="#4b5563" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                            <path id="conn-devices-db" class="connection-line" d="M 450,230 L 450,320" stroke="#4b5563" stroke-width="2" fill="none" stroke-dasharray="5,5"/>
                            <path id="conn-config-db" class="connection-line" d="M 700,230 L 550,320" stroke="#4b5563" stroke-width="2" fill="none" stroke-dasharray="5,5"/>

                            <!-- Workers to Redis -->
                            <path id="conn-workers-redis" class="connection-line" d="M 250,420 L 450,420" stroke="#4b5563" stroke-width="3" fill="none" stroke-dasharray="5,5"/>

                            <!-- Devices to Workers (task dispatch) -->
                            <path id="conn-devices-workers" class="connection-line" d="M 450,230 L 150,380" stroke="#4b5563" stroke-width="2" fill="none" stroke-dasharray="5,5" opacity="0.6"/>
                        </g>

                        <!-- Traefik (Load Balancer) -->
                        <g id="node-traefik" class="service-node" data-service="traefik" transform="translate(350, 20)">
                            <rect x="0" y="0" width="200" height="60" rx="8" fill="url(#unknownGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="200" height="60" rx="8" fill="none" stroke="#06b6d4" stroke-width="2" class="node-border"/>
                            <text x="100" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="14">
                                <tspan class="fas">&#xf0e8;</tspan> Traefik
                            </text>
                            <text x="100" y="45" text-anchor="middle" fill="#9ca3af" font-size="11">Load Balancer - Port 80</text>
                        </g>

                        <!-- Auth Service -->
                        <g id="node-auth" class="service-node" data-service="auth" transform="translate(100, 160)">
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="url(#unknownGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="none" stroke="#8b5cf6" stroke-width="2" class="node-border"/>
                            <text x="100" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="14">
                                <tspan class="fas">&#xf084;</tspan> Auth Service
                            </text>
                            <text x="100" y="42" text-anchor="middle" fill="#9ca3af" font-size="10">JWT Authentication</text>
                            <text x="100" y="58" text-anchor="middle" fill="#9ca3af" font-size="10">Port 8011</text>
                            <circle cx="180" cy="10" r="8" fill="#6b7280" class="status-indicator"/>
                        </g>

                        <!-- Devices Service -->
                        <g id="node-devices" class="service-node" data-service="devices" transform="translate(350, 160)">
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="url(#unknownGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="none" stroke="#f59e0b" stroke-width="2" class="node-border"/>
                            <text x="100" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="14">
                                <tspan class="fas">&#xf233;</tspan> Devices Service
                            </text>
                            <text x="100" y="42" text-anchor="middle" fill="#9ca3af" font-size="10">Device Management</text>
                            <text x="100" y="58" text-anchor="middle" fill="#9ca3af" font-size="10">Port 8004</text>
                            <circle cx="180" cy="10" r="8" fill="#6b7280" class="status-indicator"/>
                        </g>

                        <!-- Config Service -->
                        <g id="node-config" class="service-node" data-service="config" transform="translate(600, 160)">
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="url(#unknownGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="none" stroke="#ec4899" stroke-width="2" class="node-border"/>
                            <text x="100" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="14">
                                <tspan class="fas">&#xf1c9;</tspan> Config Service
                            </text>
                            <text x="100" y="42" text-anchor="middle" fill="#9ca3af" font-size="10">Templates & MOPs</text>
                            <text x="100" y="58" text-anchor="middle" fill="#9ca3af" font-size="10">Port 8002</text>
                            <circle cx="180" cy="10" r="8" fill="#6b7280" class="status-indicator"/>
                        </g>

                        <!-- AI Service -->
                        <g id="node-ai" class="service-node" data-service="ai" transform="translate(600, 300)">
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="url(#unknownGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="none" stroke="#10b981" stroke-width="2" class="node-border"/>
                            <text x="100" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="14">
                                <tspan class="fas">&#xf544;</tspan> AI Service
                            </text>
                            <text x="100" y="42" text-anchor="middle" fill="#9ca3af" font-size="10">Agents & Alerts</text>
                            <text x="100" y="58" text-anchor="middle" fill="#9ca3af" font-size="10">Port 8003</text>
                            <circle cx="180" cy="10" r="8" fill="#6b7280" class="status-indicator"/>
                        </g>

                        <!-- PostgreSQL -->
                        <g id="node-postgres" class="service-node" data-service="postgres" transform="translate(350, 300)">
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="url(#unknownGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="none" stroke="#3b82f6" stroke-width="2" class="node-border"/>
                            <text x="100" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="14">
                                <tspan class="fas">&#xf1c0;</tspan> PostgreSQL
                            </text>
                            <text x="100" y="42" text-anchor="middle" fill="#9ca3af" font-size="10">Shared Database</text>
                            <text x="100" y="58" text-anchor="middle" fill="#9ca3af" font-size="10">Port 5432</text>
                            <circle cx="180" cy="10" r="8" fill="#6b7280" class="status-indicator"/>
                        </g>

                        <!-- Celery Workers -->
                        <g id="node-workers" class="service-node" data-service="workers" transform="translate(50, 380)">
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="url(#unknownGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="none" stroke="#14b8a6" stroke-width="2" class="node-border"/>
                            <text x="100" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="14">
                                <tspan class="fas">&#xf0ae;</tspan> Celery Workers
                            </text>
                            <text x="100" y="42" text-anchor="middle" fill="#9ca3af" font-size="10">Background Tasks</text>
                            <text x="100" y="58" text-anchor="middle" fill="#9ca3af" font-size="10" id="worker-count-text">Workers: --</text>
                            <circle cx="180" cy="10" r="8" fill="#6b7280" class="status-indicator"/>
                        </g>

                        <!-- Redis -->
                        <g id="node-redis" class="service-node" data-service="redis" transform="translate(350, 380)">
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="url(#unknownGradient)" filter="url(#shadow)" class="node-bg"/>
                            <rect x="0" y="0" width="200" height="70" rx="8" fill="none" stroke="#ef4444" stroke-width="2" class="node-border"/>
                            <text x="100" y="25" text-anchor="middle" fill="white" font-weight="bold" font-size="14">
                                <tspan class="fas">&#xf538;</tspan> Redis
                            </text>
                            <text x="100" y="42" text-anchor="middle" fill="#9ca3af" font-size="10">Message Broker</text>
                            <text x="100" y="58" text-anchor="middle" fill="#9ca3af" font-size="10">Port 6379</text>
                            <circle cx="180" cy="10" r="8" fill="#6b7280" class="status-indicator"/>
                        </g>

                        <!-- NetBox External -->
                        <g id="node-netbox" class="service-node external" data-service="netbox" transform="translate(650, 380)">
                            <rect x="0" y="0" width="180" height="60" rx="8" fill="none" stroke="#6b7280" stroke-width="2" stroke-dasharray="5,5" class="node-bg"/>
                            <text x="90" y="25" text-anchor="middle" fill="#9ca3af" font-weight="bold" font-size="12">
                                <tspan class="fas">&#xf0c1;</tspan> NetBox
                            </text>
                            <text x="90" y="45" text-anchor="middle" fill="#6b7280" font-size="10">External DCIM</text>
                        </g>

                        <!-- Data flow labels -->
                        <text x="320" y="275" fill="#6b7280" font-size="9" transform="rotate(-30, 320, 275)">SQL Queries</text>
                        <text x="350" y="405" fill="#6b7280" font-size="9">Task Queue</text>
                    </svg>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Service Cards -->
<div class="row mb-4">
    <div class="col-12">
        <h5 class="text-muted mb-3"><i class="fas fa-cubes"></i> Service Details</h5>
    </div>
</div>

<div class="row g-3" id="service-cards">
    <!-- Auth Service Card -->
    <div class="col-md-4">
        <div class="card service-card h-100" id="auth-card" data-service="auth">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-key text-purple"></i> Auth Service</span>
                <span class="badge bg-secondary" id="auth-status">...</span>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Response Time</small>
                            <div class="fs-5" id="auth-response-time">--</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Port</small>
                            <div class="fs-5">8011</div>
                        </div>
                    </div>
                </div>
                <div class="small text-muted" id="auth-details">
                    <i class="fas fa-info-circle"></i> Handles authentication, users, and settings
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="showServiceDetails('auth')">
                    <i class="fas fa-search"></i> View Details
                </button>
            </div>
        </div>
    </div>

    <!-- Devices Service Card -->
    <div class="col-md-4">
        <div class="card service-card h-100" id="devices-card" data-service="devices">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-server text-warning"></i> Devices Service</span>
                <span class="badge bg-secondary" id="devices-status">...</span>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Response Time</small>
                            <div class="fs-5" id="devices-response-time">--</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Port</small>
                            <div class="fs-5">8004</div>
                        </div>
                    </div>
                </div>
                <div class="small text-muted" id="devices-details">
                    <i class="fas fa-info-circle"></i> Manages devices, credentials, and NetBox sync
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="showServiceDetails('devices')">
                    <i class="fas fa-search"></i> View Details
                </button>
            </div>
        </div>
    </div>

    <!-- Config Service Card -->
    <div class="col-md-4">
        <div class="card service-card h-100" id="config-card" data-service="config">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-file-code text-pink"></i> Config Service</span>
                <span class="badge bg-secondary" id="config-status">...</span>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Response Time</small>
                            <div class="fs-5" id="config-response-time">--</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Port</small>
                            <div class="fs-5">8002</div>
                        </div>
                    </div>
                </div>
                <div class="small text-muted" id="config-details">
                    <i class="fas fa-info-circle"></i> Templates, stacks, and MOP management
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="showServiceDetails('config')">
                    <i class="fas fa-search"></i> View Details
                </button>
            </div>
        </div>
    </div>

    <!-- AI Service Card -->
    <div class="col-md-4">
        <div class="card service-card h-100" id="ai-card" data-service="ai">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-robot text-success"></i> AI Service</span>
                <span class="badge bg-secondary" id="ai-status">...</span>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Response Time</small>
                            <div class="fs-5" id="ai-response-time">--</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Port</small>
                            <div class="fs-5">8003</div>
                        </div>
                    </div>
                </div>
                <div class="small text-muted" id="ai-details">
                    <i class="fas fa-info-circle"></i> Agents, alerts, incidents, knowledge
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="showServiceDetails('ai')">
                    <i class="fas fa-search"></i> View Details
                </button>
            </div>
        </div>
    </div>

    <!-- PostgreSQL Card -->
    <div class="col-md-4">
        <div class="card service-card h-100" id="postgres-card" data-service="postgres">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-database text-info"></i> PostgreSQL</span>
                <span class="badge bg-secondary" id="postgres-status">...</span>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Status</small>
                            <div class="fs-5" id="postgres-connection">--</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Port</small>
                            <div class="fs-5">5432</div>
                        </div>
                    </div>
                </div>
                <div class="small text-muted" id="postgres-details">
                    <i class="fas fa-info-circle"></i> Shared database for all services
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="showServiceDetails('postgres')">
                    <i class="fas fa-search"></i> View Details
                </button>
            </div>
        </div>
    </div>

    <!-- Redis Card -->
    <div class="col-md-4">
        <div class="card service-card h-100" id="redis-card" data-service="redis">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-memory text-danger"></i> Redis</span>
                <span class="badge bg-secondary" id="redis-status">...</span>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Status</small>
                            <div class="fs-5" id="redis-connection">--</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Port</small>
                            <div class="fs-5">6379</div>
                        </div>
                    </div>
                </div>
                <div class="small text-muted" id="redis-details">
                    <i class="fas fa-info-circle"></i> Message broker for Celery tasks
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="showServiceDetails('redis')">
                    <i class="fas fa-search"></i> View Details
                </button>
            </div>
        </div>
    </div>

    <!-- Workers Card -->
    <div class="col-md-4">
        <div class="card service-card h-100" id="workers-card" data-service="workers">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="fas fa-tasks text-teal"></i> Celery Workers</span>
                <span class="badge bg-secondary" id="workers-status">...</span>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Workers</small>
                            <div class="fs-5" id="workers-count">--</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="metric-box">
                            <small class="text-muted">Active Tasks</small>
                            <div class="fs-5" id="workers-active">--</div>
                        </div>
                    </div>
                </div>
                <div class="small text-muted" id="workers-details">
                    <i class="fas fa-info-circle"></i> Background task processing
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-sm btn-outline-primary w-100" onclick="showServiceDetails('workers')">
                    <i class="fas fa-search"></i> View Details
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Service Details Modal -->
<div class="modal fade" id="serviceDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceModalTitle">
                    <i class="fas fa-info-circle"></i> Service Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="serviceModalBody">
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">Loading service details...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshHealth()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Service card styles */
.service-card {
    transition: all 0.3s ease;
    border: 1px solid #374151;
}
.service-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}
.service-card.healthy {
    border-color: #10b981;
}
.service-card.healthy .card-header {
    border-bottom-color: #10b981;
}
.service-card.unhealthy {
    border-color: #ef4444;
}
.service-card.unhealthy .card-header {
    border-bottom-color: #ef4444;
}

/* Metric box */
.metric-box {
    background: rgba(55, 65, 81, 0.5);
    padding: 8px 12px;
    border-radius: 6px;
    text-align: center;
}

/* SVG node interactions */
.service-node {
    cursor: pointer;
}
.service-node .node-bg {
    transition: filter 0.2s ease, opacity 0.2s ease;
}
.service-node:hover .node-bg {
    filter: url(#glow) url(#shadow);
    opacity: 0.9;
}
.service-node .node-border {
    transition: stroke-width 0.2s ease;
}
.service-node:hover .node-border {
    stroke-width: 3;
}
.service-node.external {
    opacity: 0.7;
}

/* Connection lines */
.connection-line {
    transition: stroke 0.3s ease, stroke-width 0.3s ease;
}
.connection-line.healthy {
    stroke: #10b981;
    stroke-dasharray: none;
}
.connection-line.unhealthy {
    stroke: #ef4444;
    stroke-dasharray: 5,5;
    animation: dash 1s linear infinite;
}

@keyframes dash {
    to {
        stroke-dashoffset: -10;
    }
}

/* Status indicator pulse */
.status-indicator.healthy {
    fill: #10b981;
    animation: pulse 2s infinite;
}
.status-indicator.unhealthy {
    fill: #ef4444;
    animation: pulse-fast 0.5s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
}
@keyframes pulse-fast {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

/* Text colors */
.text-purple { color: #8b5cf6 !important; }
.text-pink { color: #ec4899 !important; }
.text-teal { color: #14b8a6 !important; }

/* Refresh animation */
.fa-spin-click {
    animation: spin 1s linear infinite;
}
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block scripts %}
<script>
let serviceModal;
let healthData = {};

$(document).ready(function() {
    serviceModal = new bootstrap.Modal(document.getElementById('serviceDetailsModal'));

    // Add click handlers to SVG nodes
    document.querySelectorAll('.service-node').forEach(node => {
        node.addEventListener('click', function() {
            const service = this.dataset.service;
            if (service && service !== 'traefik' && service !== 'netbox') {
                showServiceDetails(service);
            }
        });
    });

    // Initial load
    loadPlatformStats();
    refreshHealth();

    // Auto-refresh every 30 seconds
    setInterval(refreshHealth, 30000);
    setInterval(loadPlatformStats, 60000);  // Stats refresh every 60 seconds
});

async function loadPlatformStats() {
    try {
        const response = await fetch('/api/platform/stats');
        const data = await response.json();

        document.getElementById('stat-devices').textContent = data.devices?.total ?? '-';
        document.getElementById('stat-templates').textContent = data.templates?.total ?? '-';
        document.getElementById('stat-stacks').textContent = `${data.stacks?.deployed ?? 0}/${data.stacks?.total ?? 0}`;
        document.getElementById('stat-incidents').textContent = data.incidents?.open ?? '-';
        document.getElementById('stat-agents').textContent = data.agents?.active ?? '-';
        document.getElementById('stat-backups').textContent = data.backups?.recent_count ?? '-';
    } catch (error) {
        console.error('Error loading platform stats:', error);
    }
}

function updateSVGNode(serviceName, status) {
    const node = document.getElementById(`node-${serviceName}`);
    if (!node) return;

    const bg = node.querySelector('.node-bg');
    const indicator = node.querySelector('.status-indicator');

    // Remove existing status classes
    if (indicator) {
        indicator.classList.remove('healthy', 'unhealthy');
    }

    if (status === 'healthy') {
        if (bg) bg.setAttribute('fill', 'url(#healthyGradient)');
        if (indicator) {
            indicator.setAttribute('fill', '#10b981');
            indicator.classList.add('healthy');
        }
    } else if (status === 'unhealthy') {
        if (bg) bg.setAttribute('fill', 'url(#unhealthyGradient)');
        if (indicator) {
            indicator.setAttribute('fill', '#ef4444');
            indicator.classList.add('unhealthy');
        }
    } else {
        if (bg) bg.setAttribute('fill', 'url(#unknownGradient)');
        if (indicator) indicator.setAttribute('fill', '#6b7280');
    }
}

function updateConnectionLine(lineId, isHealthy) {
    const line = document.getElementById(lineId);
    if (!line) return;

    line.classList.remove('healthy', 'unhealthy');
    if (isHealthy) {
        line.classList.add('healthy');
        line.setAttribute('stroke', '#10b981');
        line.setAttribute('stroke-dasharray', 'none');
    } else {
        line.classList.add('unhealthy');
        line.setAttribute('stroke', '#ef4444');
        line.setAttribute('stroke-dasharray', '5,5');
    }
}

function updateServiceCard(serviceName, data) {
    const card = document.getElementById(`${serviceName}-card`);
    const statusBadge = document.getElementById(`${serviceName}-status`);

    if (!card || !statusBadge) return;

    // Remove old classes
    card.classList.remove('healthy', 'unhealthy');

    if (data.status === 'healthy') {
        card.classList.add('healthy');
        statusBadge.className = 'badge bg-success';
        statusBadge.textContent = 'Healthy';

        // Update metrics
        if (data.response_ms !== undefined) {
            const rtEl = document.getElementById(`${serviceName}-response-time`);
            if (rtEl) rtEl.textContent = `${data.response_ms}ms`;
        }
        if (serviceName === 'postgres') {
            document.getElementById('postgres-connection').textContent = 'Connected';
        }
        if (serviceName === 'redis') {
            document.getElementById('redis-connection').textContent = 'Connected';
        }
        if (serviceName === 'workers') {
            document.getElementById('workers-count').textContent = data.workers || '0';
            document.getElementById('workers-active').textContent = data.active_tasks || '0';
            // Update SVG worker count
            const workerText = document.getElementById('worker-count-text');
            if (workerText) workerText.textContent = `Workers: ${data.workers || 0}`;
        }
    } else if (data.status === 'unhealthy') {
        card.classList.add('unhealthy');
        statusBadge.className = 'badge bg-danger';
        statusBadge.textContent = 'Unhealthy';

        // Show error
        const detailsEl = document.getElementById(`${serviceName}-details`);
        if (detailsEl && data.error) {
            detailsEl.innerHTML = `<i class="fas fa-exclamation-triangle text-danger"></i> ${data.error}`;
        }

        if (serviceName === 'postgres') {
            document.getElementById('postgres-connection').textContent = 'Error';
        }
        if (serviceName === 'redis') {
            document.getElementById('redis-connection').textContent = 'Error';
        }
        if (serviceName === 'workers') {
            document.getElementById('workers-count').textContent = '0';
            document.getElementById('workers-active').textContent = '0';
        }
    } else {
        statusBadge.className = 'badge bg-secondary';
        statusBadge.textContent = 'Unknown';
    }

    // Update SVG node
    updateSVGNode(serviceName, data.status);
}

function updateOverallStatus(status, services) {
    const card = document.getElementById('overall-status-card');
    const icon = document.getElementById('overall-status-icon');
    const text = document.getElementById('overall-status-text');
    const summary = document.getElementById('services-summary');

    let healthyCount = 0;
    let unhealthyCount = 0;

    Object.values(services).forEach(s => {
        if (s.status === 'healthy') healthyCount++;
        else unhealthyCount++;
    });

    document.getElementById('healthy-count').textContent = `${healthyCount} Healthy`;
    document.getElementById('unhealthy-count').textContent = `${unhealthyCount} Unhealthy`;

    if (status === 'healthy') {
        card.className = 'card border-success';
        card.style.borderWidth = '2px';
        icon.innerHTML = '<i class="fas fa-check-circle fa-2x text-success"></i>';
        text.textContent = 'All Systems Operational';
        text.className = 'mb-0 text-success';
        summary.textContent = `${healthyCount} services running normally`;
    } else {
        card.className = 'card border-warning';
        card.style.borderWidth = '2px';
        icon.innerHTML = '<i class="fas fa-exclamation-triangle fa-2x text-warning"></i>';
        text.textContent = 'Some Services Degraded';
        text.className = 'mb-0 text-warning';
        summary.textContent = `${unhealthyCount} service(s) need attention`;
    }

    // Update connection lines based on service health
    const authHealthy = services.auth?.status === 'healthy';
    const devicesHealthy = services.devices?.status === 'healthy';
    const configHealthy = services.config?.status === 'healthy';
    const aiHealthy = services.ai?.status === 'healthy';
    const postgresHealthy = services.postgres?.status === 'healthy';
    const redisHealthy = services.redis?.status === 'healthy';
    const workersHealthy = services.workers?.status === 'healthy';

    updateConnectionLine('conn-traefik-auth', authHealthy);
    updateConnectionLine('conn-traefik-devices', devicesHealthy);
    updateConnectionLine('conn-traefik-config', configHealthy);
    updateConnectionLine('conn-traefik-ai', aiHealthy);
    updateConnectionLine('conn-auth-db', authHealthy && postgresHealthy);
    updateConnectionLine('conn-devices-db', devicesHealthy && postgresHealthy);
    updateConnectionLine('conn-config-db', configHealthy && postgresHealthy);
    updateConnectionLine('conn-workers-redis', workersHealthy && redisHealthy);
    updateConnectionLine('conn-devices-workers', devicesHealthy && workersHealthy);
}

function refreshHealth() {
    // Show loading state
    const refreshIcon = document.getElementById('refresh-icon');
    refreshIcon.classList.add('fa-spin-click');

    // Reset all to loading state
    ['auth', 'devices', 'config', 'ai', 'postgres', 'redis', 'workers'].forEach(service => {
        const statusBadge = document.getElementById(`${service}-status`);
        if (statusBadge) {
            statusBadge.className = 'badge bg-secondary';
            statusBadge.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
    });

    document.getElementById('overall-status-icon').innerHTML = '<i class="fas fa-spinner fa-spin fa-2x"></i>';
    document.getElementById('overall-status-text').textContent = 'Checking services...';

    $.ajax({
        url: '/api/platform/health',
        method: 'GET',
        success: function(response) {
            if (response.success && response.data) {
                healthData = response.data;
                const services = response.data.services;

                // Update each service
                Object.keys(services).forEach(service => {
                    updateServiceCard(service, services[service]);
                });

                // Update overall status
                updateOverallStatus(response.data.overall_status, services);

                // Update last refresh time
                const now = new Date();
                document.getElementById('last-refresh').textContent =
                    'Updated: ' + now.toLocaleTimeString();
            }
            refreshIcon.classList.remove('fa-spin-click');
        },
        error: function(xhr, status, error) {
            console.error('Error fetching health:', error);
            ['auth', 'devices', 'config', 'ai', 'postgres', 'redis', 'workers'].forEach(service => {
                updateServiceCard(service, { status: 'unknown', error: 'API Error' });
            });
            updateOverallStatus('degraded', {});
            refreshIcon.classList.remove('fa-spin-click');
        }
    });
}

function showServiceDetails(serviceName) {
    const serviceInfo = {
        auth: {
            title: 'Auth Service',
            icon: 'fa-key',
            color: '#8b5cf6',
            port: 8011,
            description: 'Handles user authentication, JWT token management, and system settings.',
            endpoints: [
                { method: 'POST', path: '/api/auth/login', desc: 'User login' },
                { method: 'POST', path: '/api/auth/refresh', desc: 'Refresh JWT token' },
                { method: 'GET', path: '/api/auth/users', desc: 'List users' },
                { method: 'GET', path: '/api/settings/settings', desc: 'Get system settings' },
            ]
        },
        devices: {
            title: 'Devices Service',
            icon: 'fa-server',
            color: '#f59e0b',
            port: 8004,
            description: 'Manages network devices, device overrides, and NetBox synchronization.',
            endpoints: [
                { method: 'GET', path: '/api/devices', desc: 'List devices' },
                { method: 'GET', path: '/api/device-overrides', desc: 'Get device overrides' },
                { method: 'POST', path: '/api/devices/{id}/test', desc: 'Test device connectivity' },
            ]
        },
        config: {
            title: 'Config Service',
            icon: 'fa-file-code',
            color: '#ec4899',
            port: 8002,
            description: 'Manages configuration templates, service stacks, and Method of Procedures (MOPs).',
            endpoints: [
                { method: 'GET', path: '/api/templates', desc: 'List templates' },
                { method: 'GET', path: '/api/stacks', desc: 'List service stacks' },
                { method: 'GET', path: '/api/mops', desc: 'List MOPs' },
                { method: 'POST', path: '/api/templates/{id}/render', desc: 'Render template' },
            ]
        },
        ai: {
            title: 'AI Service',
            icon: 'fa-robot',
            color: '#10b981',
            port: 8003,
            description: 'Manages AI agents, alert processing, incidents, and knowledge base documents.',
            endpoints: [
                { method: 'GET', path: '/api/agents', desc: 'List AI agents' },
                { method: 'GET', path: '/api/alerts', desc: 'List alerts' },
                { method: 'POST', path: '/api/alerts', desc: 'Create alert (webhook)' },
                { method: 'GET', path: '/api/incidents', desc: 'List incidents' },
                { method: 'GET', path: '/api/knowledge', desc: 'List knowledge docs' },
                { method: 'POST', path: '/api/knowledge/search', desc: 'Vector search' },
            ]
        },
        postgres: {
            title: 'PostgreSQL Database',
            icon: 'fa-database',
            color: '#3b82f6',
            port: 5432,
            description: 'Shared PostgreSQL database used by all microservices for persistent storage.',
            endpoints: []
        },
        redis: {
            title: 'Redis Message Broker',
            icon: 'fa-memory',
            color: '#ef4444',
            port: 6379,
            description: 'Redis instance used as message broker for Celery background tasks.',
            endpoints: []
        },
        workers: {
            title: 'Celery Workers',
            icon: 'fa-tasks',
            color: '#14b8a6',
            port: null,
            description: 'Background task workers for device operations, backups, and scheduled jobs.',
            endpoints: [
                { method: 'TASK', path: 'get_config', desc: 'Fetch device configuration' },
                { method: 'TASK', path: 'set_config', desc: 'Push configuration to device' },
                { method: 'TASK', path: 'backup_device_config', desc: 'Backup device config' },
                { method: 'TASK', path: 'test_connectivity', desc: 'Test device connectivity' },
            ]
        }
    };

    const info = serviceInfo[serviceName];
    const data = healthData.services?.[serviceName] || {};

    document.getElementById('serviceModalTitle').innerHTML = `
        <i class="fas ${info.icon}" style="color: ${info.color}"></i> ${info.title}
    `;

    let endpointsHtml = '';
    if (info.endpoints.length > 0) {
        endpointsHtml = `
            <h6 class="mt-4 mb-3">
                <i class="fas fa-plug"></i> ${serviceName === 'workers' ? 'Available Tasks' : 'API Endpoints'}
            </h6>
            <table class="table table-sm table-dark">
                <thead>
                    <tr>
                        <th>${serviceName === 'workers' ? 'Type' : 'Method'}</th>
                        <th>${serviceName === 'workers' ? 'Task Name' : 'Path'}</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    ${info.endpoints.map(e => `
                        <tr>
                            <td><span class="badge ${e.method === 'GET' ? 'bg-success' : e.method === 'POST' ? 'bg-primary' : 'bg-info'}">${e.method}</span></td>
                            <td><code>${e.path}</code></td>
                            <td>${e.desc}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;
    }

    let statusClass = data.status === 'healthy' ? 'success' : data.status === 'unhealthy' ? 'danger' : 'secondary';
    let statusText = data.status === 'healthy' ? 'Healthy' : data.status === 'unhealthy' ? 'Unhealthy' : 'Unknown';

    let metricsHtml = `
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Status</h6>
                        <span class="badge bg-${statusClass} fs-5">${statusText}</span>
                    </div>
                </div>
            </div>
    `;

    if (info.port) {
        metricsHtml += `
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Port</h6>
                        <span class="fs-5">${info.port}</span>
                    </div>
                </div>
            </div>
        `;
    }

    if (data.response_ms !== undefined) {
        metricsHtml += `
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Response Time</h6>
                        <span class="fs-5">${data.response_ms}ms</span>
                    </div>
                </div>
            </div>
        `;
    }

    if (serviceName === 'workers' && data.workers !== undefined) {
        metricsHtml += `
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Active Workers</h6>
                        <span class="fs-5">${data.workers}</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-dark">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Running Tasks</h6>
                        <span class="fs-5">${data.active_tasks || 0}</span>
                    </div>
                </div>
            </div>
        `;
    }

    metricsHtml += '</div>';

    if (data.error) {
        metricsHtml += `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> ${data.error}
            </div>
        `;
    }

    document.getElementById('serviceModalBody').innerHTML = `
        <p class="text-muted">${info.description}</p>
        ${metricsHtml}
        ${endpointsHtml}
    `;

    serviceModal.show();
}
</script>
{% endblock %}
