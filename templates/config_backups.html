{% extends "base.html" %}

{% block title %}Config Backups - NetStacks{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-database"></i> Config Backups
        </h1>
        <p class="text-muted">Device configuration backups for validation and auditing</p>
    </div>
</div>

<div class="row">
    <!-- Left Panel: Controls & Schedule -->
    <div class="col-md-4">
        <!-- Backup Actions Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-play-circle"></i> Backup Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="run-all-backups-btn">
                        <i class="fas fa-sync"></i> Run All Device Backups
                    </button>
                    <button class="btn btn-outline-primary" id="run-single-backup-btn">
                        <i class="fas fa-server"></i> Backup Single Device
                    </button>
                    <button class="btn btn-outline-warning" id="cleanup-backups-btn">
                        <i class="fas fa-broom"></i> Cleanup Old Backups
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Summary</h5>
            </div>
            <div class="card-body">
                <div id="backup-summary">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Card -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Backup Schedule</h5>
                <button class="btn btn-sm btn-primary" id="save-schedule-btn">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
            <div class="card-body">
                <form id="schedule-form">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="schedule-enabled">
                        <label class="form-check-label" for="schedule-enabled">Enable Scheduled Backups</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Backup Interval (hours)</label>
                        <input type="number" class="form-control" id="schedule-interval" value="24" min="1" max="168">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Retention (days)</label>
                        <input type="number" class="form-control" id="schedule-retention" value="30" min="1" max="365">
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="schedule-juniper-set" checked>
                        <label class="form-check-label" for="schedule-juniper-set">
                            Juniper Set Format
                            <small class="text-muted d-block">Use "display set" format for template matching</small>
                        </label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Exclude Patterns (regex, one per line)</label>
                        <textarea class="form-control font-monospace" id="schedule-exclude" rows="3" placeholder="e.g.&#10;^test-.*&#10;.*-lab$"></textarea>
                        <small class="text-muted">Devices matching these patterns will be skipped</small>
                    </div>

                    <div class="alert alert-info mb-0" id="schedule-status">
                        <small>
                            <strong>Last Run:</strong> <span id="last-run">Never</span><br>
                            <strong>Next Run:</strong> <span id="next-run">Not scheduled</span>
                        </small>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Panel: Backup List -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> Recent Backups</h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block" id="filter-device" style="width: auto;">
                        <option value="">All Devices</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-backups-btn">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Time</th>
                                <th>Format</th>
                                <th>Size</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backups-table-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading backups...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted">Showing <span id="backup-count">0</span> backups</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" id="prev-page"><a class="page-link" href="#">Previous</a></li>
                        <li class="page-item" id="next-page"><a class="page-link" href="#">Next</a></li>
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Running Tasks -->
        <div class="card mt-3" id="running-tasks-card" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> Running Backup Tasks</h5>
            </div>
            <div class="card-body">
                <div id="running-tasks-list">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Backup Modal -->
<div class="modal fade" id="viewBackupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-code"></i> <span id="view-backup-title">Config Backup</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Device:</strong> <span id="view-device"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Format:</strong> <span id="view-format"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Size:</strong> <span id="view-size"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Time:</strong> <span id="view-time"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Configuration Content</label>
                    <textarea class="form-control font-monospace" id="view-config-content" rows="20" readonly></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copy-config-btn">
                    <i class="fas fa-copy"></i> Copy to Clipboard
                </button>
                <button type="button" class="btn btn-success" id="download-config-btn">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Single Backup Modal -->
<div class="modal fade" id="singleBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-server"></i> Backup Single Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Device</label>
                    <select class="form-select" id="single-backup-device">
                        <option value="">Loading devices...</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <small>The backup will use default credentials from settings. To use different credentials, configure them in the device settings.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="start-single-backup-btn">
                    <i class="fas fa-play"></i> Start Backup
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// State
let currentPage = 0;
const pageSize = 50;
let runningTasks = [];
let taskPollInterval = null;
let cachedDevices = [];  // Store devices locally after first load

// Initialize
$(document).ready(function() {
    loadBackups();
    loadSchedule();
    loadDevicesFromCache();
    loadSummary();
});

// Load backups list
function loadBackups(deviceFilter = '') {
    const offset = currentPage * pageSize;
    let url = `/api/config-backups?limit=${pageSize}&offset=${offset}`;
    if (deviceFilter) {
        url += `&device=${encodeURIComponent(deviceFilter)}`;
    }

    $.get(url)
        .done(function(response) {
            if (response.success) {
                renderBackupsTable(response.backups);
                $('#backup-count').text(response.backups.length);
                updatePagination(response.backups.length);
            }
        })
        .fail(function() {
            $('#backups-table-body').html('<tr><td colspan="6" class="text-center text-danger">Error loading backups</td></tr>');
        });
}

// Load summary
function loadSummary() {
    $.get('/api/config-backups?limit=1')
        .done(function(response) {
            if (response.success && response.summary) {
                const s = response.summary;
                $('#backup-summary').html(`
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <h3 class="mb-0">${s.total_backups || 0}</h3>
                            <small class="text-muted">Total Backups</small>
                        </div>
                        <div class="col-6 mb-2">
                            <h3 class="mb-0">${s.unique_devices || 0}</h3>
                            <small class="text-muted">Devices</small>
                        </div>
                    </div>
                    <hr>
                    <small class="text-muted">
                        <strong>Latest:</strong> ${s.latest_backup ? formatDate(s.latest_backup) : 'Never'}<br>
                        <strong>Oldest:</strong> ${s.oldest_backup ? formatDate(s.oldest_backup) : 'N/A'}
                    </small>
                `);

                // Populate device filter
                if (s.devices_with_backups) {
                    const $filter = $('#filter-device');
                    $filter.find('option:not(:first)').remove();
                    s.devices_with_backups.forEach(function(device) {
                        $filter.append(`<option value="${device}">${device}</option>`);
                    });
                }
            }
        });
}

// Load schedule
function loadSchedule() {
    $.get('/api/backup-schedule')
        .done(function(response) {
            if (response.success && response.schedule) {
                const s = response.schedule;
                $('#schedule-enabled').prop('checked', s.enabled);
                $('#schedule-interval').val(s.interval_hours || 24);
                $('#schedule-retention').val(s.retention_days || 30);
                $('#schedule-juniper-set').prop('checked', s.juniper_set_format !== false);
                $('#schedule-exclude').val((s.exclude_patterns || []).join('\n'));
                $('#last-run').text(s.last_run ? formatDate(s.last_run) : 'Never');
                $('#next-run').text(s.next_run ? formatDate(s.next_run) : 'Not scheduled');
            }
        });
}

// Track if a device load is already in progress
let devicesLoading = false;

// Load devices from server cache only - does NOT call NetBox
function loadDevicesFromCache() {
    const $select = $('#single-backup-device');

    // Check if we already have devices cached locally in browser
    if (cachedDevices.length > 0) {
        console.log('Using ' + cachedDevices.length + ' browser-cached devices');
        populateDeviceDropdown(cachedDevices);
        return;
    }

    // Prevent multiple simultaneous requests
    if (devicesLoading) {
        console.log('Device load already in progress, waiting...');
        return;
    }

    devicesLoading = true;
    $select.html('<option value="">Loading devices...</option>');

    // Use the /api/devices/cached endpoint - returns only devices already in server cache
    // Does NOT call NetBox - only returns manual devices + previously cached NetBox devices
    $.ajax({
        url: '/api/devices/cached',
        method: 'GET',
        timeout: 30000
    })
    .done(function(response) {
        console.log('Cached devices response:', response);
        if (response.success && response.devices && response.devices.length > 0) {
            // Store in browser cache for reuse
            cachedDevices = response.devices;
            console.log('Loaded ' + cachedDevices.length + ' devices from server cache (' +
                        response.manual_count + ' manual, ' + response.cached_count + ' from NetBox cache)');
            populateDeviceDropdown(cachedDevices);
        } else {
            console.warn('No devices in cache. Load devices on another page first (Deploy, Service Stacks, etc.)');
            $select.empty();
            $select.append('<option value="">-- Select Device --</option>');
            $select.append('<option value="" disabled>No devices in cache - load devices on Deploy page first</option>');
        }
    })
    .fail(function(xhr, status, error) {
        console.error('Failed to load cached devices:', status, error);
        $select.empty();
        $select.append('<option value="">Error loading devices</option>');
    })
    .always(function() {
        devicesLoading = false;
    });
}

// Populate device dropdown from cached devices
function populateDeviceDropdown(devices) {
    const $select = $('#single-backup-device');
    console.log('Populating device dropdown with ' + devices.length + ' devices');
    $select.empty();
    $select.append('<option value="">-- Select Device --</option>');

    devices.forEach(function(device) {
        const name = device.name || device.display || device.hostname || 'Unknown';
        $select.append(`<option value="${name}">${name}</option>`);
    });
    console.log('Device dropdown populated, options count:', $select.find('option').length);
}

// Render backups table
function renderBackupsTable(backups) {
    const $tbody = $('#backups-table-body');
    $tbody.empty();

    if (!backups || backups.length === 0) {
        $tbody.html('<tr><td colspan="6" class="text-center text-muted">No backups found</td></tr>');
        return;
    }

    backups.forEach(function(backup) {
        const statusBadge = backup.status === 'success'
            ? '<span class="badge bg-success">Success</span>'
            : '<span class="badge bg-danger">Failed</span>';

        const formatBadge = backup.config_format === 'set'
            ? '<span class="badge bg-info">Set</span>'
            : '<span class="badge bg-secondary">Native</span>';

        $tbody.append(`
            <tr>
                <td>
                    <i class="fas fa-server text-muted"></i> ${escapeHtml(backup.device_name)}
                    ${backup.device_ip ? `<small class="text-muted d-block">${backup.device_ip}</small>` : ''}
                </td>
                <td><small>${formatDate(backup.created_at)}</small></td>
                <td>${formatBadge}</td>
                <td><small>${formatFileSize(backup.file_size || 0)}</small></td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-backup-btn" data-id="${backup.backup_id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-backup-btn" data-id="${backup.backup_id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });

    // Bind button handlers
    $('.view-backup-btn').click(function() {
        viewBackup($(this).data('id'));
    });

    $('.delete-backup-btn').click(function() {
        deleteBackup($(this).data('id'));
    });
}

// View backup details
function viewBackup(backupId) {
    $.get(`/api/config-backups/${backupId}`)
        .done(function(response) {
            if (response.success && response.backup) {
                const b = response.backup;
                $('#view-backup-title').text(`Config Backup: ${b.device_name}`);
                $('#view-device').text(b.device_name);
                $('#view-format').text(b.config_format || 'native');
                $('#view-size').text(formatFileSize(b.file_size || 0));
                $('#view-time').text(formatDate(b.created_at));
                $('#view-config-content').val(b.config_content || '');

                // Store for download
                $('#viewBackupModal').data('backup', b);
                $('#viewBackupModal').modal('show');
            }
        });
}

// Delete backup
function deleteBackup(backupId) {
    if (!confirm('Are you sure you want to delete this backup?')) return;

    $.ajax({
        url: `/api/config-backups/${backupId}`,
        method: 'DELETE'
    })
    .done(function(response) {
        if (response.success) {
            loadBackups($('#filter-device').val());
            loadSummary();
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// Run all backups
$('#run-all-backups-btn').click(function() {
    const deviceCount = cachedDevices.length || 'all';
    if (!confirm(`This will start backups for ${deviceCount} devices from the cached device list. Continue?`)) return;

    const $btn = $(this);
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting...');

    // Get filters from settings to pass to the API
    let filters = [];
    try {
        const settings = JSON.parse(localStorage.getItem('netstacks_settings') || '{}');
        filters = settings.netbox_filters || [];
    } catch (e) {
        console.error('Error reading filters from settings:', e);
    }

    $.ajax({
        url: '/api/config-backups/run-all',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ filters: filters })
    })
    .done(function(response) {
        if (response.success) {
            alert(`Submitted ${response.submitted} backup tasks. ${response.failed} failed.`);
            // Start polling for tasks
            if (response.tasks && response.tasks.length > 0) {
                runningTasks = response.tasks;
                showRunningTasks();
                startTaskPolling();
            }
        } else {
            alert('Error: ' + response.error);
        }
    })
    .always(function() {
        $btn.prop('disabled', false).html('<i class="fas fa-sync"></i> Run All Device Backups');
    });
});

// Single backup modal - ensure devices are loaded when modal opens
$('#run-single-backup-btn').click(function() {
    // Refresh device list from cache when opening modal
    if (cachedDevices.length > 0) {
        populateDeviceDropdown(cachedDevices);
        $('#singleBackupModal').modal('show');
    } else {
        // Show loading state and wait for devices to load
        const $select = $('#single-backup-device');
        $select.html('<option value="">Loading devices...</option>');
        $('#singleBackupModal').modal('show');

        // Load devices - the loadDevicesFromCache function will populate the dropdown
        loadDevicesFromCache();
    }
});

$('#start-single-backup-btn').click(function() {
    const deviceName = $('#single-backup-device').val();
    if (!deviceName) {
        alert('Please select a device');
        return;
    }

    const $btn = $(this);
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting...');

    $.ajax({
        url: '/api/config-backups/run-single',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ device_name: deviceName })
    })
    .done(function(response) {
        if (response.success) {
            $('#singleBackupModal').modal('hide');
            runningTasks = [{ device: deviceName, task_id: response.task_id }];
            showRunningTasks();
            startTaskPolling();
        } else {
            alert('Error: ' + response.error);
        }
    })
    .always(function() {
        $btn.prop('disabled', false).html('<i class="fas fa-play"></i> Start Backup');
    });
});

// Save schedule
$('#save-schedule-btn').click(function() {
    const excludeText = $('#schedule-exclude').val().trim();
    const excludePatterns = excludeText ? excludeText.split('\n').filter(p => p.trim()) : [];

    const scheduleData = {
        enabled: $('#schedule-enabled').is(':checked'),
        interval_hours: parseInt($('#schedule-interval').val()) || 24,
        retention_days: parseInt($('#schedule-retention').val()) || 30,
        juniper_set_format: $('#schedule-juniper-set').is(':checked'),
        exclude_patterns: excludePatterns
    };

    $.ajax({
        url: '/api/backup-schedule',
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(scheduleData)
    })
    .done(function(response) {
        if (response.success) {
            alert('Schedule saved successfully');
            loadSchedule();
        } else {
            alert('Error: ' + response.error);
        }
    });
});

// Cleanup old backups
$('#cleanup-backups-btn').click(function() {
    const retentionDays = parseInt($('#schedule-retention').val()) || 30;
    if (!confirm(`Delete all backups older than ${retentionDays} days?`)) return;

    $.ajax({
        url: '/api/config-backups/cleanup',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ retention_days: retentionDays })
    })
    .done(function(response) {
        if (response.success) {
            alert(`Deleted ${response.deleted_count} old backups`);
            loadBackups();
            loadSummary();
        } else {
            alert('Error: ' + response.error);
        }
    });
});

// Refresh and filter
$('#refresh-backups-btn').click(function() {
    loadBackups($('#filter-device').val());
    loadSummary();
});

$('#filter-device').change(function() {
    currentPage = 0;
    loadBackups($(this).val());
});

// Pagination
$('#prev-page').click(function(e) {
    e.preventDefault();
    if (currentPage > 0) {
        currentPage--;
        loadBackups($('#filter-device').val());
    }
});

$('#next-page').click(function(e) {
    e.preventDefault();
    currentPage++;
    loadBackups($('#filter-device').val());
});

function updatePagination(count) {
    $('#prev-page').toggleClass('disabled', currentPage === 0);
    $('#next-page').toggleClass('disabled', count < pageSize);
}

// Task polling
function showRunningTasks() {
    $('#running-tasks-card').show();
    const $list = $('#running-tasks-list');
    $list.empty();

    runningTasks.forEach(function(task) {
        $list.append(`
            <div class="d-flex justify-content-between align-items-center mb-2" id="task-${task.task_id}">
                <span><i class="fas fa-spinner fa-spin text-primary"></i> ${escapeHtml(task.device)}</span>
                <span class="badge bg-warning">Running</span>
            </div>
        `);
    });
}

function startTaskPolling() {
    if (taskPollInterval) clearInterval(taskPollInterval);

    taskPollInterval = setInterval(function() {
        let completedCount = 0;

        runningTasks.forEach(function(task) {
            $.get(`/api/config-backups/task/${task.task_id}`)
                .done(function(response) {
                    const $taskEl = $(`#task-${task.task_id}`);
                    if (response.status === 'success' || response.saved) {
                        $taskEl.find('.fa-spinner').removeClass('fa-spinner fa-spin text-primary').addClass('fa-check text-success');
                        $taskEl.find('.badge').removeClass('bg-warning').addClass('bg-success').text('Complete');
                        completedCount++;
                    } else if (response.status === 'failed' || (response.result && response.result.status === 'failed')) {
                        $taskEl.find('.fa-spinner').removeClass('fa-spinner fa-spin text-primary').addClass('fa-times text-danger');
                        $taskEl.find('.badge').removeClass('bg-warning').addClass('bg-danger').text('Failed');
                        completedCount++;
                    }
                });
        });

        // Check if all done
        setTimeout(function() {
            const remaining = runningTasks.filter(function(task) {
                const $el = $(`#task-${task.task_id}`);
                return $el.find('.fa-spinner').length > 0;
            });

            if (remaining.length === 0) {
                clearInterval(taskPollInterval);
                taskPollInterval = null;
                loadBackups();
                loadSummary();

                setTimeout(function() {
                    $('#running-tasks-card').fadeOut();
                }, 3000);
            }
        }, 500);
    }, 2000);
}

// Copy and download handlers
$('#copy-config-btn').click(function() {
    const content = $('#view-config-content').val();
    navigator.clipboard.writeText(content).then(function() {
        alert('Copied to clipboard!');
    });
});

$('#download-config-btn').click(function() {
    const backup = $('#viewBackupModal').data('backup');
    if (!backup) return;

    const blob = new Blob([backup.config_content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${backup.device_name}_${backup.created_at.replace(/[: ]/g, '_')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

// Utility functions
function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const d = new Date(dateStr);
    return d.toLocaleString();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
