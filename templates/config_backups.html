{% extends "base.html" %}

{% block title %}Config Backups - NetStacks{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-database"></i> Config Backups
        </h1>
        <p class="text-muted">Device configuration backups for validation and auditing</p>
    </div>
</div>

<div class="row">
    <!-- Left Panel: Controls & Schedule -->
    <div class="col-md-4">
        <!-- Backup Actions Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-play-circle"></i> Backup Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" id="run-all-backups-btn">
                        <i class="fas fa-camera"></i> Create Network Snapshot
                    </button>
                    <button class="btn btn-outline-primary" id="run-single-backup-btn">
                        <i class="fas fa-server"></i> Backup Single Device
                    </button>
                    <button class="btn btn-outline-warning" id="cleanup-backups-btn">
                        <i class="fas fa-broom"></i> Cleanup Old Backups
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Summary</h5>
            </div>
            <div class="card-body">
                <div id="backup-summary">
                    <div class="text-center text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
        </div>

        <!-- Schedule Card -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clock"></i> Backup Schedule</h5>
                <button class="btn btn-sm btn-primary" id="save-schedule-btn">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
            <div class="card-body">
                <form id="schedule-form">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="schedule-enabled">
                        <label class="form-check-label" for="schedule-enabled">Enable Scheduled Backups</label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Backup Interval (hours)</label>
                        <input type="number" class="form-control" id="schedule-interval" value="24" min="1" max="168">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Retention (days)</label>
                        <input type="number" class="form-control" id="schedule-retention" value="30" min="1" max="365">
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="schedule-juniper-set" checked>
                        <label class="form-check-label" for="schedule-juniper-set">
                            Juniper Set Format
                            <small class="text-muted d-block">Use "display set" format for template matching</small>
                        </label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Exclude Patterns (regex, one per line)</label>
                        <textarea class="form-control font-monospace" id="schedule-exclude" rows="3" placeholder="e.g.&#10;^test-.*&#10;.*-lab$"></textarea>
                        <small class="text-muted">Devices matching these patterns will be skipped</small>
                    </div>

                    <div class="alert alert-info mb-0" id="schedule-status">
                        <small>
                            <strong>Last Run:</strong> <span id="last-run">Never</span><br>
                            <strong>Next Run:</strong> <span id="next-run">Not scheduled</span>
                        </small>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right Panel -->
    <div class="col-md-8">
        <!-- Live Snapshot Progress Card (hidden by default) -->
        <div class="card mb-3" id="snapshot-progress-card" style="display: none;">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-camera"></i> <span id="snapshot-progress-title">Creating Network Snapshot...</span></h5>
                <span class="badge bg-light text-dark" id="snapshot-progress-badge">0%</span>
            </div>
            <div class="card-body">
                <!-- Progress Bar -->
                <div class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                         id="snapshot-progress-bar"
                         role="progressbar"
                         style="width: 0%">
                        <span id="snapshot-progress-text">0 / 0</span>
                    </div>
                </div>

                <!-- Stats Row -->
                <div class="row text-center mb-3">
                    <div class="col-3">
                        <h4 class="mb-0 text-primary" id="progress-total">0</h4>
                        <small class="text-muted">Total</small>
                    </div>
                    <div class="col-3">
                        <h4 class="mb-0 text-warning" id="progress-pending">0</h4>
                        <small class="text-muted">Pending</small>
                    </div>
                    <div class="col-3">
                        <h4 class="mb-0 text-success" id="progress-success">0</h4>
                        <small class="text-muted">Success</small>
                    </div>
                    <div class="col-3">
                        <h4 class="mb-0 text-danger" id="progress-failed">0</h4>
                        <small class="text-muted">Failed</small>
                    </div>
                </div>

                <!-- Device Status Grid -->
                <div class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                    <div id="device-status-grid" class="d-flex flex-wrap gap-1">
                        <!-- Device status badges will be inserted here -->
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="mt-3">
                    <small class="text-muted">Recent Activity:</small>
                    <div id="recent-activity" class="font-monospace small" style="max-height: 100px; overflow-y: auto;">
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Snapshots Section -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-camera"></i> Network Snapshots</h5>
                <button class="btn btn-sm btn-outline-secondary" id="refresh-snapshots-btn">
                    <i class="fas fa-sync"></i>
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Created</th>
                                <th>Progress</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="snapshots-table-body">
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading snapshots...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Backups -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> Recent Backups</h5>
                <div>
                    <select class="form-select form-select-sm d-inline-block" id="filter-device" style="width: auto;">
                        <option value="">All Devices</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" id="refresh-backups-btn">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Time</th>
                                <th>Format</th>
                                <th>Size</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="backups-table-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading backups...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted">Showing <span id="backup-count">0</span> backups</small>
                <nav>
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item" id="prev-page"><a class="page-link" href="#">Previous</a></li>
                        <li class="page-item" id="next-page"><a class="page-link" href="#">Next</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- View Snapshot Modal -->
<div class="modal fade" id="viewSnapshotModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-camera"></i> <span id="view-snapshot-title">Snapshot Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Snapshot Summary -->
                <div class="row mb-4">
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-3">
                            <h3 class="mb-0 text-primary" id="modal-total-devices">0</h3>
                            <small class="text-muted">Total Devices</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-3">
                            <h3 class="mb-0 text-success" id="modal-success-count">0</h3>
                            <small class="text-muted">Successful</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-3">
                            <h3 class="mb-0 text-danger" id="modal-failed-count">0</h3>
                            <small class="text-muted">Failed</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="border rounded p-3">
                            <span class="badge fs-6" id="modal-status-badge">Unknown</span>
                            <small class="text-muted d-block mt-1">Status</small>
                        </div>
                    </div>
                </div>

                <!-- Snapshot Info -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <small class="text-muted">Created:</small>
                        <span id="snapshot-created"></span>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">Completed:</small>
                        <span id="snapshot-completed"></span>
                    </div>
                </div>

                <!-- Search/Filter -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm" id="snapshot-backup-search" placeholder="Search devices...">
                    </div>
                    <div class="col-md-6">
                        <select class="form-select form-select-sm" id="snapshot-backup-filter">
                            <option value="">All Statuses</option>
                            <option value="success">Success Only</option>
                            <option value="failed">Failed Only</option>
                        </select>
                    </div>
                </div>

                <!-- Backups Table -->
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-sm table-hover">
                        <thead class="sticky-top bg-white">
                            <tr>
                                <th>Device</th>
                                <th>IP</th>
                                <th>Time</th>
                                <th>Size</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="snapshot-backups-body">
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> Loading backups...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-primary" id="download-snapshot-btn">
                    <i class="fas fa-download"></i> Download All Configs
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- View Backup Modal -->
<div class="modal fade" id="viewBackupModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-code"></i> <span id="view-backup-title">Config Backup</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-3">
                    <div class="col-md-3">
                        <strong>Device:</strong> <span id="view-device"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Format:</strong> <span id="view-format"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Size:</strong> <span id="view-size"></span>
                    </div>
                    <div class="col-md-3">
                        <strong>Time:</strong> <span id="view-time"></span>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Configuration Content</label>
                    <textarea class="form-control font-monospace" id="view-config-content" rows="20" readonly></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copy-config-btn">
                    <i class="fas fa-copy"></i> Copy to Clipboard
                </button>
                <button type="button" class="btn btn-success" id="download-config-btn">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Single Backup Modal -->
<div class="modal fade" id="singleBackupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-server"></i> Backup Single Device</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Device</label>
                    <select class="form-select" id="single-backup-device">
                        <option value="">Loading devices...</option>
                    </select>
                </div>
                <div class="alert alert-info">
                    <small>The backup will use default credentials from settings. To use different credentials, configure them in the device settings.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="start-single-backup-btn">
                    <i class="fas fa-play"></i> Start Backup
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// State
let currentPage = 0;
const pageSize = 50;
let cachedDevices = [];
let activeSnapshotId = null;
let snapshotPollInterval = null;
let currentSnapshotBackups = [];  // Store backups for filtering

// Initialize
$(document).ready(function() {
    loadBackups();
    loadSchedule();
    loadDevicesFromCache();
    loadSummary();
    loadSnapshots();

    // Check for any in-progress snapshots
    checkForActiveSnapshots();
});

// Check for active snapshots on page load
function checkForActiveSnapshots() {
    $.get('/api/config-snapshots?limit=5')
        .done(function(response) {
            if (response.success && response.snapshots) {
                const inProgress = response.snapshots.find(s => s.status === 'in_progress');
                if (inProgress) {
                    activeSnapshotId = inProgress.snapshot_id;
                    showSnapshotProgress(inProgress);
                    startSnapshotPolling();
                }
            }
        });
}

// Load backups list
function loadBackups(deviceFilter = '') {
    const offset = currentPage * pageSize;
    let url = `/api/config-backups?limit=${pageSize}&offset=${offset}`;
    if (deviceFilter) {
        url += `&device=${encodeURIComponent(deviceFilter)}`;
    }

    $.get(url)
        .done(function(response) {
            if (response.success) {
                renderBackupsTable(response.backups);
                $('#backup-count').text(response.backups.length);
                updatePagination(response.backups.length);
            }
        })
        .fail(function() {
            $('#backups-table-body').html('<tr><td colspan="6" class="text-center text-danger">Error loading backups</td></tr>');
        });
}

// Load summary
function loadSummary() {
    $.get('/api/config-backups?limit=1')
        .done(function(response) {
            if (response.success && response.summary) {
                const s = response.summary;
                $('#backup-summary').html(`
                    <div class="row text-center">
                        <div class="col-6 mb-2">
                            <h3 class="mb-0">${s.total_backups || 0}</h3>
                            <small class="text-muted">Total Backups</small>
                        </div>
                        <div class="col-6 mb-2">
                            <h3 class="mb-0">${s.unique_devices || 0}</h3>
                            <small class="text-muted">Devices</small>
                        </div>
                    </div>
                    <hr>
                    <small class="text-muted">
                        <strong>Latest:</strong> ${s.latest_backup ? formatDate(s.latest_backup) : 'Never'}<br>
                        <strong>Oldest:</strong> ${s.oldest_backup ? formatDate(s.oldest_backup) : 'N/A'}
                    </small>
                `);

                // Populate device filter
                if (s.devices_with_backups) {
                    const $filter = $('#filter-device');
                    $filter.find('option:not(:first)').remove();
                    s.devices_with_backups.forEach(function(device) {
                        $filter.append(`<option value="${device}">${device}</option>`);
                    });
                }
            }
        });
}

// Load snapshots
function loadSnapshots() {
    $.get('/api/config-snapshots')
        .done(function(response) {
            if (response.success && response.snapshots) {
                renderSnapshotsTable(response.snapshots);
            }
        })
        .fail(function() {
            $('#snapshots-table-body').html('<tr><td colspan="5" class="text-center text-muted">No snapshots found</td></tr>');
        });
}

// Render snapshots table
function renderSnapshotsTable(snapshots) {
    const $tbody = $('#snapshots-table-body');
    $tbody.empty();

    if (!snapshots || snapshots.length === 0) {
        $tbody.html('<tr><td colspan="5" class="text-center text-muted">No snapshots yet. Click "Create Network Snapshot" to create one.</td></tr>');
        return;
    }

    snapshots.forEach(function(snapshot) {
        const statusClass = {
            'complete': 'bg-success',
            'partial': 'bg-warning text-dark',
            'failed': 'bg-danger',
            'in_progress': 'bg-info'
        }[snapshot.status] || 'bg-secondary';

        const statusText = {
            'complete': 'Complete',
            'partial': 'Partial',
            'failed': 'Failed',
            'in_progress': 'In Progress'
        }[snapshot.status] || snapshot.status;

        const successCount = snapshot.success_count || 0;
        const failedCount = snapshot.failed_count || 0;
        const totalDevices = snapshot.total_devices || 0;
        const completed = successCount + failedCount;
        const progressPct = totalDevices > 0 ? Math.round((completed / totalDevices) * 100) : 0;

        // Progress bar for visual representation
        const progressHtml = `
            <div class="progress" style="height: 20px; min-width: 120px;">
                <div class="progress-bar bg-success" style="width: ${totalDevices > 0 ? (successCount / totalDevices * 100) : 0}%">${successCount}</div>
                <div class="progress-bar bg-danger" style="width: ${totalDevices > 0 ? (failedCount / totalDevices * 100) : 0}%">${failedCount > 0 ? failedCount : ''}</div>
            </div>
            <small class="text-muted">${completed}/${totalDevices}</small>
        `;

        $tbody.append(`
            <tr data-snapshot-id="${snapshot.snapshot_id}">
                <td>
                    <i class="fas fa-camera text-muted"></i> ${escapeHtml(snapshot.name || 'Unnamed')}
                    ${snapshot.created_by ? `<small class="text-muted d-block">by ${escapeHtml(snapshot.created_by)}</small>` : ''}
                </td>
                <td><small>${formatDate(snapshot.created_at)}</small></td>
                <td>${progressHtml}</td>
                <td><span class="badge ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-snapshot-btn" data-id="${snapshot.snapshot_id}" title="View Details">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-snapshot-btn" data-id="${snapshot.snapshot_id}" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });

    // Bind button handlers
    $('.view-snapshot-btn').click(function() {
        viewSnapshot($(this).data('id'));
    });

    $('.delete-snapshot-btn').click(function() {
        deleteSnapshot($(this).data('id'));
    });
}

// Show snapshot progress panel
function showSnapshotProgress(snapshot) {
    $('#snapshot-progress-card').show();
    $('#snapshot-progress-title').text(snapshot.name || 'Creating Network Snapshot...');
    updateSnapshotProgressUI(snapshot);
}

// Update progress UI
function updateSnapshotProgressUI(snapshot) {
    const total = snapshot.total_devices || 0;
    const success = snapshot.success_count || 0;
    const failed = snapshot.failed_count || 0;
    const completed = success + failed;
    const pending = total - completed;
    const pct = total > 0 ? Math.round((completed / total) * 100) : 0;

    $('#progress-total').text(total);
    $('#progress-pending').text(pending);
    $('#progress-success').text(success);
    $('#progress-failed').text(failed);

    $('#snapshot-progress-badge').text(pct + '%');
    $('#snapshot-progress-bar').css('width', pct + '%');
    $('#snapshot-progress-text').text(`${completed} / ${total}`);

    // Update progress bar color based on failures
    const $bar = $('#snapshot-progress-bar');
    if (failed > 0 && success > 0) {
        $bar.removeClass('bg-success bg-danger').addClass('bg-warning');
    } else if (failed > 0 && success === 0) {
        $bar.removeClass('bg-success bg-warning').addClass('bg-danger');
    } else {
        $bar.removeClass('bg-warning bg-danger').addClass('bg-success');
    }
}

// Update device status grid
function updateDeviceStatusGrid(tasks, results) {
    const $grid = $('#device-status-grid');

    tasks.forEach(function(task) {
        let $badge = $grid.find(`[data-device="${task.device}"]`);
        const result = results[task.task_id];

        let statusClass = 'bg-secondary';  // pending
        let icon = 'fa-circle';

        if (result) {
            if (result.status === 'SUCCESS' || result.saved) {
                statusClass = 'bg-success';
                icon = 'fa-check';
            } else if (result.status === 'FAILURE' || result.status === 'failed') {
                statusClass = 'bg-danger';
                icon = 'fa-times';
            } else if (result.status === 'PENDING' || result.status === 'STARTED') {
                statusClass = 'bg-warning text-dark';
                icon = 'fa-spinner fa-spin';
            }
        }

        if ($badge.length === 0) {
            $grid.append(`
                <span class="badge ${statusClass}" data-device="${escapeHtml(task.device)}" title="${escapeHtml(task.device)}">
                    <i class="fas ${icon}"></i> ${escapeHtml(task.device.split('.')[0])}
                </span>
            `);
        } else {
            $badge.removeClass('bg-secondary bg-success bg-danger bg-warning text-dark').addClass(statusClass);
            $badge.find('i').removeClass().addClass(`fas ${icon}`);
        }
    });
}

// Add activity log entry
function addActivityLog(message, type = 'info') {
    const $log = $('#recent-activity');
    const time = new Date().toLocaleTimeString();
    const colorClass = {
        'success': 'text-success',
        'error': 'text-danger',
        'info': 'text-muted'
    }[type] || 'text-muted';

    $log.prepend(`<div class="${colorClass}">[${time}] ${escapeHtml(message)}</div>`);

    // Keep only last 20 entries
    while ($log.children().length > 20) {
        $log.children().last().remove();
    }
}

// Start polling for snapshot progress
function startSnapshotPolling() {
    if (snapshotPollInterval) clearInterval(snapshotPollInterval);

    snapshotPollInterval = setInterval(function() {
        if (!activeSnapshotId) {
            clearInterval(snapshotPollInterval);
            return;
        }

        $.get(`/api/config-snapshots/${activeSnapshotId}`)
            .done(function(response) {
                if (response.success && response.snapshot) {
                    const s = response.snapshot;
                    updateSnapshotProgressUI(s);

                    // Update the snapshots table row
                    loadSnapshots();

                    // Check if complete
                    if (s.status !== 'in_progress') {
                        clearInterval(snapshotPollInterval);
                        snapshotPollInterval = null;

                        // Show completion message
                        const msg = s.status === 'complete'
                            ? `Snapshot complete! ${s.success_count} devices backed up.`
                            : `Snapshot finished with ${s.failed_count} failures.`;
                        addActivityLog(msg, s.status === 'complete' ? 'success' : 'error');

                        // Hide progress after delay
                        setTimeout(function() {
                            $('#snapshot-progress-card').fadeOut();
                            activeSnapshotId = null;
                            loadBackups();
                            loadSummary();
                        }, 5000);
                    }
                }
            });
    }, 2000);
}

// View snapshot details
function viewSnapshot(snapshotId) {
    // Show loading state
    $('#snapshot-backups-body').html('<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>');
    $('#viewSnapshotModal').modal('show');

    $.get(`/api/config-snapshots/${snapshotId}`)
        .done(function(response) {
            if (response.success && response.snapshot) {
                const s = response.snapshot;

                // Update title and stats
                $('#view-snapshot-title').text(s.name || 'Snapshot Details');
                $('#modal-total-devices').text(s.total_devices || 0);
                $('#modal-success-count').text(s.success_count || 0);
                $('#modal-failed-count').text(s.failed_count || 0);

                // Status badge
                const statusClass = {
                    'complete': 'bg-success',
                    'partial': 'bg-warning text-dark',
                    'failed': 'bg-danger',
                    'in_progress': 'bg-info'
                }[s.status] || 'bg-secondary';
                $('#modal-status-badge').removeClass().addClass(`badge fs-6 ${statusClass}`).text(s.status);

                // Dates
                $('#snapshot-created').text(formatDate(s.created_at));
                $('#snapshot-completed').text(s.completed_at ? formatDate(s.completed_at) : 'In Progress');

                // Store backups for filtering
                currentSnapshotBackups = s.backups || [];
                renderSnapshotBackups(currentSnapshotBackups);
            }
        })
        .fail(function() {
            $('#snapshot-backups-body').html('<tr><td colspan="6" class="text-center text-danger">Error loading snapshot</td></tr>');
        });
}

// Render snapshot backups with filtering
function renderSnapshotBackups(backups) {
    const $tbody = $('#snapshot-backups-body');
    $tbody.empty();

    if (!backups || backups.length === 0) {
        $tbody.html('<tr><td colspan="6" class="text-center text-muted">No backups in this snapshot yet</td></tr>');
        return;
    }

    // Apply filters
    const searchTerm = $('#snapshot-backup-search').val().toLowerCase();
    const statusFilter = $('#snapshot-backup-filter').val();

    let filtered = backups;
    if (searchTerm) {
        filtered = filtered.filter(b =>
            (b.device_name || '').toLowerCase().includes(searchTerm) ||
            (b.device_ip || '').toLowerCase().includes(searchTerm)
        );
    }
    if (statusFilter) {
        filtered = filtered.filter(b => b.status === statusFilter);
    }

    if (filtered.length === 0) {
        $tbody.html('<tr><td colspan="6" class="text-center text-muted">No matching backups</td></tr>');
        return;
    }

    filtered.forEach(function(backup) {
        const statusBadge = backup.status === 'success'
            ? '<span class="badge bg-success">Success</span>'
            : `<span class="badge bg-danger" title="${escapeHtml(backup.error_message || 'Failed')}">Failed</span>`;

        $tbody.append(`
            <tr>
                <td><i class="fas fa-server text-muted"></i> ${escapeHtml(backup.device_name)}</td>
                <td><small class="text-muted">${escapeHtml(backup.device_ip || '-')}</small></td>
                <td><small>${formatDate(backup.created_at)}</small></td>
                <td><small>${formatFileSize(backup.file_size || 0)}</small></td>
                <td>${statusBadge}</td>
                <td>
                    ${backup.status === 'success' ? `
                        <button class="btn btn-sm btn-outline-primary" onclick="viewBackup('${backup.backup_id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `);
    });
}

// Filter handlers for snapshot modal
$('#snapshot-backup-search').on('input', function() {
    renderSnapshotBackups(currentSnapshotBackups);
});
$('#snapshot-backup-filter').on('change', function() {
    renderSnapshotBackups(currentSnapshotBackups);
});

// Delete snapshot
function deleteSnapshot(snapshotId) {
    if (!confirm('Are you sure you want to delete this snapshot and all its backups?')) return;

    $.ajax({
        url: `/api/config-snapshots/${snapshotId}`,
        method: 'DELETE'
    })
    .done(function(response) {
        if (response.success) {
            loadSnapshots();
            loadBackups();
            loadSummary();
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// Refresh snapshots button
$('#refresh-snapshots-btn').click(function() {
    loadSnapshots();
});

// Load schedule
function loadSchedule() {
    $.get('/api/backup-schedule')
        .done(function(response) {
            if (response.success && response.schedule) {
                const s = response.schedule;
                $('#schedule-enabled').prop('checked', s.enabled);
                $('#schedule-interval').val(s.interval_hours || 24);
                $('#schedule-retention').val(s.retention_days || 30);
                $('#schedule-juniper-set').prop('checked', s.juniper_set_format !== false);
                $('#schedule-exclude').val((s.exclude_patterns || []).join('\n'));
                $('#last-run').text(s.last_run ? formatDate(s.last_run) : 'Never');
                $('#next-run').text(s.next_run ? formatDate(s.next_run) : 'Not scheduled');
            }
        });
}

// Track if a device load is already in progress
let devicesLoading = false;

// Load devices from server cache only - does NOT call NetBox
function loadDevicesFromCache() {
    const $select = $('#single-backup-device');

    if (cachedDevices.length > 0) {
        populateDeviceDropdown(cachedDevices);
        return;
    }

    if (devicesLoading) return;

    devicesLoading = true;
    $select.html('<option value="">Loading devices...</option>');

    $.ajax({
        url: '/api/devices/cached',
        method: 'GET',
        timeout: 30000
    })
    .done(function(response) {
        if (response.success && response.devices && response.devices.length > 0) {
            cachedDevices = response.devices;
            populateDeviceDropdown(cachedDevices);
        } else {
            $select.empty();
            $select.append('<option value="">-- Select Device --</option>');
            $select.append('<option value="" disabled>No devices in cache - load devices on Deploy page first</option>');
        }
    })
    .fail(function() {
        $select.empty();
        $select.append('<option value="">Error loading devices</option>');
    })
    .always(function() {
        devicesLoading = false;
    });
}

// Populate device dropdown from cached devices
function populateDeviceDropdown(devices) {
    const $select = $('#single-backup-device');
    $select.empty();
    $select.append('<option value="">-- Select Device --</option>');

    devices.forEach(function(device) {
        const name = device.name || device.display || device.hostname || 'Unknown';
        $select.append(`<option value="${name}">${name}</option>`);
    });
}

// Render backups table
function renderBackupsTable(backups) {
    const $tbody = $('#backups-table-body');
    $tbody.empty();

    if (!backups || backups.length === 0) {
        $tbody.html('<tr><td colspan="6" class="text-center text-muted">No backups found</td></tr>');
        return;
    }

    backups.forEach(function(backup) {
        const statusBadge = backup.status === 'success'
            ? '<span class="badge bg-success">Success</span>'
            : '<span class="badge bg-danger">Failed</span>';

        const formatBadge = backup.config_format === 'set'
            ? '<span class="badge bg-info">Set</span>'
            : '<span class="badge bg-secondary">Native</span>';

        $tbody.append(`
            <tr>
                <td>
                    <i class="fas fa-server text-muted"></i> ${escapeHtml(backup.device_name)}
                    ${backup.device_ip ? `<small class="text-muted d-block">${backup.device_ip}</small>` : ''}
                </td>
                <td><small>${formatDate(backup.created_at)}</small></td>
                <td>${formatBadge}</td>
                <td><small>${formatFileSize(backup.file_size || 0)}</small></td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary view-backup-btn" data-id="${backup.backup_id}">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-backup-btn" data-id="${backup.backup_id}">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });

    // Bind button handlers
    $('.view-backup-btn').click(function() {
        viewBackup($(this).data('id'));
    });

    $('.delete-backup-btn').click(function() {
        deleteBackup($(this).data('id'));
    });
}

// View backup details
function viewBackup(backupId) {
    $.get(`/api/config-backups/${backupId}`)
        .done(function(response) {
            if (response.success && response.backup) {
                const b = response.backup;
                $('#view-backup-title').text(`Config Backup: ${b.device_name}`);
                $('#view-device').text(b.device_name);
                $('#view-format').text(b.config_format || 'native');
                $('#view-size').text(formatFileSize(b.file_size || 0));
                $('#view-time').text(formatDate(b.created_at));
                $('#view-config-content').val(b.config_content || '');

                // Store for download
                $('#viewBackupModal').data('backup', b);
                $('#viewBackupModal').modal('show');
            }
        });
}

// Delete backup
function deleteBackup(backupId) {
    if (!confirm('Are you sure you want to delete this backup?')) return;

    $.ajax({
        url: `/api/config-backups/${backupId}`,
        method: 'DELETE'
    })
    .done(function(response) {
        if (response.success) {
            loadBackups($('#filter-device').val());
            loadSummary();
        } else {
            alert('Error: ' + response.error);
        }
    });
}

// Run all backups (create snapshot)
$('#run-all-backups-btn').click(function() {
    const deviceCount = cachedDevices.length || 'all';
    if (!confirm(`This will create a network snapshot by backing up ${deviceCount} devices. Continue?`)) return;

    const $btn = $(this);
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting...');

    // Clear previous progress
    $('#device-status-grid').empty();
    $('#recent-activity').empty();

    $.ajax({
        url: '/api/config-backups/run-all',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({})
    })
    .done(function(response) {
        if (response.success) {
            activeSnapshotId = response.snapshot_id;

            // Show progress panel
            showSnapshotProgress({
                name: `Snapshot ${new Date().toLocaleString()}`,
                total_devices: response.submitted + response.failed,
                success_count: 0,
                failed_count: response.failed
            });

            // Initialize device grid
            if (response.tasks) {
                response.tasks.forEach(function(task) {
                    $('#device-status-grid').append(`
                        <span class="badge bg-secondary" data-device="${escapeHtml(task.device)}" title="${escapeHtml(task.device)}">
                            <i class="fas fa-circle"></i> ${escapeHtml(task.device.split('.')[0])}
                        </span>
                    `);
                });
            }

            addActivityLog(`Started snapshot with ${response.submitted} devices`, 'info');
            if (response.failed > 0) {
                addActivityLog(`${response.failed} devices failed to start`, 'error');
            }

            // Start polling
            startSnapshotPolling();
            loadSnapshots();
        } else {
            alert('Error: ' + response.error);
        }
    })
    .fail(function() {
        alert('Failed to start snapshot');
    })
    .always(function() {
        $btn.prop('disabled', false).html('<i class="fas fa-camera"></i> Create Network Snapshot');
    });
});

// Single backup modal
$('#run-single-backup-btn').click(function() {
    if (cachedDevices.length > 0) {
        populateDeviceDropdown(cachedDevices);
        $('#singleBackupModal').modal('show');
    } else {
        const $select = $('#single-backup-device');
        $select.html('<option value="">Loading devices...</option>');
        $('#singleBackupModal').modal('show');
        loadDevicesFromCache();
    }
});

$('#start-single-backup-btn').click(function() {
    const deviceName = $('#single-backup-device').val();
    if (!deviceName) {
        alert('Please select a device');
        return;
    }

    const $btn = $(this);
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Starting...');

    $.ajax({
        url: '/api/config-backups/run-single',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ device_name: deviceName })
    })
    .done(function(response) {
        if (response.success) {
            $('#singleBackupModal').modal('hide');
            alert(`Backup started for ${deviceName}. It will appear in the list when complete.`);

            // Poll for this single task
            setTimeout(function() {
                loadBackups();
                loadSummary();
            }, 5000);
        } else {
            alert('Error: ' + response.error);
        }
    })
    .always(function() {
        $btn.prop('disabled', false).html('<i class="fas fa-play"></i> Start Backup');
    });
});

// Save schedule
$('#save-schedule-btn').click(function() {
    const excludeText = $('#schedule-exclude').val().trim();
    const excludePatterns = excludeText ? excludeText.split('\n').filter(p => p.trim()) : [];

    const scheduleData = {
        enabled: $('#schedule-enabled').is(':checked'),
        interval_hours: parseInt($('#schedule-interval').val()) || 24,
        retention_days: parseInt($('#schedule-retention').val()) || 30,
        juniper_set_format: $('#schedule-juniper-set').is(':checked'),
        exclude_patterns: excludePatterns
    };

    $.ajax({
        url: '/api/backup-schedule',
        method: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(scheduleData)
    })
    .done(function(response) {
        if (response.success) {
            alert('Schedule saved successfully');
            loadSchedule();
        } else {
            alert('Error: ' + response.error);
        }
    });
});

// Cleanup old backups
$('#cleanup-backups-btn').click(function() {
    const retentionDays = parseInt($('#schedule-retention').val()) || 30;
    if (!confirm(`Delete all backups older than ${retentionDays} days?`)) return;

    $.ajax({
        url: '/api/config-backups/cleanup',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ retention_days: retentionDays })
    })
    .done(function(response) {
        if (response.success) {
            alert(`Deleted ${response.deleted_count} old backups`);
            loadBackups();
            loadSummary();
        } else {
            alert('Error: ' + response.error);
        }
    });
});

// Refresh and filter
$('#refresh-backups-btn').click(function() {
    loadBackups($('#filter-device').val());
    loadSummary();
});

$('#filter-device').change(function() {
    currentPage = 0;
    loadBackups($(this).val());
});

// Pagination
$('#prev-page').click(function(e) {
    e.preventDefault();
    if (currentPage > 0) {
        currentPage--;
        loadBackups($('#filter-device').val());
    }
});

$('#next-page').click(function(e) {
    e.preventDefault();
    currentPage++;
    loadBackups($('#filter-device').val());
});

function updatePagination(count) {
    $('#prev-page').toggleClass('disabled', currentPage === 0);
    $('#next-page').toggleClass('disabled', count < pageSize);
}

// Copy and download handlers
$('#copy-config-btn').click(function() {
    const content = $('#view-config-content').val();
    navigator.clipboard.writeText(content).then(function() {
        alert('Copied to clipboard!');
    });
});

$('#download-config-btn').click(function() {
    const backup = $('#viewBackupModal').data('backup');
    if (!backup) return;

    const blob = new Blob([backup.config_content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${backup.device_name}_${backup.created_at.replace(/[: ]/g, '_')}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
});

// Utility functions
function formatDate(dateStr) {
    if (!dateStr) return 'N/A';
    const d = new Date(dateStr);
    return d.toLocaleString();
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
